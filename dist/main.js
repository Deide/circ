!function(){"use strict";function e(e,t){return t={exports:{}},e(t,t.exports,se),t.exports}function t(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};return String(e).replace(/[&<>"\']/g,function(e){var n;return null!=(n=t[e])?n:e})}function n(e){return e.replace(/\u0003\d{1,2}(,\d{1,2})?/g,"").replace(/[\x0F\x02\x1F\x1D]/g,"")}function r(e){var t=["rgb(255, 255, 255)","rgb(0, 0, 0)","rgb(0, 0, 128)","rgb(0, 128, 0)","rgb(255, 0, 0)","rgb(128, 0, 64)","rgb(128, 0, 128)","rgb(255, 128, 64)","rgb(255, 255, 0)","rgb(128, 255, 0)","rgb(0, 128, 128)","rgb(0, 255, 255)","rgb(0, 0, 255)","rgb(255, 0, 255)","rgb(128, 128, 128)","rgb(192, 192, 192)"],n=null,r=null,i=!1,o=!1,s=!1,a=e.replace(/(\x0F|\x02|\x1F|\x1D|\u0003(\d{0,2})(?:,(\d{1,2}))?)([^\x0F\x02\x1F\x1D\u0003]*)/g,function(e,a,c,u,h){return""==a?(n=null,r=null,i=!1,o=!1,s=!1):""==a?i=!i:""==a?s=!s:""==a?o=!o:(c&&(n=t[parseInt(c)]),u&&(r=t[parseInt(u)])),h?"<font style='"+(n?"color: "+n+";":"")+(r?"background-color: "+r+";":"")+(i?"font-weight: bold;":"")+(s?"text-decoration: underline;":"")+(o?"font-style: italic;":"")+"'>"+h+"</font>":""});return a}function i(e,i,o){var s,a,c,u,h=t;s=function(e){return e=n(e),e=h(e),e.match(/^[a-z][\w-]+:/i)?e:"http://"+e},a=function(e){if(i)return e;var t=(e.match(/\S{40,}/g)||[]).map(function(e){return h(e)});return e=h(e),t.reduce(function(t,n){var r=void 0,i=void 0;return r='<span class="longword">'+n+"</span>",e=e.replace(n,r),i=e.indexOf(r)+r.length,t+=e.slice(0,+(i-1)+1||9e9),e=e.slice(i),t},"")+e},c="",u=0;for(var l=o.exec(e);l;l=o.exec(e))c+=a(e.substr(u,l.index-u)),c+='<a target="_blank" href="'+s(l[0])+'">'+t(l[0])+"</a>",u=l.index+l[0].length;return c+=a(e.substr(u)),c=r(c)}function o(e){return function(t,n){return i(t,n,e)}}function s(e){switch(e){case"w":return function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];t.length<1||(le?console.warn.apply(console,t):d("warn",t))};case"e":return function(){var e;arguments.length<1||(e=console).error.apply(e,arguments)};default:return function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];n.length<1||(le?(e=console).log.apply(e,n):d("log",n))}}}function a(e,t){return t.reduce(function(e,t){return void 0===e||null===e?null:e[t]},e)}function c(e){if(!e)throw new Error("assertion failed")}function u(e){return function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];var i,o=n[0],a=2<=n.length?n.slice(1):[];return"l"===o||"w"===o||"e"===o?i=o:a=[o].concat(a),s(i).apply(null,[e.constructor.name+":"].concat(ae.toConsumableArray(a)))}}function h(){le=!0,de.forEach(function(e){return console[e.type].apply(console,e.msg)}),console.log("---------------------------------------------------"),console.log("DEBUG: printed the last "+de.length+" logs."),console.log("---------------------------------------------------")}function l(e,t){return e&&1!==t?"s"===e[e.length-1]?e+"es":e+"s":e}function d(e,t){de.push({type:e,msg:t}),de.length>pe&&(de=de.slice(100))}function p(e,t){var n=new XMLHttpRequest;return n.open("GET",e),n.responseType="blob",n.onload=function(){return t(window.URL.createObjectURL(this.response))},n.onerror=function(){for(var t,n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];return(t=console).error.apply(t,["Failed to get embedable url for asset:",e].concat(r))},n.send()}function f(e){return 1===e.size()?e.first().toString():e.initial().join(", ")+" and "+e.last()}function v(e){var t=new Date;return t.setTime(e),t.toString()}function m(){return window.navigator.onLine}function y(e,t){var n=e.indexOf(t);return 0>n?!1:e.splice(n,1)}function _(e,t,n){return null==n&&(n="..."),e.length>t?e.slice(0,+(t-n.length-1)+1||9e9)+n:e}function g(e){return e?e[0].toUpperCase()+e.slice(1):e}function k(e){return e?/\S/.test(e):!1}function C(e){return chrome.fileSystem.chooseFile({type:"openFile"},function(t){return t?t.file(function(t){var n;return n=new FileReader,n.onload=function(t){return e(t.target.result)},n.onerror=function(e){return console.error("Read failed:",e)},n.readAsText(t)}):void 0})}function w(e,t){window.chrome&&chrome.runtime&&chrome.runtime.getBackgroundPage(function(n){n&&n.registerSocketId&&n.unregisterSocketId&&(t?n.unregisterSocketId(e):n.registerSocketId(e))})}function S(e,t){window.chrome&&chrome.runtime&&chrome.runtime.getBackgroundPage(function(n){n&&n.registerTcpServer&&n.unregisterTcpServer&&(t?n.unregisterTcpServer(e):n.registerTcpServer(e))})}function I(e){var t=window.BlobBuilder||window.WebKitBlobBuilder;if(t){var n=new t;return n.append(e),n.getBlob()}return new Blob([e])}function b(e,t){var n=new ArrayBuffer(e.byteLength+t.byteLength),r=new Uint8Array(n);return r.set(new Uint8Array(e)),r.set(new Uint8Array(t),e.byteLength),n}function T(e,t){var n=I(e),r=new FileReader;return Ce++,r.onload=function(e){return Ce--,t(e.target.result)},r.readAsArrayBuffer(n)}function E(e,t){var n=I(e),r=new FileReader;return Ce++,r.onload=function(e){return Ce--,t(e.target.result)},r.readAsText(n)}function N(e){for(var t=0,n=0,r=e.length;r>n;n++)t=31*t+e.charCodeAt(n)<<0;return Math.abs(t)}function M(e){var t=/^([^!]+?)(?:!(.+?)(?:@(.+?))?)?$/.exec(e);return{nick:t[1],user:t[2],host:t[3]}}function A(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return e+" "+Se(n)+"\r\n"}function x(e){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";return null==e&&(e=10),Array(e).fill().map(function(){return t[Math.floor(Math.random()*t.length)]}).join("")}function O(e){return e.toLowerCase().replace(/[\[\]\\]/g,function(e){return{"[":"{","]":"}","|":"\\"}[e]})}function R(e,t){var n;return("undefined"==typeof e?"undefined":ae["typeof"](e))!==(n="undefined"==typeof t?"undefined":ae["typeof"](t))||"string"!==n?!1:null!=e&&null!=t&&O(e)===O(t)}function D(e,t){return T(e,function(e){return t(e)})}function W(e,t){return E(e,t)}function F(){return new ArrayBuffer(0)}function P(e,t){return b(e,t)}function L(){return Ce>0}function U(e){var t=new ArrayBuffer(e.length),n=new Uint8Array(t);return n.set(e),t}function H(){return chrome.sockets&&chrome.sockets.tcpServer}function j(){return chrome.sockets&&chrome.sockets.tcp}function q(){return chrome.system&&chrome.system.network}function B(e){console.error("[Error]",e)}function V(e){return e>="0"&&"9">=e}function K(e){return z(G(Y(e)))}function G(e){return X(Q(J(e),8*e.length))}function z(e){try{}catch(t){ft=0}for(var n,r=ft?"0123456789ABCDEF":"0123456789abcdef",i="",o=0;o<e.length;o++)n=e.charCodeAt(o),i+=r.charAt(n>>>4&15)+r.charAt(15&n);return i}function Y(e){for(var t,n,r="",i=-1;++i<e.length;)t=e.charCodeAt(i),n=i+1<e.length?e.charCodeAt(i+1):0,t>=55296&&56319>=t&&n>=56320&&57343>=n&&(t=65536+((1023&t)<<10)+(1023&n),i++),127>=t?r+=String.fromCharCode(t):2047>=t?r+=String.fromCharCode(192|t>>>6&31,128|63&t):65535>=t?r+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):2097151>=t&&(r+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return r}function J(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(var r=0;r<8*e.length;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}function X(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function Q(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;for(var n=1732584193,r=-271733879,i=-1732584194,o=271733878,s=0;s<e.length;s+=16){var a=n,c=r,u=i,h=o;n=ee(n,r,i,o,e[s+0],7,-680876936),o=ee(o,n,r,i,e[s+1],12,-389564586),i=ee(i,o,n,r,e[s+2],17,606105819),r=ee(r,i,o,n,e[s+3],22,-1044525330),n=ee(n,r,i,o,e[s+4],7,-176418897),o=ee(o,n,r,i,e[s+5],12,1200080426),i=ee(i,o,n,r,e[s+6],17,-1473231341),r=ee(r,i,o,n,e[s+7],22,-45705983),n=ee(n,r,i,o,e[s+8],7,1770035416),o=ee(o,n,r,i,e[s+9],12,-1958414417),i=ee(i,o,n,r,e[s+10],17,-42063),r=ee(r,i,o,n,e[s+11],22,-1990404162),n=ee(n,r,i,o,e[s+12],7,1804603682),o=ee(o,n,r,i,e[s+13],12,-40341101),i=ee(i,o,n,r,e[s+14],17,-1502002290),r=ee(r,i,o,n,e[s+15],22,1236535329),n=te(n,r,i,o,e[s+1],5,-165796510),o=te(o,n,r,i,e[s+6],9,-1069501632),i=te(i,o,n,r,e[s+11],14,643717713),r=te(r,i,o,n,e[s+0],20,-373897302),n=te(n,r,i,o,e[s+5],5,-701558691),o=te(o,n,r,i,e[s+10],9,38016083),i=te(i,o,n,r,e[s+15],14,-660478335),r=te(r,i,o,n,e[s+4],20,-405537848),n=te(n,r,i,o,e[s+9],5,568446438),o=te(o,n,r,i,e[s+14],9,-1019803690),i=te(i,o,n,r,e[s+3],14,-187363961),r=te(r,i,o,n,e[s+8],20,1163531501),n=te(n,r,i,o,e[s+13],5,-1444681467),o=te(o,n,r,i,e[s+2],9,-51403784),i=te(i,o,n,r,e[s+7],14,1735328473),r=te(r,i,o,n,e[s+12],20,-1926607734),n=ne(n,r,i,o,e[s+5],4,-378558),o=ne(o,n,r,i,e[s+8],11,-2022574463),i=ne(i,o,n,r,e[s+11],16,1839030562),r=ne(r,i,o,n,e[s+14],23,-35309556),n=ne(n,r,i,o,e[s+1],4,-1530992060),o=ne(o,n,r,i,e[s+4],11,1272893353),i=ne(i,o,n,r,e[s+7],16,-155497632),r=ne(r,i,o,n,e[s+10],23,-1094730640),n=ne(n,r,i,o,e[s+13],4,681279174),o=ne(o,n,r,i,e[s+0],11,-358537222),i=ne(i,o,n,r,e[s+3],16,-722521979),r=ne(r,i,o,n,e[s+6],23,76029189),n=ne(n,r,i,o,e[s+9],4,-640364487),o=ne(o,n,r,i,e[s+12],11,-421815835),i=ne(i,o,n,r,e[s+15],16,530742520),r=ne(r,i,o,n,e[s+2],23,-995338651),n=re(n,r,i,o,e[s+0],6,-198630844),o=re(o,n,r,i,e[s+7],10,1126891415),i=re(i,o,n,r,e[s+14],15,-1416354905),r=re(r,i,o,n,e[s+5],21,-57434055),n=re(n,r,i,o,e[s+12],6,1700485571),o=re(o,n,r,i,e[s+3],10,-1894986606),i=re(i,o,n,r,e[s+10],15,-1051523),r=re(r,i,o,n,e[s+1],21,-2054922799),n=re(n,r,i,o,e[s+8],6,1873313359),o=re(o,n,r,i,e[s+15],10,-30611744),i=re(i,o,n,r,e[s+6],15,-1560198380),r=re(r,i,o,n,e[s+13],21,1309151649),n=re(n,r,i,o,e[s+4],6,-145523070),o=re(o,n,r,i,e[s+11],10,-1120210379),i=re(i,o,n,r,e[s+2],15,718787259),r=re(r,i,o,n,e[s+9],21,-343485551),n=ie(n,a),r=ie(r,c),i=ie(i,u),o=ie(o,h)}return Array(n,r,i,o)}function Z(e,t,n,r,i,o){return ie(oe(ie(ie(t,e),ie(r,o)),i),n)}function ee(e,t,n,r,i,o,s){return Z(t&n|~t&r,e,t,i,o,s)}function te(e,t,n,r,i,o,s){return Z(t&r|n&~r,e,t,i,o,s)}function ne(e,t,n,r,i,o,s){return Z(t^n^r,e,t,i,o,s)}function re(e,t,n,r,i,o,s){return Z(n^(t|~r),e,t,i,o,s)}function ie(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function oe(e,t){return e<<t|e>>>32-t}var se="undefined"!=typeof window?window:"undefined"!=typeof global?global:this,ae={};ae["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},ae.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},ae.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),ae.get=function bt(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:bt(i,t,n)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(n)},ae.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},ae.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},ae.slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(c){i=!0,o=c}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ae.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};var ce=o(/\b(?:(?:https?|ftp|file):\/\/|www\.|ftp\.)(?:\([-A-Z0-9+&@#\/%=~_|$?!:,.]*\)|[-A-Z0-9+&@#\/%=~_|$?!:,.])*(?:\([-A-Z0-9+&@#\/%=~_|$?!:,.]*\)|[A-Z0-9+&@#\/%=~_|$])/gi),ue=Object.freeze({escape:t,stripColorCodes:n,parseColorCodes:r,_display:i,display:ce}),he=ue,le=!1,de=[],pe=400,fe=function(){function e(){ae.classCallCheck(this,e),this._log=u(this),this._listeners={},this._anyEventListeners=[]}return ae.createClass(e,[{key:"onAny",value:function(e){return this._anyEventListeners.push(e)}},{key:"on",value:function(e,t){var n,r;return(null!=(r=(n=this._listeners)[e])?r:n[e]=[]).push(t)}},{key:"emit",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=this._anyEventListeners,o=this._listeners[e]||[];return o.forEach(function(e){return e.apply(null,n)}),i.map(function(t){return t.apply(null,[e].concat(n))})}},{key:"once",value:function(e,t){var n=this,r=function i(){for(var r=arguments.length,o=Array(r),s=0;r>s;s++)o[s]=arguments[s];return n.removeListener(e,i),t.apply.apply(t,[null].concat(o))};return this.on(e,r),r.listener=t}},{key:"removeListener",value:function(e,t){return this._listeners&&this._listeners[e]&&null!=t?(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}),this._listeners[e]):void 0}}]),e}(),ve=e(function(e,t,n){!function(n,r){"function"==typeof define&&define.amd?define(r):"object"==typeof t?e.exports=r():n.Lazy=r()}(se,function(e){function t(e){if(e instanceof Array)return new V(e);if("string"==typeof e)return new _e(e);if(e instanceof n)return e;if(t.extensions){for(var r,i=t.extensions,o=i.length;!r&&o--;)r=i[o](e);if(r)return r}return new ae(e)}function n(){}function r(e){this.sequence=e,this.index=-1}function i(e){this.parent=e}function o(e,t){this.parent=e,this.mapFn=t}function s(e,t){this.iterator=e.getIterator(),this.mapFn=t,this.index=-1}function a(e,t){this.parent=e,this.filterFn=t}function c(e,t){this.iterator=e.getIterator(),this.filterFn=t,this.index=0}function u(e){this.parent=e}function h(e){this.sequence=e}function l(e,t){this.parent=e,this.arrays=t}function d(e,t){this.parent=e,this.count=t}function p(e,t){this.iterator=e.getIterator(),this.count=t}function f(e,t){this.parent=e,this.predicate=t}function v(e,t){this.parent=e,this.count="number"==typeof t?t:1}function m(e,t){this.parent=e,this.count="number"==typeof t?t:1}function y(e,t){this.parent=e,this.predicate=t}function _(e,t){this.parent=e,this.sortFn=t}function g(e,t,n){this.parent=e,this.keyFn=t,this.valFn=n}function k(e,t,n){this.parent=e,this.keyFn=t,this.valFn=n}function C(e,t){this.parent=e,this.keyFn=t}function w(e,t){this.parent=e,this.keyFn=t}function S(e,t){this.parent=e,this.arrays=t}function I(e){this.parent=e}function b(e){this.parent=e}function T(e,t){this.parent=e,this.values=t}function E(e,t){this.parent=e,this.arrays=t}function N(e){this.iterator=e,this.set=new qe,this.memo=[],this.currentValue=void 0}function M(e,t){this.parent=e,this.chunkSize=t}function A(e,t){this.iterator=e.getIterator(),this.size=t}function x(e,t){this.parent=e,this.callback=t}function O(e,t){this.parent=e,this.array=t,this.each=R(t)}function R(e){return e.length<40?O.prototype.eachArrayCache:O.prototype.eachMemoizerCache}function D(e,t){this.parent=e,this.array=t}function W(){}function F(e){this.sequence=e,this.index=-1}function P(e,t){this.parent=e,this.mapFn=t}function L(e,t){this.parent=e,this.filterFn=t}function U(e){this.parent=e}function H(e,t){this.parent=e,this.count=t}function j(e,t){this.parent=e,this.count="number"==typeof t?t:1}function $(e,t){this.parent=e,this.other=t}function q(e,t){this.parent=e,this.each=B(e),this.keyFn=t}function B(e){return e.length()<100?q.prototype.eachArrayCache:w.prototype.each}function V(e){this.source=e}function K(e,t){this.parent=e,this.mapFn=t}function G(e,t){this.parent=e,this.filterFn=t}function z(e,t){this.parent=e,this.each=Y(e.source),this.keyFn=t}function Y(e){return e.length<40?z.prototype.eachNoCache:e.length<100?z.prototype.eachArrayCache:z.prototype.eachSetCache}function J(e,t){this.parent=e,this.other=t}function X(){}function Q(e,t){this.parent=e,this.filterFn=t}function Z(e,t){this.parent=e,this.other=t}function ee(e,t){this.parent=e,this.defaults=t}function te(e){this.parent=e}function ne(e,t,n){this.parent=e,this.others=t,this.mergeFn=n}function re(e,t){var n,r;if("undefined"==typeof t)return e;if(ie(e)&&ie(t))n={};else{if(!(e instanceof Array&&t instanceof Array))return t;n=[]}for(r in e)n[r]=re(e[r],t[r]);for(r in t)n[r]||(n[r]=t[r]);return n}function ie(e){return e&&e.constructor===Object}function oe(e,t){this.parent=e,this.properties=t}function se(e,t){this.parent=e,this.properties=t}function ae(e){this.source=e}function ce(){}function ue(e){this.source=t(e),this.index=-1}function he(e,t,n){this.parent=e,this.start=Math.max(0,t),this.stop=n}function le(e,t){this.parent=e,this.mapFn=t}function de(e){this.parent=e}function pe(e,t){this.parent=e,this.pattern=t}function fe(e,t){this.source=e,this.pattern=$e(t)}function ve(e,t){this.parent=e,this.pattern=t}function me(e,t){this.source=e,this.pattern=$e(t)}function ye(e,t){this.source=e,this.delimiter=t}function _e(e){this.source=e}function ge(e,t){this.get=e,this.fixedLength=t}function ke(e){this.sequence=e,this.index=0,this.currentValue=null}function Ce(e,t){if(e instanceof Ce)throw new Error("Sequence is already asynchronous!");this.parent=e,this.interval=t,this.onNextCallback=be(t),this.cancelCallback=Te(t)}function we(e){this.resolveListeners=[],this.rejectListeners=[],this.state=Ke,this.cancelFn=e}function Se(e,t){if(e===t)return void e._reject(new TypeError("Cannot resolve a promise to itself"));if(t instanceof we)return void t.then(function(t){Se(e,t)},function(t){e._reject(t)});var n;try{n=/function|object/.test(typeof t)&&null!=t&&t.then}catch(r){return void e._reject(r)}var i=Ke;if("function"!=typeof n)e._resolve(t);else try{n.call(t,function(t){i===Ke&&(i=Ge,Se(e,t))},function(t){i===Ke&&(i=ze,e._reject(t))})}catch(r){if(i!==Ke)return;e._reject(r)}}function Ie(e,t,n){n||(n=be()),n(function(){e.length>0&&(e.shift()(t),Ie(e,t,n))})}function be(e){return"undefined"==typeof e&&"function"==typeof setImmediate?setImmediate:(e=e||0,function(t){return setTimeout(t,e)})}function Te(e){return"undefined"==typeof e&&"function"==typeof clearImmediate?clearImmediate:clearTimeout}function Ee(e,t){return t instanceof we?t.then(function(){e(t)}):e(t)}function Ne(e,n){this.listeners=[],n?n instanceof Array||(n=[n]):n=t(e).keys().toArray();var r=this.listeners,i=0;t(n).each(function(t){var n=e[t];Object.defineProperty(e,t,{get:function(){return n},set:function(e){for(var o=r.length-1;o>=0;--o)r[o]({property:t,value:e},i)===!1&&r.splice(o,1);n=e,++i}})})}function Me(){}function Ae(e,t){this.parent=e,this.delimiter=t,this.each=this.getEachForDelimiter(t)}function xe(e,t){this.parent=e,this.pattern=$e(t)}function Oe(e,n){switch(typeof e){case"function":return e;case"string":return function(t){return t[e]};case"object":return function(n){return t(e).all(function(e,t){return n[t]===e})};case"undefined":return n?function(){return n}:t.identity;default:throw new Error("Don't know how to make a callback from a "+typeof e+"!")}}function Re(e,t){return e?(e=Oe(e),function(t,n){return Fe(e(t),e(n))}):Fe}function De(e){return function(t,n){return e(n,t)}}function We(e){var n=new qe;return t(e||[]).flatten().each(function(e){n.add(e)}),n}function Fe(e,t){return e===t?0:e>t?1:-1}function Pe(e,t){for(var n=-1,r=e.length;++n<r;)if(t(e[n],n)===!1)return!1;return!0}function Le(e){var t;return e.each(function(e){return t=e,!1}),t}function Ue(e,t){var n=-1,r=e.length;if(t!==t){for(;++n<r;)if(e[n]!==e[n])return!0;return!1}for(;++n<r;)if(e[n]===t)return!0;return!1}function He(e,t,n,r){var i=-1;if(r){for(r=Oe(r);++i<n;)if(r(e[i])===r(t))return!0}else for(;++i<n;)if(e[i]===t)return!0;return!1}function je(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function $e(e){var t,n,r,i;if(e instanceof RegExp){if(e.global)return e;t=e.toString()}else t=e;return n=t.lastIndexOf("/"),r=t.substring(n+1),i=r.indexOf("g")>=0?"":"g",new RegExp(t.substring(1,n),r+i)}function qe(){this.table={},this.objects=[]}function Be(e){this.contents=new Array(e),this.start=0,this.count=0}function Ve(e,t,n){var r=function(){};r.prototype=new e;for(var i in n)r.prototype[i]=n[i];for(var o=function(){var e=new r;return e.parent=this,e.init&&e.init.apply(e,arguments),e},s="string"==typeof t?[t]:t,a=0;a<s.length;++a)e.prototype[s[a]]=o;return r}t.VERSION="0.4.2",t.noop=function(){},t.identity=function(e){return e},t.strict=function(){function e(e){if(null==e)throw new Error("You cannot wrap null or undefined using Lazy.");if("number"==typeof e||"boolean"==typeof e)throw new Error("You cannot wrap primitive values using Lazy.");return t(e)}return t(t).each(function(t,n){e[n]=t}),e},n.define=function(e,t){if(!t||!t.getIterator&&!t.each)throw new Error("A custom sequence must implement *at least* getIterator or each!");return Ve(n,e,t)},n.prototype.size=function(){return this.getIndex().length()},n.prototype.getIterator=function(){return new r(this)},n.prototype.root=function(){return this.parent.root()},n.prototype.isAsync=function(){return this.parent?this.parent.isAsync():!1},n.prototype.value=function(){return this.toArray()},n.prototype.apply=function(e){var t,n=this.root(),r=n.source;try{n.source=e,t=this.value()}finally{n.source=r}return t},r.prototype.current=function(){return this.cachedIndex&&this.cachedIndex.get(this.index)},r.prototype.moveNext=function(){var e=this.cachedIndex;return e||(e=this.cachedIndex=this.sequence.getIndex()),this.index>=e.length()-1?!1:(++this.index,!0)},n.prototype.toArray=function(){return this.reduce(function(e,t){return e.push(t),e},[])},n.prototype.getIndex=function(){return new V(this.toArray())},n.prototype.get=function(e){var t;return this.each(function(n,r){return r===e?(t=n,!1):void 0}),t},n.prototype.memoize=function(){return new i(this)},n.prototype.toObject=function(){return this.reduce(function(e,t){return e[t[0]]=t[1],e},{})},n.prototype.each=function(e){for(var t=this.getIterator(),n=-1;t.moveNext();)if(e(t.current(),++n)===!1)return!1;return!0},n.prototype.forEach=function(e){return this.each(e)},n.prototype.map=function(e){return new o(this,Oe(e))},n.prototype.collect=function(e){return this.map(e)},o.prototype=new n,o.prototype.getIterator=function(){return new s(this.parent,this.mapFn)},o.prototype.each=function(e){var t=this.mapFn;return this.parent.each(function(n,r){return e(t(n,r),r)})},s.prototype.current=function(){return this.mapFn(this.iterator.current(),this.index)},s.prototype.moveNext=function(){return this.iterator.moveNext()?(++this.index,!0):!1},n.prototype.pluck=function(e){return this.map(e)},n.prototype.invoke=function(e){return this.map(function(t){return t[e]()})},n.prototype.filter=function(e){return new a(this,Oe(e))},n.prototype.select=function(e){return this.filter(e)},a.prototype=new n,a.prototype.getIterator=function(){return new c(this.parent,this.filterFn)},a.prototype.each=function(e){var t=this.filterFn,n=0;return this.parent.each(function(r,i){return t(r,i)?e(r,n++):void 0})},a.prototype.reverse=function(){return this.parent.reverse().filter(this.filterFn)},c.prototype.current=function(){return this.value},c.prototype.moveNext=function(){for(var e,t=this.iterator,n=this.filterFn;t.moveNext();)if(e=t.current(),n(e,this.index++))return this.value=e,!0;return this.value=void 0,!1},n.prototype.reject=function(e){return e=Oe(e),this.filter(function(t){return!e(t)})},n.prototype.ofType=function(e){return this.filter(function(t){return typeof t===e})},n.prototype.where=function(e){return this.filter(e)},n.prototype.reverse=function(){return new u(this)},u.prototype=new n,u.prototype.getIterator=function(){return new h(this.parent)},h.prototype.current=function(){return this.getIndex().get(this.index)},h.prototype.moveNext=function(){var e=this.getIndex(),t=e.length();return"undefined"==typeof this.index&&(this.index=t),--this.index>=0},h.prototype.getIndex=function(){return this.cachedIndex||(this.cachedIndex=this.sequence.getIndex()),this.cachedIndex},n.prototype.concat=function(e){return new l(this,Je.call(arguments,0))},l.prototype=new n,l.prototype.each=function(e){var n=!1,r=0;this.parent.each(function(t){return e(t,r++)===!1?(n=!0,!1):void 0}),n||t(this.arrays).flatten().each(function(t){return e(t,r++)===!1?!1:void 0})},n.prototype.first=function(e){return"undefined"==typeof e?Le(this):new d(this,e)},n.prototype.head=n.prototype.take=function(e){return this.first(e)},d.prototype=new n,d.prototype.getIterator=function(){return new p(this.parent,this.count)},d.prototype.each=function(e){var t,n=this.count,r=0,i=this.parent.each(function(i){return n>r&&(t=e(i,r++)),r>=n?!1:t});return i instanceof we?i:r===n&&t!==!1},p.prototype.current=function(){return this.iterator.current()},p.prototype.moveNext=function(){return--this.count>=0&&this.iterator.moveNext()},n.prototype.takeWhile=function(e){return new f(this,e)},f.prototype=new n,f.prototype.each=function(e){var t=this.predicate,n=!1,r=0,i=this.parent.each(function(i,o){return t(i,o)?e(i,r++):(n=!0,!1)});return i instanceof we?i:n},n.prototype.initial=function(e){return new v(this,e)},v.prototype=new n,v.prototype.each=function(e){var t=this.parent.getIndex();return t.take(t.length()-this.count).each(e)},n.prototype.last=function(e){return"undefined"==typeof e?this.reverse().first():this.reverse().take(e).reverse()},n.prototype.findWhere=function(e){return this.where(e).first()},n.prototype.rest=function(e){return new m(this,e)},n.prototype.skip=n.prototype.tail=n.prototype.drop=function(e){return this.rest(e)},m.prototype=new n,m.prototype.each=function(e){var t=this.count,n=0,r=0;return this.parent.each(function(i){return n++<t?void 0:e(i,r++)})},n.prototype.dropWhile=function(e){return new y(this,e)},n.prototype.skipWhile=function(e){return this.dropWhile(e)},y.prototype=new n,y.prototype.each=function(e){var t=this.predicate,n=!1;return this.parent.each(function(r){if(!n){if(t(r))return;n=!0}return e(r)})},n.prototype.sort=function(e,t){return e||(e=Fe),t&&(e=De(e)),new _(this,e)},n.prototype.sortBy=function(e,t){return e=Re(e),t&&(e=De(e)),new _(this,e)},_.prototype=new n,_.prototype.each=function(e){var t=this.sortFn,n=this.parent.toArray();return n.sort(t),Pe(n,e)},_.prototype.reverse=function(){return new _(this.parent,De(this.sortFn))},n.prototype.groupBy=function(e,t){return new g(this,e,t)},n.prototype.indexBy=function(e,t){return new k(this,e,t)},n.prototype.countBy=function(e){return new C(this,e)},n.prototype.uniq=function(e){return new w(this,e)},n.prototype.unique=function(e){return this.uniq(e)},w.prototype=new n,w.prototype.each=function(e){var t=new qe,n=this.keyFn,r=0;return n?(n=Oe(n),this.parent.each(function(i){return t.add(n(i))?e(i,r++):void 0})):this.parent.each(function(n){return t.add(n)?e(n,r++):void 0})},n.prototype.zip=function(e){return 1===arguments.length?new D(this,e):new S(this,Je.call(arguments,0))},S.prototype=new n,S.prototype.each=function(e){var t=this.arrays,n=0;this.parent.each(function(r){for(var i=[r],o=0;o<t.length;++o)t[o].length>n&&i.push(t[o][n]);return e(i,n++)})},n.prototype.shuffle=function(){return new I(this)},I.prototype=new n,I.prototype.each=function(e){for(var t=this.parent.toArray(),n=Math.floor,r=Math.random,i=0,o=t.length-1;o>0;--o)if(je(t,o,n(r()*(o+1))),e(t[o],i++)===!1)return;e(t[0],i)},n.prototype.flatten=function(){return new b(this)},b.prototype=new n,b.prototype.each=function(e){var t=0;return this.parent.each(function r(i){return i instanceof Array?Pe(i,r):i instanceof n?i.each(r):e(i,t++)})},n.prototype.compact=function(){return this.filter(function(e){return!!e})},n.prototype.without=function(e){return new T(this,Je.call(arguments,0))},n.prototype.difference=function(e){return this.without.apply(this,arguments)},T.prototype=new n,T.prototype.each=function(e){var t=We(this.values),n=0;return this.parent.each(function(r){return t.contains(r)?void 0:e(r,n++)})},n.prototype.union=function(e){return this.concat(e).uniq()},n.prototype.intersection=function(e){return 1===arguments.length&&arguments[0]instanceof Array?new O(this,e):new E(this,Je.call(arguments,0))},E.prototype=new n,E.prototype.each=function(e){var n=t(this.arrays).map(function(e){return new N(t(e).getIterator())}),r=new N(n.getIterator()),i=0;return this.parent.each(function(t){var n=!0;return r.each(function(e){return e.contains(t)?void 0:(n=!1,!1)}),n?e(t,i++):void 0})},N.prototype.current=function(){return this.currentValue},N.prototype.moveNext=function(){for(var e,t=this.iterator,n=this.set,r=this.memo;t.moveNext();)if(e=t.current(),n.add(e))return r.push(e),this.currentValue=e,!0;return!1},N.prototype.each=function(e){for(var t=this.memo,n=t.length,r=-1;++r<n;)if(e(t[r],r)===!1)return!1;for(;this.moveNext()&&e(this.currentValue,r++)!==!1;);},N.prototype.contains=function(e){if(this.set.contains(e))return!0;for(;this.moveNext();)if(this.currentValue===e)return!0;return!1},n.prototype.every=function(e){return e=Oe(e),this.each(function(t,n){return!!e(t,n)})},n.prototype.all=function(e){return this.every(e)},n.prototype.some=function(e){e=Oe(e,!0);var t=!1;return this.each(function(n){return e(n)?(t=!0,!1):void 0}),t},n.prototype.any=function(e){return this.some(e)},n.prototype.none=function(e){return!this.any(e)},n.prototype.isEmpty=function(){return!this.any()},n.prototype.indexOf=function(e){var t=-1;return this.each(function(n,r){return n===e?(t=r,!1):void 0}),t},n.prototype.lastIndexOf=function(e){var t=this.getIndex().reverse(),n=t.indexOf(e);return-1!==n&&(n=t.length()-n-1),n},n.prototype.sortedIndex=function(e){for(var t,n=this.getIndex(),r=0,i=n.length();i>r;)t=r+i>>>1,-1===Fe(n.get(t),e)?r=t+1:i=t;return r},n.prototype.contains=function(e){return-1!==this.indexOf(e)},n.prototype.reduce=function(e,t){if(arguments.length<2)return this.tail().reduce(e,this.head());var n=this.each(function(n,r){t=e(t,n,r)});return n instanceof we?n.then(function(){return t}):t},n.prototype.inject=n.prototype.foldl=function(e,t){return this.reduce(e,t)},n.prototype.reduceRight=function(e,t){if(arguments.length<2)return this.initial(1).reduceRight(e,this.last());var n=this.getIndex(),r=n.length()-1;return n.reverse().reduce(function(t,n){return e(t,n,r--)},t)},n.prototype.foldr=function(e,t){return this.reduceRight(e,t)},n.prototype.consecutive=function(e){var t=new Be(e),n=this.map(function(n){return t.add(n).count===e?t.toArray():void 0});return n.compact()},n.prototype.chunk=function(e){if(1>e)throw new Error("You must specify a positive chunk size.");return new M(this,e)},M.prototype=new n,M.prototype.getIterator=function(){return new A(this.parent,this.chunkSize)},A.prototype.current=function(){return this.currentChunk},A.prototype.moveNext=function(){for(var e=this.iterator,t=this.size,n=[];n.length<t&&e.moveNext();)n.push(e.current());return 0===n.length?!1:(this.currentChunk=n,!0)},n.prototype.tap=function(e){return new x(this,e)},x.prototype=new n,x.prototype.each=function(e){var t=this.callback;return this.parent.each(function(n,r){return t(n,r),e(n,r)})},n.prototype.find=function(e){return this.filter(e).first()},n.prototype.detect=function(e){return this.find(e)},n.prototype.min=function(e){return"undefined"!=typeof e?this.minBy(e):this.reduce(function(e,t){return e>t?t:e},1/0)},n.prototype.minBy=function(e){return e=Oe(e),this.reduce(function(t,n){return e(n)<e(t)?n:t})},n.prototype.max=function(e){return"undefined"!=typeof e?this.maxBy(e):this.reduce(function(e,t){return t>e?t:e},-(1/0))},n.prototype.maxBy=function(e){return e=Oe(e),this.reduce(function(t,n){return e(n)>e(t)?n:t})},n.prototype.sum=function(e){return"undefined"!=typeof e?this.sumBy(e):this.reduce(function(e,t){return e+t},0)},n.prototype.sumBy=function(e){
return e=Oe(e),this.reduce(function(t,n){return t+e(n)},0)},n.prototype.join=function(e){return e="string"==typeof e?e:",",this.reduce(function(t,n,r){return r>0&&(t+=e),t+n},"")},n.prototype.toString=function(e){return this.join(e)},n.prototype.async=function(e){return new Ce(this,e)},O.prototype=new n,O.prototype.eachMemoizerCache=function(e){var n=new N(t(this.array).getIterator()),r=0;return this.parent.each(function(t){return n.contains(t)?e(t,r++):void 0})},O.prototype.eachArrayCache=function(e){var t=this.array,n=Ue,r=0;return this.parent.each(function(i){return n(t,i)?e(i,r++):void 0})},D.prototype=new n,D.prototype.each=function(e){var t=this.array;return this.parent.each(function(n,r){return e([n,t[r]],r)})},W.prototype=new n,W.define=function(e,t){if(!t||"function"!=typeof t.get)throw new Error("A custom array-like sequence must implement *at least* get!");return Ve(W,e,t)},W.prototype.get=function(e){return this.parent.get(e)},W.prototype.length=function(){return this.parent.length()},W.prototype.getIndex=function(){return this},W.prototype.getIterator=function(){return new F(this)},F.prototype.current=function(){return this.sequence.get(this.index)},F.prototype.moveNext=function(){return this.index>=this.sequence.length()-1?!1:(++this.index,!0)},W.prototype.each=function(e){for(var t=this.length(),n=-1;++n<t;)if(e(this.get(n),n)===!1)return!1;return!0},W.prototype.pop=function(){return this.initial()},W.prototype.shift=function(){return this.drop()},W.prototype.slice=function(e,t){var n=this.length();0>e&&(e=n+e);var r=this.drop(e);return"number"==typeof t&&(0>t&&(t=n+t),r=r.take(t-e)),r},W.prototype.map=function(e){return new P(this,Oe(e))},P.prototype=new W,P.prototype.get=function(e){return 0>e||e>=this.parent.length()?void 0:this.mapFn(this.parent.get(e),e)},W.prototype.filter=function(e){return new L(this,Oe(e))},L.prototype=new a,L.prototype.each=function(e){for(var t,n=this.parent,r=this.filterFn,i=this.parent.length(),o=-1,s=0;++o<i;)if(t=n.get(o),r(t,o)&&e(t,s++)===!1)return!1;return!0},W.prototype.reverse=function(){return new U(this)},U.prototype=new W,U.prototype.get=function(e){return this.parent.get(this.length()-e-1)},W.prototype.first=function(e){return"undefined"==typeof e?this.get(0):new H(this,e)},H.prototype=new W,H.prototype.length=function(){var e=this.parent.length();return this.count<=e?this.count:e},W.prototype.rest=function(e){return new j(this,e)},j.prototype=new W,j.prototype.get=function(e){return this.parent.get(this.count+e)},j.prototype.length=function(){var e=this.parent.length();return this.count<=e?e-this.count:0},W.prototype.concat=function(e){return 1===arguments.length&&arguments[0]instanceof Array?new $(this,e):n.prototype.concat.apply(this,arguments)},$.prototype=new W,$.prototype.get=function(e){var t=this.parent.length();return t>e?this.parent.get(e):this.other[e-t]},$.prototype.length=function(){return this.parent.length()+this.other.length},W.prototype.uniq=function(e){return new q(this,Oe(e))},q.prototype=new n,q.prototype.eachArrayCache=function(e){for(var t,n,r=this.parent,i=this.keyFn,o=r.length(),s=[],a=Ue,c=-1,u=0;++c<o;)if(n=r.get(c),t=i(n),!a(s,t)&&(s.push(t),e(n,u++)===!1))return!1},q.prototype.eachSetCache=w.prototype.each,i.prototype=new W,i.prototype.cache=function(){return this.cachedResult||(this.cachedResult=this.parent.toArray())},i.prototype.get=function(e){return this.cache()[e]},i.prototype.length=function(){return this.cache().length},i.prototype.slice=function(e,t){return this.cache().slice(e,t)},i.prototype.toArray=function(){return this.cache().slice(0)},V.prototype=new W,V.prototype.root=function(){return this},V.prototype.isAsync=function(){return!1},V.prototype.get=function(e){return this.source[e]},V.prototype.length=function(){return this.source.length},V.prototype.each=function(e){return Pe(this.source,e)},V.prototype.map=function(e){return new K(this,Oe(e))},V.prototype.filter=function(e){return new G(this,Oe(e))},V.prototype.uniq=function(e){return new z(this,e)},V.prototype.concat=function(e){return 1===arguments.length&&arguments[0]instanceof Array?new J(this,e):W.prototype.concat.apply(this,arguments)},V.prototype.toArray=function(){return this.source.slice(0)},K.prototype=new W,K.prototype.get=function(e){var t=this.parent.source;if(!(0>e||e>=t.length))return this.mapFn(t[e])},K.prototype.length=function(){return this.parent.source.length},K.prototype.each=function(e){for(var t=this.parent.source,n=t.length,r=this.mapFn,i=-1;++i<n;)if(e(r(t[i],i),i)===!1)return!1;return!0},G.prototype=new a,G.prototype.each=function(e){for(var t,n=this.parent.source,r=this.filterFn,i=n.length,o=-1,s=0;++o<i;)if(t=n[o],r(t,o)&&e(t,s++)===!1)return!1;return!0},z.prototype=new n,z.prototype.eachNoCache=function(e){for(var t,n=this.parent.source,r=this.keyFn,i=n.length,o=He,s=-1,a=0;++s<i;)if(t=n[s],!o(n,t,s,r)&&e(t,a++)===!1)return!1;return!0},z.prototype.eachArrayCache=function(e){var t,n,r=this.parent.source,i=this.keyFn,o=r.length,s=[],a=Ue,c=-1,u=0;if(i){for(i=Oe(i);++c<o;)if(n=r[c],t=i(n),!a(s,t)&&(s.push(t),e(n,u++)===!1))return!1}else for(;++c<o;)if(n=r[c],!a(s,n)&&(s.push(n),e(n,u++)===!1))return!1;return!0},z.prototype.eachSetCache=w.prototype.each,J.prototype=new W,J.prototype.get=function(e){var t=this.parent.source,n=t.length;return n>e?t[e]:this.other[e-n]},J.prototype.length=function(){return this.parent.source.length+this.other.length},J.prototype.each=function(e){for(var t=this.parent.source,n=t.length,r=this.other,i=r.length,o=0,s=-1;++s<n;)if(e(t[s],o++)===!1)return!1;for(s=-1;++s<i;)if(e(r[s],o++)===!1)return!1;return!0},X.prototype=new n,X.define=function(e,t){if(!t||"function"!=typeof t.each)throw new Error("A custom object-like sequence must implement *at least* each!");return Ve(X,e,t)},X.prototype.value=function(){return this.toObject()},X.prototype.get=function(e){var t=this.pairs().find(function(t){return t[0]===e});return t?t[1]:void 0},X.prototype.keys=function(){return this.map(function(e,t){return t})},X.prototype.values=function(){return this.map(function(e,t){return e})},X.prototype.async=function(){throw new Error("An ObjectLikeSequence does not support asynchronous iteration.")},X.prototype.filter=function(e){return new Q(this,Oe(e))},Q.prototype=new X,Q.prototype.each=function(e){var t=this.filterFn;return this.parent.each(function(n,r){return t(n,r)?e(n,r):void 0})},X.prototype.reverse=function(){return this},X.prototype.assign=function(e){return new Z(this,e)},X.prototype.extend=function(e){return this.assign(e)},Z.prototype=new X,Z.prototype.get=function(e){return e in this.other?this.other[e]:this.parent.get(e)},Z.prototype.each=function(e){var n=new qe,r=!1;return t(this.other).each(function(t,i){return e(t,i)===!1?(r=!0,!1):void n.add(i)}),r?void 0:this.parent.each(function(t,r){return n.contains(r)||e(t,r)!==!1?void 0:!1})},X.prototype.defaults=function Xe(Xe){return new ee(this,Xe)},ee.prototype=new X,ee.prototype.get=function(e){var t=this.parent.get(e);return void 0!==t?t:this.defaults[e]},ee.prototype.each=function(e){var n=new qe,r=!1;this.parent.each(function(t,i){return e(t,i)===!1?(r=!0,!1):void("undefined"!=typeof t&&n.add(i))}),r||t(this.defaults).each(function(t,r){return n.contains(r)||e(t,r)!==!1?void 0:!1})},X.prototype.invert=function(){return new te(this)},te.prototype=new X,te.prototype.each=function(e){this.parent.each(function(t,n){return e(n,t)})},X.prototype.merge=function(e){var t=arguments.length>1&&"function"==typeof arguments[arguments.length-1]?Ye.call(arguments):null;return new ne(this,Je.call(arguments,0),t)},ne.prototype=new X,ne.prototype.each=function(e){var n=this.others,r=this.mergeFn||re,i={},o=this.parent.each(function(t,o){var s=t;return Pe(n,function(e){o in e&&(s=r(s,e[o]))}),i[o]=!0,e(s,o)});if(o===!1)return!1;var s={};return Pe(n,function(e){for(var t in e)i[t]||(s[t]=r(s[t],e[t]))}),t(s).each(e)},X.prototype.functions=function(){return this.filter(function(e,t){return"function"==typeof e}).map(function(e,t){return t})},X.prototype.methods=function(){return this.functions()},X.prototype.pick=function(e){return new oe(this,e)},oe.prototype=new X,oe.prototype.get=function(e){return Ue(this.properties,e)?this.parent.get(e):void 0},oe.prototype.each=function(e){var t=Ue,n=this.properties;return this.parent.each(function(r,i){return t(n,i)?e(r,i):void 0})},X.prototype.omit=function(e){return new se(this,e)},se.prototype=new X,se.prototype.get=function(e){return Ue(this.properties,e)?void 0:this.parent.get(e)},se.prototype.each=function(e){var t=Ue,n=this.properties;return this.parent.each(function(r,i){return t(n,i)?void 0:e(r,i)})},X.prototype.pairs=function(){return this.map(function(e,t){return[t,e]})},X.prototype.toArray=function(){return this.pairs().toArray()},X.prototype.toObject=function(){return this.reduce(function(e,t,n){return e[n]=t,e},{})},g.prototype=new X,g.prototype.each=function(e){var t,n=Oe(this.keyFn),r=Oe(this.valFn);return t=this.parent.reduce(function(e,t){var i=n(t),o=r(t);return e[i]instanceof Array?e[i].push(o):e[i]=[o],e},{}),Ee(function(t){for(var n in t)if(e(t[n],n)===!1)return!1},t)},k.prototype=new X,k.prototype.each=function(e){var t=Oe(this.keyFn),n=Oe(this.valFn),r={};return this.parent.each(function(i){var o=t(i),s=n(i);return r[o]?void 0:(r[o]=s,e(s,o))})},C.prototype=new X,C.prototype.each=function(e){var t=Oe(this.keyFn),n={};this.parent.each(function(e){var r=t(e);n[r]?n[r]+=1:n[r]=1});for(var r in n)if(e(n[r],r)===!1)return!1;return!0},X.prototype.watch=function(e){throw new Error("You can only call #watch on a directly wrapped object.")},ae.prototype=new X,ae.prototype.root=function(){return this},ae.prototype.isAsync=function(){return!1},ae.prototype.get=function(e){return this.source[e]},ae.prototype.each=function(e){var t,n=this.source;for(t in n)if(e(n[t],t)===!1)return!1;return!0},ce.prototype=new W,ce.define=function(e,t){if(!t||"function"!=typeof t.get)throw new Error("A custom string-like sequence must implement *at least* get!");return Ve(ce,e,t)},ce.prototype.value=function(){return this.toString()},ce.prototype.getIterator=function(){return new ue(this)},ue.prototype.current=function(){return this.source.charAt(this.index)},ue.prototype.moveNext=function(){return++this.index<this.source.length()},ce.prototype.charAt=function(e){return this.get(e)},ce.prototype.charCodeAt=function(e){var t=this.charAt(e);return t?t.charCodeAt(0):NaN},ce.prototype.substring=function(e,t){return new he(this,e,t)},he.prototype=new ce,he.prototype.get=function(e){return this.parent.get(e+this.start)},he.prototype.length=function(){return("number"==typeof this.stop?this.stop:this.parent.length())-this.start},ce.prototype.first=function(e){return"undefined"==typeof e?this.charAt(0):this.substring(0,e)},ce.prototype.last=function(e){return"undefined"==typeof e?this.charAt(this.length()-1):this.substring(this.length()-e)},ce.prototype.drop=function(e){return this.substring(e)},ce.prototype.indexOf=function(e,t){return this.toString().indexOf(e,t)},ce.prototype.lastIndexOf=function(e,t){return this.toString().lastIndexOf(e,t)},ce.prototype.contains=function(e){return-1!==this.indexOf(e)},ce.prototype.endsWith=function(e){return this.substring(this.length()-e.length).toString()===e},ce.prototype.startsWith=function(e){return this.substring(0,e.length).toString()===e},ce.prototype.toUpperCase=function(){return this.mapString(function(e){return e.toUpperCase()})},ce.prototype.toLowerCase=function(){return this.mapString(function(e){return e.toLowerCase()})},ce.prototype.mapString=function(e){return new le(this,e)},le.prototype=new ce,le.prototype.get=P.prototype.get,le.prototype.length=P.prototype.length,ce.prototype.reverse=function(){return new de(this)},de.prototype=new ce,de.prototype.get=U.prototype.get,de.prototype.length=U.prototype.length,ce.prototype.toString=function(){return this.join("")},ce.prototype.match=function(e){return new pe(this,e)},pe.prototype=new n,pe.prototype.getIterator=function(){return new fe(this.parent.toString(),this.pattern)},fe.prototype.current=function(){return this.match[0]},fe.prototype.moveNext=function(){return!!(this.match=this.pattern.exec(this.source))},ce.prototype.split=function(e){return new ve(this,e)},ve.prototype=new n,ve.prototype.getIterator=function(){var e=this.parent.toString();return this.pattern instanceof RegExp?""===this.pattern.source||"(?:)"===this.pattern.source?new ue(e):new me(e,this.pattern):""===this.pattern?new ue(e):new ye(e,this.pattern)},me.prototype.current=function(){return this.source.substring(this.start,this.end)},me.prototype.moveNext=function(){if(!this.pattern)return!1;var e=this.pattern.exec(this.source);return e?(this.start=this.nextStart?this.nextStart:0,this.end=e.index,this.nextStart=e.index+e[0].length,!0):this.pattern?(this.start=this.nextStart,this.end=void 0,this.nextStart=void 0,this.pattern=void 0,!0):!1},ye.prototype.current=function(){return this.source.substring(this.leftIndex,this.rightIndex)},ye.prototype.moveNext=function(){return this.finished||(this.leftIndex="undefined"!=typeof this.leftIndex?this.rightIndex+this.delimiter.length:0,this.rightIndex=this.source.indexOf(this.delimiter,this.leftIndex)),-1===this.rightIndex?(this.finished=!0,this.rightIndex=void 0,!0):!this.finished},_e.prototype=new ce,_e.prototype.root=function(){return this},_e.prototype.isAsync=function(){return!1},_e.prototype.get=function(e){return this.source.charAt(e)},_e.prototype.length=function(){return this.source.length},_e.prototype.toString=function(){return this.source},ge.prototype=new n,ge.prototype.isAsync=function(){return!1},ge.prototype.length=function(){return this.fixedLength},ge.prototype.each=function(e){for(var t=this.get,n=this.fixedLength,r=0;"undefined"==typeof n||n>r;)if(e(t(r),r++)===!1)return!1;return!0},ge.prototype.getIterator=function(){return new ke(this)},ke.prototype.current=function(){return this.currentValue},ke.prototype.moveNext=function(){var e=this.sequence;return"number"==typeof e.fixedLength&&this.index>=e.fixedLength?!1:(this.currentValue=e.get(this.index++),!0)},Ce.prototype=new n,Ce.prototype.isAsync=function(){return!0},Ce.prototype.getIterator=function(){throw new Error("An AsyncSequence does not support synchronous iteration.")},Ce.prototype.each=function(e){var t=this.parent.getIterator(),n=this.onNextCallback,r=this.cancelCallback,i=0,o=new we(function(){s&&r(s)}),s=n(function a(){s=null;try{t.moveNext()&&e(t.current(),i++)!==!1?s=n(a):o._resolve()}catch(r){o._reject(r)}});return o};var Ke=1,Ge=2,ze=3;we.prototype.then=function(e,t){var n=new we(this.cancelFn);return this.resolveListeners.push(function(t){try{if("function"!=typeof e)return void Se(n,t);Se(n,e(t))}catch(r){n._reject(r)}}),this.rejectListeners.push(function(e){try{if("function"!=typeof t)return void n._reject(e);Se(n,t(e))}catch(r){n._reject(r)}}),this.state===Ge&&this._resolve(this.value),this.state===ze&&this._reject(this.reason),n},we.prototype._resolve=function(e){this.state!==ze&&(this.state===Ke&&(this.state=Ge,this.value=e),Ie(this.resolveListeners,this.value))},we.prototype._reject=function(e){this.state!==Ge&&(this.state===Ke&&(this.state=ze,this.reason=e),Ie(this.rejectListeners,this.reason))},we.prototype.cancel=function(){this.cancelFn&&(this.cancelFn(),this.cancelFn=null,this._resolve(!1))},we.prototype.onComplete=function(e){return this.resolveListeners.push(e),this},we.prototype.onError=function(e){return this.rejectListeners.push(e),this},Ce.prototype.reverse=function(){return this.parent.reverse().async()},Ce.prototype.find=function(e){var t,n=this.each(function(n,r){return e(n,r)?(t=n,!1):void 0});return n.then(function(){return t})},Ce.prototype.indexOf=function(e){var t=-1,n=this.each(function(n,r){return n===e?(t=r,!1):void 0});return n.then(function(){return t})},Ce.prototype.contains=function(e){var t=!1,n=this.each(function(n){return n===e?(t=!0,!1):void 0});return n.then(function(){return t})},Ce.prototype.async=function(){return this},ae.prototype.watch=function(e){return new Ne(this.source,e)},Ne.prototype=new Ce,Ne.prototype.each=function(e){this.listeners.push(e)},Me.prototype=new Ce,Me.prototype.isAsync=function(){return!0},Me.prototype.split=function(e){return new Ae(this,e)},Ae.prototype=new n,Ae.prototype.getEachForDelimiter=function(e){return e instanceof RegExp?this.regexEach:this.stringEach},Ae.prototype.regexEach=function(e){var t,n=$e(this.delimiter),r="",i=0,o=0,s=this.parent.each(function(s){r+=s;for(var a;a=n.exec(r);){if(t=a.index,e(r.substring(i,t),o++)===!1)return!1;i=t+a[0].length}r=r.substring(i),i=0});return s.onComplete(function(){r.length>0&&e(r,o++)}),s},Ae.prototype.stringEach=function(e){var t=this.delimiter,n=0,r="",i=this.parent.each(function(i){r+=i;for(var o;(o=r.indexOf(t))>=0;){var s=r.substr(0,o);if(r=r.substr(o+t.length),e(s,n++)===!1)return!1}return!0});return i.onComplete(function(){e(r,n++)}),i},Me.prototype.lines=function(){return this.split("\n")},Me.prototype.match=function(e){return new xe(this,e)},xe.prototype=new Ce,xe.prototype.each=function(e){var n=this.pattern,r=!1,i=0;return this.parent.each(function(o){return t(o).match(n).each(function(t){return e(t,i++)===!1?(r=!0,!1):void 0}),!r})},t.createWrapper=function(e){var t=function(){this.listeners=[]};return t.prototype=new Me,t.prototype.each=function(e){this.listeners.push(e)},t.prototype.emit=function(e){for(var t=this.listeners,n=t.length,r=n-1;r>=0;--r)t[r](e)===!1&&t.splice(r,1)},function(){var n=new t;return e.apply(n,arguments),n}},t.generate=function(e,t){return new ge(e,t)},t.range=function(){var e=arguments.length>1?arguments[0]:0,n=arguments.length>1?arguments[1]:arguments[0],r=arguments.length>2&&arguments[2];return r===!1&&(r=n>e?1:-1),0===r?t([]):t.generate(function(t){return e+r*t}).take(Math.ceil((n-e)/r))},t.repeat=function(e,n){return t.generate(function(){return e},n)},t.Sequence=n,t.ArrayLikeSequence=W,t.ObjectLikeSequence=X,t.StringLikeSequence=ce,t.StreamLikeSequence=Me,t.GeneratedSequence=ge,t.AsyncSequence=Ce,t.AsyncHandle=we,t.clone=function(e){return t(e).value()},t.deprecate=function(e,t){return function(){return console.warn(e),t.apply(this,arguments)}};var Ye=Array.prototype.pop,Je=Array.prototype.slice;return qe.prototype.add=function(e){var t,n=this.table,r=typeof e;switch(r){case"number":case"boolean":case"undefined":return n[e]?!1:(n[e]=!0,!0);case"string":switch(e.charAt(0)){case"_":case"f":case"t":case"c":case"u":case"@":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"N":e="@"+e}return n[e]?!1:(n[e]=!0,!0);default:return t=this.objects,Ue(t,e)?!1:(t.push(e),!0)}},qe.prototype.contains=function(e){var t=typeof e;switch(t){case"number":case"boolean":case"undefined":return!!this.table[e];case"string":switch(e.charAt(0)){case"_":case"f":case"t":case"c":case"u":case"@":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"N":e="@"+e}return!!this.table[e];default:return Ue(this.objects,e)}},Be.prototype.add=function(e){var t=this.contents,n=t.length,r=this.start;return this.count===n?(t[r]=e,this.start=(r+1)%n):t[this.count++]=e,this},Be.prototype.toArray=function(){var e=this.contents,t=this.start,n=this.count,r=e.slice(t,t+n);return r.length<n&&(r=r.concat(e.slice(0,n-r.length))),r},t})}),me=ve&&"object"==typeof ve&&"default"in ve?ve["default"]:ve,ye=function(){function e(){ae.classCallCheck(this,e),this._handlers=this._handlers||{},this._log=u(this),this._mergedHandlers=[]}return ae.createClass(e,[{key:"listenTo",value:function(e){var t=this;return me(this._handlers).values().each(function(n){return e.on(n,function(){for(var e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];return t.handle.apply(t,[n].concat(r))})})}},{key:"merge",value:function(e){return this._mergedHandlers.push(e)}},{key:"registerHandlers",value:function(e){var t=this;return me(e).pairs().each(function(e){var n=ae.slicedToArray(e,2),r=n[0],i=n[1];return t.registerHandler(r,i)})}},{key:"registerHandler",value:function(e,t){return this._handlers[e]=t}},{key:"handle",value:function(e){for(var t=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];var o=this._handlers[e];return this.type=e,this.params=r,c(this.canHandle(e)),null!=o&&o.apply(this,this.params),me(this._mergedHandlers).filter(function(t){return t.canHandle(e)}).each(function(n){return n.handle.apply(t,[e].concat(r))})}},{key:"canHandle",value:function(e){return e in this._handlers?!0:this._mergedHandlers.some(function(t){return t.canHandle(e)})}}]),e}(),_e=function(e){function t(e,n,r){ae.classCallCheck(this,t);var i=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return i._title=e,i._message=n,i._image=null!=r?r:t.defaultImage,i._createNotification(),i._addOnClickListener(),i._addOnCloseListener(),i}return ae.inherits(t,e),ae.createClass(t,[{key:"_createNotification",value:function(){return this.notification=new window.Notification(this._title,{body:this._message,icon:this._image})}},{key:"_addOnClickListener",value:function(){var e=this;return this.notification.onclick=function(){return e.cancel(),e.emit("clicked")}}},{key:"_addOnCloseListener",value:function(){var e=this;return this.notification.onclose=function(){return e.emit("closed")}}},{key:"show",value:function(){chrome.app.window.current().drawAttention()}},{key:"cancel",value:function(){this.notification&&this.notification.close(),chrome.app.window.current().clearAttention()}},{key:"toString",value:function(){return this._title+this._message}}]),t}(fe);_e.defaultImage="http://sourceforge.net/p/acupofjavachat/icon";var ge=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return n._chat=e,n}return ae.inherits(t,e),ae.createClass(t,[{key:"_handleCommand",value:function(e,t){var n;return t=t||"",(n=this._chat).userCommands.apply(n,[e,this.params[0]].concat(ae.toConsumableArray(t.split(" "))))}}]),t}(ye);ge.prototype._handlers={"test-notif":function(){return new _e("test","hi!").show()},"test-upgrade-prompt":function(){this._chat._promptToUpdate()},"get-pw":function(){return this._chat.displayMessage("notice",this.params[0].context,"Your password is: "+this._chat.remoteConnection._password)},"set-pw":function(e){var t=e.args[0]||"bacon";return this._chat.storage._store("password",t),this._chat.setPassword(t)}};var ke=function(){function e(t,n,r){ae.classCallCheck(this,e),this._channel=t,this._from=n,this._message=r}return ae.createClass(e,[{key:"getBody",value:function(){return this._message}},{key:"getTitle",value:function(){return this._from+" mentioned you in "+this._channel}},{key:"getStub",value:function(){return this._from+" mentioned you"}}],[{key:"shouldNotify",value:function(e,t){var n;return null==e?!1:(e=this._escapeTextForRegex(e.replace(/_+$/,"")),n=this._prepMessageForRegex(t,e),/\#nick\#_*([!?.]*|[-:;~\*\u0001]?)(?!\S)/i.test(n))}},{key:"_escapeTextForRegex",value:function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},{key:"_prepMessageForRegex",value:function(e,t){return e=e.replace(/,/g," "),e=e.replace(/\#nick\#/gi,"a"),e=e.replace(new RegExp("@?"+t,"ig"),"#nick#"),e.replace(/\S\#nick\#/i,"a")}}]),e}(),Ce=0,we=function(){var e=/^(?::([^\x20]+?)\x20)?([^\x20]+?)((?:\x20[^\x20:][^\x20]*)+)?(?:\x20:(.*))?$/;return function(t){var n=$.trim(t.toString("utf8")),r=e.exec(n);if(!r)throw new Error("invalid IRC message: "+t);return null!=r[3]?r[3]=r[3].slice(1).split(/\x20/):r[3]=[],null!=r[4]&&r[3].push(r[4]),{prefix:r[1],command:r[2],params:r[3]}}}(),Se=function(){var e=/^:|\x20/,t="some non-final arguments had spaces or initial colons in them";return function(n){var r=n.length-1,i=n.length>1?n[r]:!1;if(i===!0&&(n.pop(),r-=1),n&&n.length>0){if(n.slice(0,r).some(function(t){return e.test(t)}))throw new Error(t+"\n[PARAMS] "+JSON.stringify(n));return(e.test(n[r])||i===!0)&&(n[r]=":"+n[r]),n.join(" ")}return""}}(),Ie=Object.freeze({get arrayBufferConversionCount(){return Ce},parseCommand:we,hashString:N,parsePrefix:M,makeCommand:A,randomName:x,normaliseNick:O,nicksEqual:R,toSocketData:D,fromSocketData:W,emptySocketData:F,concatSocketData:P,isConvertingArrayBuffers:L,arrayToArrayBuffer:U}),be=function(){function e(){ae.classCallCheck(this,e),this._customStyle=[],this._nick=void 0,this.clear()}return ae.createClass(e,[{key:"setNick",value:function(e){return this._nick=e}},{key:"setCustomStyle",value:function(e){return this._customStyle=e}},{key:"clear",value:function(){return this._style=[],this._fromUs=this._toUs=!1,this._forcePrettyFormat=void 0,this._message=""}},{key:"setMessage",value:function(e){return this._message=e}},{key:"hasMessage",value:function(){return!!this._message}},{key:"setContext",value:function(e,t,n){return this._from=e,this._to=t,this._content=n,this._fromUs=this._isOwnNick(this._from),this._toUs=this._isOwnNick(this._to)}},{key:"setContent",value:function(e){return this._content=e}},{key:"setContentMessage",value:function(e){return this.setContext(void 0,void 0,e),this.setContent(e),this.setMessage("#content")}},{key:"setFromUs",value:function(e){return this._fromUs=e}},{key:"setToUs",value:function(e){return this._toUs=e}},{key:"setPrettyFormat",value:function(e){return this._forcePrettyFormat=e}},{key:"_usePrettyFormat",value:function(){var e;return null!=(e=this._forcePrettyFormat)?e:!this.hasStyle("no-pretty-format")}},{key:"format",value:function(){var e;return this._message?(e=this._incorporateContext(),this._usePrettyFormat()&&(e=this._prettyFormat(e)),e):""}},{key:"_incorporateContext",value:function(){var e;return e=this._message,e=this._fixGrammer("#from",e),e=e.replace("#from",this._fromUs?"you":this._escapeDollarSign(this._from)),e=e.replace("#to",this._toUs?"you":this._escapeDollarSign(this._to)),e.replace("#content",this._escapeDollarSign(this._content))}},{key:"_escapeDollarSign",value:function(e){return e?e.replace("$","$$$$"):e}},{key:"_prettyFormat",value:function(e){return this._startsWithNick(e)||(e=g(e)),this._fromUs?e="("+e+")":/[a-zA-Z0-9]$/.test(e)&&(e+="."),e}},{key:"_fixGrammer",value:function(e,t){var n;return n=[],this._fromUs&&n.push("#from"),this._toUs&&n.push("#to"),n.reduce(function(e,t){return e.replace(t+" is",t+" are").replace(t+" has",t+" have")},t)}},{key:"_startsWithNick",value:function(e){var t,n;return n=0===e.indexOf(this._to)&&!this._toUs,t=0===e.indexOf(this._from)&&!this._fromUs,n||t}},{key:"setStyle",value:function(e){return this._style=[e]}},{key:"addStyle",value:function(e){return Array.isArray(e)||(e=[e]),this._style=this._style.concat(e)}},{key:"hasStyle",value:function(e){return this._customStyle.indexOf(e)>=0||this._style.indexOf(e)>=0}},{key:"getStyle",value:function(){var e=this._customStyle.concat(this._style);return(this._fromUs||this._toUs)&&e.push("self"),e.join(" ")}},{key:"_isOwnNick",value:function(e){return R(this._nick,e)}}]),e}(),Te=function(){function e(t,n){ae.classCallCheck(this,e),this.server=t,this.channel=n}return ae.createClass(e,[{key:"toString",value:function(){return this.channel?this.server+" "+this.channel:this.server}},{key:"fromString",value:function(t){return new(Function.prototype.bind.apply(e,[null].concat(ae.toConsumableArray(t.split(" ")))))}},{key:"wrap",value:function(e){return e.toString=this.prototype.toString,e}}]),e}(),Ee=function(){function e(){ae.classCallCheck(this,e),this.add=this.add.bind(this),this._entries={},this._whitelist=[]}return ae.createClass(e,[{key:"getData",value:function(){return this._entries}},{key:"loadData",value:function(e){return this._entries=e}},{key:"whitelist",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this._whitelist=this._whitelist.concat(t)}},{key:"add",value:function(t,n,r){var i,o,s;if(this._hasValidType(n.split(" ")))return i=null!=(s=(o=this._entries)[t])?s:o[t]=[],i.push(r),i.length>e.MAX_ENTRIES_PER_SERVER?i.splice(0,25):void 0}},{key:"_hasValidType",value:function(e){var t=this;return e.some(function(e){return t._whitelist.indexOf(e)>=0})}},{key:"getContextList",value:function(){return Object.keys(this._entries).map(function(e){return Te.fromString(e)})}},{key:"get",value:function(e){var t;return null!=(t=this._entries[e])?t.join(" "):void 0}}]),e}();Ee.MAX_ENTRIES_PER_SERVER=1e3;var Ne={topic:function(e,t){return this._chat.updateStatus(),this._formatter.setContent(t),t?e?(this._formatter.addStyle("update"),this._formatter.setMessage("#from changed the topic to: #content")):(this._formatter.addStyle("notice"),this._formatter.setMessage("the topic is: #content")):(this._formatter.addStyle("notice"),this._formatter.setMessage("no topic is set"))},topic_info:function(e,t){return this._formatter.addStyle("notice"),this._formatter.setContent(v(parseInt(1e3*t))),this._formatter.setMessage("Topic set by #from on #content."),this._formatter.setPrettyFormat(!1)},list:function(e,t,n){this._formatter.addStyle("list"),this._formatter.setContent(n);var r=e+" "+t+" #content";return this._formatter.setMessage(r)},join:function(e){return this._formatter.addStyle("update"),this._formatter.setMessage("#from joined the channel"),this._win.nicks.add(e)},part:function(e){return this._formatter.addStyle("update"),this._formatter.setMessage("#from left the channel"),this._win.nicks.remove(e)},kick:function(e,t){return this._formatter.addStyle("update"),this._formatter.setMessage("#from kicked #to from the channel: #content"),this._win.nicks.remove(t)},nick:function(e,t){return this._isOwnNick(t)&&(this._formatter.setFromUs(!0),this._formatter.setToUs(!1)),this._formatter.addStyle("update"),this._formatter.setMessage("#from is now known as #to"),this._win.isServerWindow()?void 0:(this._win.nicks.remove(e),this._win.nicks.add(t))},mode:function(e,t,n){return t?(this._formatter.addStyle("update"),this._formatter.setContent(this._getModeMessage(n)),this._formatter.setMessage("#from #content #to")):void 0},user_mode:function(e,t){return this._formatter.addStyle("notice"),this._formatter.setContext(void 0,e,t),this._formatter.setMessage("#to has modes #content")},quit:function(e,t){return this._formatter.addStyle("update"),this._formatter.setMessage("#from has quit: #content"),this._formatter.setContent(t),this._win.nicks.remove(e)},disconnect:function(){return this._formatter.addStyle("update"),this._formatter.setMessage("Disconnected"),this._formatter.setFromUs(!0)},connect:function(){return this._formatter.addStyle("update"),this._formatter.setMessage("Connected"),this._formatter.setFromUs(!0)},privmsg:function(e,t){return this._formatter.addStyle("update"),this._handleMention(e,t),this._formatPrivateMessage(e,t)},breakgroup:function(e){return null==e&&(e=""),this._formatter.setContentMessage(e)},error:function(e){return this._formatter.setContentMessage(e)},system:function(e){return this._formatter.setContentMessage(e)},notice:function(e){return this._formatter.addStyle("notice-group"),this._formatter.setContentMessage(e)},welcome:function(e){return this._formatter.addStyle("group"),this._formatter.setContentMessage(e)},other:function(e){return this._formatter.addStyle("group"),this._formatter.setContentMessage(e.params[e.params.length-1])},nickinuse:function(e,t){var n;return this._formatter.addStyle("notice"),n="Nickname "+e+" already in use.",t&&(n+=" Trying to get nickname "+t+"."),this._formatter.setMessage(n)},away:function(e){return this._chat.updateStatus(),this._formatter.addStyle("notice"),this._formatter.setContentMessage(e)},kill:function(){return this._formatter.addStyle("notice"),this._formatter.setMessage("Kill command used on #to")},socket_error:function(e){switch(this._formatter.addStyle("error"),this._formatter.setToUs(!0),e){case-15:return this._formatter.setMessage("Disconnected: Remote host closed socket");default:return this._formatter.setMessage("Socket Error: "+e)}}},Me=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));
return n._chat=e,n._handlers=Ne,n._suspendNotifications=!1,n._formatter=new be,n._chatLog=new Ee,n._chatLog.whitelist("privmsg"),n._ignoredMessages={},n}return ae.inherits(t,e),ae.createClass(t,[{key:"setSuspendNotifications",value:function(e){this._suspendNotifications=e}},{key:"ignoreMessageType",value:function(e,t){var n=this._ignoredMessages;return null==n[e]&&(n[e]={}),n[e][t.toLowerCase()]=!0,this._chat.storage.ignoredMessagesChanged()}},{key:"stopIgnoringMessageType",value:function(e,t){return t=t.toLowerCase(),this._ignoredMessages[e][t]?(delete this._ignoredMessages[e][t],this._chat.storage.ignoredMessagesChanged()):void 0}},{key:"getIgnoredMessages",value:function(){return this._ignoredMessages}},{key:"setIgnoredMessages",value:function(e){return this._ignoredMessages=e}},{key:"getChatLog",value:function(){return this._chatLog.getData()}},{key:"logMessagesFromWindow",value:function(e){return e.on("message",this._chatLog.add)}},{key:"replayChatLog",value:function(e){e&&this._chatLog.loadData(e);for(var t=this._chatLog.getContextList(),n=0,r=t.length;r>n;n++){var i=t[n],o=this._chat.winList.get(i.server,i.channel);o&&o.rawHTML(this._chatLog.get(i))}}},{key:"setWindow",value:function(e){var t;return this._win=e,this._formatter.setNick(null!=(t=this._win.conn)?t.irc.nick:void 0)}},{key:"setCustomMessageStyle",value:function(e){return this._formatter.setCustomStyle(e)}},{key:"handle",value:function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return this._setDefaultValues(r),ae.get(Object.getPrototypeOf(t.prototype),"handle",this).apply(this,[e].concat(r)),this._sendFormattedMessage()}},{key:"_setDefaultValues",value:function(e){var t;return this.source="",this._formatter.clear(),(t=this._formatter).setContext.apply(t,ae.toConsumableArray(e))}},{key:"_getModeMessage",value:function(e){var t,n;return n="+"===e[0]?"gave":"took",t="+"===e[0]?"to":"from",e=this._getMode(e),n+" "+e+" "+t}},{key:"_getMode",value:function(e){switch(e[1]){case"o":return"channel operator status";case"O":return"local operator status";case"v":return"voice";case"i":return"invisible status";case"w":return"wall operator status";case"a":return"away status";default:return e}}},{key:"_getUserAction",value:function(e){return/^\u0001ACTION (.*)\u0001/.exec(e)}},{key:"_handleMention",value:function(e,t){var n,r,i;return n=this._nickWasMentioned(e,t),n&&(this._chat.recordLastUserToMention(this._win.getContext(),e),this._win.isPrivate()||this._formatter.addStyle("mention"),this._shouldNotifyMention()&&this._createNotification(e,t)),!this._isFromWindowInFocus()&&(this._chat.channelDisplay.activity(null!=(r=this._win.conn)?r.name:void 0,this._win.target),n)?this._chat.channelDisplay.mention(null!=(i=this._win.conn)?i.name:void 0,this._win.target):void 0}},{key:"_createNotification",value:function(e,t){var n,r=this,i=this._win;return n=new ke(i.target,e,t),i.notifications.add(n),i.notifications.on("clicked",function(){var e;return r._chat.switchToWindow(i),"function"==typeof(e=chrome.app.window.current()).focus?e.focus():void 0})}},{key:"_nickWasMentioned",value:function(e,t){var n,r=null!=(n=this._win.conn)?n.irc.nick:void 0;return this._isOwnNick(e)?!1:this._formatter.hasStyle("notice")?!1:this._formatter.hasStyle("direct")?!1:this._win.isPrivate()?!0:ke.shouldNotify(r,t)}},{key:"_shouldNotifyMention",value:function(){return!(this._suspendNotifications||this._isFromWindowInFocus()&&window.document.hasFocus())}},{key:"_isFromWindowInFocus",value:function(){return this._win.equals(this._chat.currentWindow)}},{key:"_formatPrivateMessage",value:function(e,t){var n=this._getUserAction(t);return this._formatter.setMessage("#content"),this._formatter.setPrettyFormat(!1),n?(this._formatter.setContent(e+" "+n[1]),this._formatter.addStyle("action")):(this._formatter.hasStyle("notice")?this.source="- "+e+" -":this._formatter.hasStyle("direct")?this.source="> "+e+" <":this.source=e,this._formatter.setContent(t))}},{key:"_sendFormattedMessage",value:function(){return this._formatter.hasMessage()&&!this._shouldIgnoreMessage(this._win.getContext(),this.type)?(this._formatter.addStyle(this.type),this._win.message(this.source,this._formatter.format(),this._formatter.getStyle())):void 0}},{key:"_shouldIgnoreMessage",value:function(e,t){var n;return null!=(n=this._ignoredMessages[e])?n[t]:void 0}},{key:"_isOwnNick",value:function(e){var t=this._win.conn;return null!=t?t.irc.isOwnNick(e):void 0}}]),t}(ye),Ae="0.7.3",xe="http://flackr.github.com/circ",Oe="https://github.com/flackr/circ/issues",Re=Ae,De=function(){function e(){ae.classCallCheck(this,e),this._error=e.DELIMITER+"ERRMSG"+e.DELIMITER}return ae.createClass(e,[{key:"isCTCPRequest",value:function(e){return/\u0001[\w\s]*\u0001/.test(e)?this.getResponses(e).length>0:!1}},{key:"getReadableName",value:function(e){return this._parseMessage(e)[0]}},{key:"getResponses",value:function(e){var t=this,n=this._parseMessage(e),r=n[0],i=this._getResponseText(r,n[1]);return i.map(function(e){return t._createCTCPResponse(r,e)})}},{key:"_parseMessage",value:function(e){var t=e.slice(1,+(e.length-2)+1||9e9).split(" "),n=t[0],r=2<=t.length?t.slice(1):[];return[n,r]}},{key:"_getResponseText",value:function(e,t){var n,r;switch(e){case"VERSION":return r="CIRC",n="Chrome",[" "+[r,Re,n].join(" ")];case"SOURCE":return[" https://github.com/flackr/circ/"];case"PING":return[" "+t[0]];case"TIME":var i=new Date;return[" "+i.toUTCString()];default:return[]}}},{key:"_createCTCPResponse",value:function(t,n){return""+(e.DELIMITER+t+n+e.DELIMITER)}}]),e}();De.DELIMITER="";var We=function(){function e(t,n){ae.classCallCheck(this,e),this.type=t,this.name=n;for(var r=arguments.length,i=Array(r>2?r-2:0),o=2;r>o;o++)i[o-2]=arguments[o];this.args=i,this.context={},this.style=[],this.hook=this.type+" "+this.name}return ae.createClass(e,[{key:"setContext",value:function(e,t){return this.context={server:e,channel:t}}},{key:"addStyle",value:function(e){return Array.isArray(e)||(e=[e]),this.style=this.style.concat(e)}}]),e}();We.wrap=function(e){var t;return e instanceof We?e:(t=new(Function.prototype.bind.apply(We,[null].concat([e.type,e.name],ae.toConsumableArray(e.args)))),t.setContext(e.context.server,e.context.channel),t)};var Fe={1:function(e,t,n){var r=this;return"disconnecting"===this.irc.state?void this.irc.quit():(this.irc.nick=t,this.irc.state="connected",this.irc.emit("connect"),this.irc.emitMessage("welcome",_t.SERVER_WINDOW,n),me(this.irc.channels).pairs().map(function(e){var t=ae.slicedToArray(e,2),n=t[0],i=t[1];return i.key?r.irc.send("JOIN",n,i.key):r.irc.send("JOIN",n)}).toArray())},5:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];me(n.slice(2,n.length-1)).map(function(e){return e.split(/=/,2)}).async(0).each(function(t){var n=t[0].toLowerCase();1===t.length?e.irc.support[n]=!0:e.irc.support[n]=t[1]})},353:function(e,t,n,r,i){var o,s=r.toLowerCase(),a=this.irc.partialNameLists,c=a[s],u=null!=c?c:a[s]={};return o=me(i.split(/\x20/)).map(function(e){return e.replace(/^[~&@%+]/,"")}).compact(),o.async(0).each(function(e){u[O(e)]=e}),this.irc.emit("names",r,o.toArray())},366:function(e,t,n){var r=n.toLowerCase();return this.irc.channels[r]&&(this.irc.channels[r].names=this.irc.partialNameLists[r]),delete this.irc.partialNameLists[n.toLowerCase()]},NICK:function(e,t){var n=this,r=this.irc.util.normaliseNick(e.nick),i=this.irc.util.normaliseNick(t),o=me(this.irc.channels).pairs().filter(function(e){var t=ae.slicedToArray(e,2),n=t[1];return!(r in n.names)});return this.irc.isOwnNick(e.nick)&&(this.irc.nick=t,this.irc.emit("nick",t),this.irc.emitMessage("nick",_t.SERVER_WINDOW,e.nick,t)),o.each(function(e){var n=ae.slicedToArray(e,2),o=n[1];delete o.names[r],o.names[i]=t}),o.map(function(r){var i=ae.slicedToArray(r,1),o=i[0];return n.irc.emitMessage("nick",o,e.nick,t)})},JOIN:function(e,t){var n=this.irc.channels[t.toLowerCase()];return this.irc.isOwnNick(e.nick)&&(null!=n?n.names=[]:n=this.irc.channels[t.toLowerCase()]={channel:t,names:[]},this.irc.emit("joined",t)),n?(n.names[this.irc.util.normaliseNick(e.nick)]=e.nick,this.irc.emitMessage("join",t,e.nick)):console.warn("Got JOIN for channel we're not in ("+n+")")},PART:function(e,t){var n=this.irc.channels[t.toLowerCase()];return n?this.irc.isOwnNick(e.nick)?(delete this.irc.channels[t.toLowerCase()],this.irc.emit("parted",t)):(delete n.names[this.irc.util.normaliseNick(e.nick)],this.irc.emitMessage("part",t,e.nick)):console.warn("Got PART for a channel we're not in: "+t)},INVITE:function(e,t,n){return this.irc.emitMessage("notice",_t.CURRENT_WINDOW,e.nick+" invites you to join "+n)},QUIT:function(e,t){var n=this,r=this.irc.util.normaliseNick(e.nick);return me(this.irc.channels).pairs().filter(function(e){var t=ae.slicedToArray(e,2),n=t[1];return r in n.names}).each(function(i){var o=ae.slicedToArray(i,2),s=o[0],a=o[1];delete a.names[r],n.irc.emitMessage("quit",s,e.nick,t)})},PRIVMSG:function(e,t,n){return this.ctcpHandler.isCTCPRequest(n)?this._handleCTCPRequest(e,t,n):this.irc.emitMessage("privmsg",t,e.nick,n)},NOTICE:function(e,t,n){if(!e.user)return this.irc.emitMessage("notice",_t.SERVER_WINDOW,n);var r=new We("message","privmsg",e.nick,n);return r.setContext(this.irc.server,_t.CURRENT_WINDOW),r.addStyle("notice"),this.irc.emitCustomMessage(r)},PING:function(e,t){return this.irc.send("PONG",t)},PONG:function(){},TOPIC:function(e,t,n){return null!=this.irc.channels[t.toLowerCase()]?(this.irc.channels[t.toLowerCase()].topic=n,this.irc.emitMessage("topic",t,e.nick,n)):console.warn("Got TOPIC for a channel we're not in ("+t+")")},KICK:function(e,t,n,r){return this.irc.channels[t.toLowerCase()]?(delete this.irc.channels[t.toLowerCase()].names[n],this.irc.emitMessage("kick",t,e.nick,n,r),void(this.irc.isOwnNick(n)&&this.irc.emit("parted",t))):void console.warn("Got KICK message from "+e+" to "+n+" in channel we are not in ("+t+")")},MODE:function(e,t,n){for(var r=this,i=arguments.length,o=Array(i>3?i-3:0),s=3;i>s;s++)o[s-3]=arguments[s];o.length<1||me(n.split(/(?=[+-]\w)/)).map(function(e){return me(e.split("")).slice(1).map(function(t){return e[0]+t})}).flatten().zip(o).each(function(n){var i=ae.slicedToArray(n,2),o=i[0],s=i[1];return r.irc.emitMessage("mode",t,e.nick,s,o)})},221:function(e,t,n){return this.irc.emitMessage("user_mode",_t.CURRENT_WINDOW,t,n)},301:function(e,t,n,r){return this._emitUserNotice(t,n,"is away: "+r)},305:function(e,t,n){return this.irc.away=!1,this.irc.emitMessage("away",_t.CURRENT_WINDOW,n)},306:function(e,t,n){return this.irc.away=!0,this.irc.emitMessage("away",_t.CURRENT_WINDOW,n)},310:function(){},311:function(e,t,n,r,i,o,s){var a="is "+n+"!"+r+"@"+i+" ("+s+")";return this._emitUserNotice(t,n,a)},312:function(e,t,n,r,i){return this._emitUserNotice(t,n,"connected via "+r+" ("+i+")")},313:function(e,t,n,r){return this._emitUserNotice(t,n,r)},314:function(e,t,n,r,i,o,s){var a="was "+n+"!"+r+"@"+i+" ("+s+")";return this._emitUserNotice(t,n,a)},315:function(e,t,n,r){return this.irc.emitMessage("notice",_t.SERVER_WINDOW,r)},317:function(e,t,n,r,i){var o=v(1e3*parseInt(i)),s="has been idle for "+r+" seconds, and signed on at: "+o;return this._emitUserNotice(t,n,s)},318:function(e,t,n,r){return this._emitUserNotice(t,n,r)},319:function(e,t,n,r){return this._emitUserNotice(t,n,"is on channels: "+r)},322:function(e,t,n,r,i){return this.irc.emitMessage("list",_t.SERVER_WINDOW,n,r,i)},324:function(e,t,n,r,i){var o="Channel modes: "+r+" "+(i||"");return this.irc.emitMessage("notice",n,o)},329:function(e,t,n,r){var i="Channel created on "+v(parseInt(1e3*r));return this.irc.emitMessage("notice",n,i)},330:function(e,t,n,r,i){return this._emitUserNotice(t,n,i+" "+r)},331:function(e,t,n){return this.handle("TOPIC",{},n)},332:function(e,t,n,r){return this.handle("TOPIC",{},n,r)},333:function(e,t,n,r,i){return this.irc.emitMessage("topic_info",n,r,i)},338:function(e,t,n,r,i,o){var s="is actually "+r+"/"+i+" ("+o+")";return this._emitUserNotice(t,n,s)},352:function(e,t,n,r,i,o,s,a,c){var u=c.indexOf(" "),h=n+": "+s,l="G"==a.substring(0,1)?" (AWAY)":"",d=" | "+r+"@"+i+" ("+c.substring(u+1)+") | via "+o+", hops "+c.substring(0,u);return this.irc.emitMessage("notice",_t.SERVER_WINDOW,h+l+d)},369:function(e,t,n,r){return this._emitUserNotice(t,n,r)},378:function(){},433:function(e,t,n){var r=n+"_";return t===r&&(r=void 0),this.irc.emitMessage("nickinuse",_t.CURRENT_WINDOW,n,r),r?this.irc.send("NICK",r):void 0},671:function(e,t,n,r){return this._emitUserNotice(t,n,r)},error:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o,s=r[r.length-1];return r.pop(),o=r.length>0?r.join(" ")+" :"+s:s,this.irc.emitMessage("error",_t.CURRENT_WINDOW,o)},KILL:function(e,t,n,r){return this.irc.emitMessage("kill",_t.CURRENT_WINDOW,n.nick,t,r)}},Pe=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.irc=e,n.ctcpHandler=new De,n}return ae.inherits(t,e),ae.createClass(t,[{key:"canHandle",value:function(e){return this._isErrorMessage(e)?!0:ae.get(Object.getPrototypeOf(t.prototype),"canHandle",this).call(this,e)}},{key:"handle",value:function(e){!this._isErrorMessage(e)||e in this._handlers||(e="error");for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return ae.get(Object.getPrototypeOf(t.prototype),"handle",this).apply(this,[e].concat(r))}},{key:"_isErrorMessage",value:function(e){var t;return 400<=(t=parseInt(e))&&600>t}},{key:"_handleCTCPRequest",value:function(e,t,n){var r=this,i=this.ctcpHandler.getReadableName(n),o="Received a CTCP "+i+" from "+e.nick;return this.irc.emitMessage("notice",_t.CURRENT_WINDOW,o),this.ctcpHandler.getResponses(n).map(function(t){return r.irc.doCommand("NOTICE",e.nick,t,!0)})}},{key:"_emitUserNotice",value:function(e,t,n){var r=new We("message","privmsg",t,n);return r.setContext(this.irc.server,e),r.addStyle("notice"),this.irc.emitCustomMessage(r)}}]),t}(ye);Pe.prototype._handlers=Fe;var Le=function(e){function t(){var e;ae.classCallCheck(this,t);for(var n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];return ae.possibleConstructorReturn(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(r)))}return ae.inherits(t,e),ae.createClass(t,[{key:"connect",value:function(){}},{key:"write",value:function(){}},{key:"close",value:function(){}},{key:"setTimeout",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){var n=this;if(e>0){if(this.timeout=setTimeout(function(){return n.emit("timeout")},e),this.timeout_ms=e,t)return this.once("timeout",t)}else if(0===e)return clearTimeout(this.timeout),t&&this.removeListener("timeout",t),this.timeout=null,this.timeout_ms=0})},{key:"_active",value:function(){var e=this;return this.timeout?(clearTimeout(this.timeout),this.timeout=setTimeout(function(){return e.emit("timeout")},this.timeout_ms)):void 0}}]),t}(fe),Ue=function(e){function t(){ae.classCallCheck(this,t);var e=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e._onCreate=e._onCreate.bind(e),e._onConnect=e._onConnect.bind(e),e._onReceive=e._onReceive.bind(e),e._onReceiveError=e._onReceiveError.bind(e),e}return ae.inherits(t,e),ae.createClass(t,[{key:"connect",value:function(e,t){var n=this;return this._active(),chrome.sockets.tcp.create({},function(r){n._onCreate(r,e,parseInt(t))})}},{key:"_onCreate",value:function(e,t,n){var r=this;return this.socketId=e.socketId,this.socketId>0?(w(e.socketId),void chrome.sockets.tcp.setPaused(this.socketId,!0,function(){chrome.sockets.tcp.connect(r.socketId,t,n,r._onConnect)})):this.emit("error","couldn't create socket")}},{key:"_onConnect",value:function(e){if(0>e){var t="Couldn't connect to socket: "+chrome.runtime.lastError.message+" (error "+-e+")";return this.emit("error",t)}this.emit("connect"),chrome.sockets.tcp.onReceive.addListener(this._onReceive),chrome.sockets.tcp.onReceiveError.addListener(this._onReceiveError),chrome.sockets.tcp.setPaused(this.socketId,!1)}},{key:"_onReceive",value:function(e){e.socketId==this.socketId&&(this._active(),this.emit("data",e.data))}},{key:"_onReceiveError",value:function(e){e.socketId==this.socketId&&(this._active(),-100==e.resultCode?(this.emit("end"),this.close()):(this.emit("error","read from socket: error "+-e.resultCode+")"),this.close()))}},{key:"write",value:function(e){var t=this;return this._active(),chrome.sockets.tcp.send(this.socketId,e,function(n){if(n.resultCode<0){var r=chrome.runtime.lastError.message;console.error("SOCKET ERROR on send: ",r+" (error "+-n.resultCode+")")}return n.bytesSent===e.byteLength?t.emit("drain"):(n.bytesSent>=0&&console.error("Can't handle non-complete send: wrote "+(n.bytesSent+" expected "+e.byteLength)),t.emit("error","Invalid send on socket, code: "+n.bytesSent))})}},{key:"close",value:function(){return null!=this.socketId&&(chrome.sockets.tcp.onReceive.removeListener(this._onReceive),chrome.sockets.tcp.onReceiveError.removeListener(this._onReceiveError),chrome.sockets.tcp.disconnect(this.socketId),chrome.sockets.tcp.close(this.socketId),w(this.socketId,!0)),this.emit("close")}}]),t}(Le),He=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.reconnect=n.reconnect.bind(n),n.onTimeout=n.onTimeout.bind(n),n.util=Ie,n.preferredNick="circ-user-"+n.util.randomName(5),n.setSocket(e||new Ue),n.data=n.util.emptySocketData(),n.exponentialBackoff=0,n.partialNameLists={},n.channels={},n.serverResponseHandler=new Pe(n),n.state="disconnected",n.support={},n._log=u(n),n}return ae.inherits(t,e),ae.createClass(t,[{key:"setSocket",value:function(e){var t=this;return delete this.socket,this.socket=e,this.socket.on("connect",function(){return t.onConnect()}),this.socket.on("data",function(e){return t.onData(e)}),this.socket.on("drain",function(){return t.onDrain()}),this.socket.on("error",function(e){return t.onError(e)}),this.socket.on("end",function(e){return t.onEnd(e)}),this.socket.on("close",function(e){return t.onClose(e)})}},{key:"setPreferredNick",value:function(e){this.preferredNick=e}},{key:"connect",value:function(e,t,n){var r=this.state;return this.server=null!=e?e:this.server,this.port=null!=t?t:this.port,this.password=null!=n?n:this.password,"disconnected"===r||"reconnecting"===r?(clearTimeout(this.reconnectTimeout),this.socket.connect(this.server,this.port),this.state="connecting"):void 0}},{key:"quit",value:function(e){return"connected"===this.state||"disconnecting"===this.state?(this.send("QUIT",null!=e?e:this.quitReason),this.state="disconnected",this.endSocketOnDrain=!0):(this.quitReason=e,this.state="disconnecting")}},{key:"giveup",value:function(){return"reconnecting"===this.state?(clearTimeout(this.reconnectTimeout),this.state="disconnected"):void 0}},{key:"join",value:function(e,t){return"connected"===this.state?t?this.doCommand("JOIN",e,t):this.doCommand("JOIN",e):this.channels[e.toLowerCase()]?void 0:this.channels[e.toLowerCase()]={channel:e,names:[],key:t}}},{key:"part",value:function(e,t){return"connected"===this.state?this.doCommand("PART",e,t):this.channels[e.toLowerCase()]?delete this.channels[e.toLowerCase()]:void 0}},{key:"doCommand",value:function(){return this.sendIfConnected.apply(this,arguments)}},{key:"onConnect",value:function(){return this.password&&this.send("PASS",this.password),this.send("NICK",this.preferredNick),this.send("USER",this.preferredNick.replace(/[^a-zA-Z0-9]/,""),"0","*","Hyuu"),this.socket.setTimeout(6e4,this.onTimeout)}},{key:"onTimeout",value:function(){return"connected"===this.state&&this.exponentialBackoff>0&&this.exponentialBackoff--,this.send("PING",+new Date),this.socket.setTimeout(6e4,this.onTimeout)}},{key:"onError",value:function(e){return this.emitMessage("socket_error",_t.SERVER_WINDOW,e),this.setReconnect(),this.socket.close()}},{key:"onClose",value:function(){return this.socket.setTimeout(0,this.onTimeout),"connected"===this.state?(this.emit("disconnect"),this.setReconnect()):void 0}},{key:"onEnd",value:function(){return console.error("remote peer closed connection"),"connecting"===this.state||"connected"===this.state?(this.emit("disconnect"),this.setReconnect()):void 0}},{key:"setReconnect",value:function(){var e;return this.state="reconnecting",e=2e3*Math.pow(2,this.exponentialBackoff),this.reconnectTimeout=setTimeout(this.reconnect,e),this.exponentialBackoff>4?void 0:this.exponentialBackoff++}},{key:"reconnect",value:function(){return this.connect()}},{key:"onData",value:function(e){var t=this;this.data=this.util.concatSocketData(this.data,e);for(var n=new Uint8Array(this.data),r=[];n.length>0;){for(var i=!1,o=null,s=0;s<n.length;++s){var a=n[s];if(13===a)i=!0;else{if(10===a){o=s;break}i=!1}}if(null===o)break;var c=this.data.slice(0,i?o-1:o);this.data=this.data.slice(o+1),n=new Uint8Array(this.data),r.push(this.util.fromSocketData(c,function(e){return t._log("<=","("+t.server+")",e),t.onServerMessage(t.util.parseCommand(e))}))}return r}},{key:"onDrain",value:function(){return this.endSocketOnDrain&&this.socket.close(),this.endSocketOnDrain=!1}},{key:"send",value:function(){var e,t=this,n=(e=this.util).makeCommand.apply(e,arguments);return this._log("=>",this.server,n.slice(0,n.length-2)),this.util.toSocketData(n,function(e){return t.socket.write(e)})}},{key:"sendIfConnected",value:function(){return"connected"===this.state?this.send.apply(this,arguments):void 0}},{key:"onServerMessage",value:function(e){return/^\d{3}$/.test(e.command)&&(e.command=parseInt(e.command,10)),this.serverResponseHandler.canHandle(e.command)?this.handle.apply(this,[e.command,this.util.parsePrefix(e.prefix)].concat(ae.toConsumableArray(e.params))):this.emitMessage("other",_t.SERVER_WINDOW,e)}},{key:"handle",value:function(){var e;return(e=this.serverResponseHandler).handle.apply(e,arguments)}},{key:"emit",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o=new(Function.prototype.bind.apply(We,[null].concat(["server",e],r)));return o.setContext(this.server,t),this.emitCustomEvent(o)}},{key:"emitMessage",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o=new(Function.prototype.bind.apply(We,[null].concat(["message",e],r)));return o.setContext(this.server,t),this.emitCustomMessage(o)}},{key:"emitCustomMessage",value:function(e){return this.emitCustomEvent(e)}},{key:"emitCustomEvent",value:function(e){return ae.get(Object.getPrototypeOf(t.prototype),"emit",this).call(this,e.type,e)}},{key:"isOwnNick",value:function(e){return R(this.nick,e)}},{key:"isValidChannelPrefix",value:function(e){var t=this.support.chantypes||"#&";return-1!=t.indexOf(e.substr(0,1))}}]),t}(fe);window.ArrayBuffer.prototype.slice=window.ArrayBuffer.prototype.slice||window.ArrayBuffer.prototype.webkitSlice||function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r=Uint8Array.prototype.subarray.apply(new Uint8Array(this),t),i=new Uint8Array(r.length);return i.set(r),i.buffer};var je=function(){function e(t,n){ae.classCallCheck(this,e),this.description=n,this.name=t,this.describe(this.description),this._hasValidArgs=!1}return ae.createClass(e,[{key:"describe",value:function(e){var t;return null==this._description&&(this._description=e.description),null==this._params&&(this._params=e.params),null==this._requires&&(this._requires=e.requires),null==this._validateArgs&&(this._validateArgs=e.validateArgs),null==this._usage&&(this._usage=e.usage),null==this.run&&(this.run=e.run),null!=(t=this.category)?t:this.category=e.category}},{key:"tryToRun",value:function(e){if(this.setContext(e),!this.canRun())return void(this.shouldDisplayFailedToRunMessage()&&this.displayHelp());for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return this.setArgs.apply(this,n),this._hasValidArgs?this.run():this.displayHelp()}},{key:"setChat",value:function(e){this.chat=e}},{key:"setContext",value:function(e){return this.win=this.chat.determineWindow(e),this.win!==_t.NO_WINDOW?(this.conn=this.win.conn,this.chan=this.win.target):void 0}},{key:"setArgs",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this._hasValidArgs=this._tryToAssignArgs(t)&&(!this._validateArgs||!!this._validateArgs())}},{key:"_tryToAssignArgs",value:function(e){var t,n=this;return this.args=[],this._removeTrailingWhiteSpace(e),this._params?(this._resetParams(),this._truncateVariableArgs(e),t=this._truncateExtraOptionalParams(e.length),e.length!==t.length?!1:(t.forEach(function(t,r){return n[n._getParamName(t)]=e[r]}),this.args=e,!0)):0===e.length}},{key:"_resetParams",value:function(){var e,t,n,r,i;for(r=this._params,i=[],t=0,n=r.length;n>t;t++)e=r[t],i.push(this[this._getParamName(e)]=void 0);return i}},{key:"_removeTrailingWhiteSpace",value:function(e){for(;""===e[e.length-1];)e.pop();return e}},{key:"_truncateVariableArgs",value:function(e){var t;return e.length<this._params.length?e:this._isVariable(this._params[this._params.length-1])?(e[this._params.length-1]=null!=(t=e.slice(this._params.length-1))?t.join(" "):void 0,e.length=this._params.length):void 0}},{key:"_truncateExtraOptionalParams",value:function(e){var t,n,r,i,o,s=this._params.length-e;if(0>=s)return this._params;for(r=[],t=i=o=this._params.length-1;0>=o?0>=i:i>=0;t=0>=o?++i:--i)n=this._params[t],s>0&&this._isOptional(n)?s--:r.splice(0,0,n);return r}},{key:"shouldDisplayFailedToRunMessage",value:function(){return this.win===_t.NO_WINDOW?!1:"say"!==this.name}},{key:"canRun",value:function(e){var t=this;return e&&this.setContext(e),this.run?this._requires?!this._requires.some(function(e){return!t._meetsRequirement(e)}):!0:!1}},{key:"_meetsRequirement",value:function(e){switch(e){case"online":return m();case"connection":return!!this.conn&&m();case"channel":return!!this.chan;default:return a(this,["conn","irc","state"])===e}}},{key:"displayHelp",value:function(e){return null==e&&(e=this.win),e.message("",t(this.getHelp()),"notice help")}},{key:"getHelp",value:function(){var e,t,n=this._description?", "+this._description:"";return this._usage&&(e=""+this._usage),null==e&&(e=(null!=(t=this._params)?t.length:void 0)>0?this._getUsage():""),this.name.toUpperCase()+" "+e+n+"."}},{key:"_getUsage",value:function(){var e=this;return this._params.map(function(t){var n=e._getParamName(t);return e._isOptional(t)?"["+n+"]":"<"+n+">"}).join(" ")}},{key:"_getParamName",value:function(e){return this._isOptional(e)&&(e=e.slice(4)),this._isVariable(e)&&(e=e.slice(0,+(e.length-4)+1||9e9)),e}},{key:"_isOptional",value:function(e){return 0===e.indexOf("opt_")}},{key:"_isVariable",value:function(e){return"..."===(null!=e?e.slice(e.length-3):void 0)}},{key:"isOwnNick",value:function(e){var t;return null==e&&(e=this.nick),R(null!=(t=this.conn)?t.irc.nick:void 0,e)}},{key:"displayDirectMessage",value:function(e,t){var n;return null==e&&(e=this.nick),null==t&&(t=this.message),null!=(null!=(n=this.conn)?n.windows[e]:void 0)?this._displayDirectMessageInPrivateChannel(e,t):this._displayDirectMessageInline(e,t)}},{key:"_displayDirectMessageInPrivateChannel",value:function(e,t){var n;return n={server:this.conn.name,channel:e},this.chat.displayMessage("privmsg",n,this.conn.irc.nick,t)}},{key:"_displayDirectMessageInline",value:function(e,t){return this.displayMessageWithStyle("privmsg",e,t,"direct")}},{key:"displayMessage",value:function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];var i=n[0],o=2<=n.length?n.slice(1):[],s={server:a(this,["conn","name"]),channel:this.chan};return(e=this.chat).displayMessage.apply(e,[i,s].concat(ae.toConsumableArray(o)))}},{key:"displayMessageWithStyle",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r,i=t[0],o=3<=t.length?t.slice(1,r=t.length-1):(r=1,[]),s=t[r++],c=new(Function.prototype.bind.apply(We,[null].concat(["message",i],ae.toConsumableArray(o))));return c.setContext(a(this,["conn","name"]),this.chan),c.addStyle(s),this.chat.emit(c.type,c)}},{key:"handleCTCPRequest",value:function(e,t){var n=De.DELIMITER,r=n+t+n;return this.displayDirectMessage(e,"CTCP "+t),this.conn.irc.doCommand("PRIVMSG",e,r)}},{key:"setModeArgs",value:function(e){return this.nicks=[this.nick],this.target=this.chan,this.mode=e}},{key:"isValidMode",value:function(e){var t;return"+"===(t=null!=e?e[0]:void 0)||"-"===t}},{key:"listInstalledScripts",value:function(){var e=this.chat.scriptHandler.getScriptNames();return e.isEmpty()?"No scripts are currently installed":"Installed scripts: "+f(e)}}]),e}(),$e=function(){function e(){ae.classCallCheck(this,e)}return ae.createClass(e,[{key:"parse",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r,i=t[0],o=2<=t.length?t.slice(1):[];return"-c"===o[1]?(r=this._mergeQuotedWords(o.slice(2)),[o[0].toUpperCase(),i].concat(ae.toConsumableArray(r))):(r=this._mergeQuotedWords(o.slice(1)),[o[0].toUpperCase()].concat(ae.toConsumableArray(r)))}},{key:"_mergeQuotedWords",value:function(e){var t,n,r,i,o=-1;for(t=r=0,i=e.length;i>r;t=++r)if(n=e[t],'"'===n[0]&&-1===o&&(o=t),'"'===n[n.length-1]&&-1!==o)return e.splice(o,t-o+1,e.slice(o,+t+1||9e9).join(" ")),e[o]=this._trimQuotes(e[o]),this._mergeQuotedWords(e);return e}},{key:"_trimQuotes",value:function(e){return e.slice(1,+(e.length-2)+1||9e9)}}]),e}(),qe=new $e,Be=function(){function e(t,n){ae.classCallCheck(this,e),this.sourceCode=t,this.frame=n,this.id=e.getUniqueID(),this._messagesToHandle=[],this._name="script"+(this.id+1)}return ae.createClass(e,[{key:"postMessage",value:function(e){return this.frame.postMessage(e,"*")}},{key:"shouldHandle",value:function(e){return this._messagesToHandle.indexOf(e.hook)>=0}},{key:"beginHandlingType",value:function(e,t){return this._messagesToHandle.push(e+" "+t)}},{key:"setName",value:function(e){this._name=e}},{key:"getName",value:function(){return this._name}}]),e}();Be.getScriptFromFrame=function(e,t){return me(e).values().find(function(e){return e.frame===t})},Be.scriptCount=0,Be.getUniqueID=function(){return this.scriptCount++};var Ve=["  "],Ke=function(){function e(){ae.classCallCheck(this,e),this._sendSourceCode=this._sendSourceCode.bind(this),this._scripts={},addEventListener("message",this._sendSourceCode)}return ae.createClass(e,[{key:"_sendSourceCode",value:function(e){var t=Be.getScriptFromFrame(this._scripts,e.source);return t&&"onload"===e.data.type?(t.postMessage({type:"source_code",sourceCode:t.sourceCode}),delete this._scripts[t.id]):void 0}},{key:"loadPrepackagedScripts",value:function(e){var t=this;return Ve.map(function(n){return e(t._createScript(n))})}},{key:"loadScriptsFromStorage",value:function(e,t){var n=this;return e.map(function(e){return t(n._createScript(e.sourceCode))})}},{key:"createScriptFromFileSystem",value:function(e){var t=this;return C(function(n){try{return e(t._createScript(n))}catch(r){return console.error("failed to eval:",r.toString())}})}},{key:"_createScript",value:function(e){var t=this._createIframe(),n=new Be(e,t);return this._scripts[n.id]=n,n}},{key:"_createIframe",value:function(){var e;return e=document.createElement("iframe"),e.src="plugenv/script_frame.html",e.style.display="none",document.body.appendChild(e),e.contentWindow}},{key:"unloadScript",value:function(e){return document.body.removeChild(e.frame),delete e.frame}}]),e}(),Ge=new Ke,ze={nick:{description:"sets your nick",category:"common",params:["nick"],run:function(){var e;return this.chat.setNick(null!=(e=this.conn)?e.name:void 0,this.nick)}},server:{description:"connects to the server, port 6667 is used by default, reconnects to the current server if no server is specified, use '+' to enable SSL (i.e. +6667)",category:"common",params:["opt_server","opt_port","opt_password"],requires:["online"],validateArgs:function(){return this.port||(this.port=6667),null==this.server&&(this.server=a(this.conn,["name"])),
this.server&&!isNaN(this.port)},run:function(){return this.chat.connect(this.server,this.port,this.password)}},join:{description:"joins the channel with the key if provided, reconnects to the current channel if no channel is specified",category:"common",params:["opt_channel","opt_key"],requires:["connection"],validateArgs:function(){return null==this.channel&&(this.channel=this.chan),this.channel=this.channel.toLowerCase(),!0},run:function(){return this.chat.join(this.conn,this.channel,this.key)}},part:{description:"closes the current window and disconnects from the channel",category:"common",params:["opt_reason..."],requires:["connection","channel"],run:function(){this.chat.disconnectAndRemoveRoom(this.conn.name,this.chan,this.reason)}},leave:{"extends":"part"},close:{"extends":"part"},invite:{description:"invites the specified nick to the current or specified channel",category:"common",params:["nick...","opt_channel"],requires:["connection"],usage:"<nick> [channel]",run:function(){if(!this.channel){if(!this.chan)return this.displayMessage("error","you must be in a channel or specify one");this.channel=this.chan}return this.conn.irc.channels[this.channel]?(this.displayMessage("notice","inviting "+this.nick+" to join "+this.channel),this.conn.irc.doCommand("INVITE",this.nick,this.channel)):this.displayMessage("error","you must be in "+this.channel+" to invite someone to it")}},win:{description:"switches windows, only channel windows are selected this way",category:"misc",params:["windowNum"],validateArgs:function(){return this.windowNum=parseInt(this.windowNum),!isNaN(this.windowNum)},run:function(){return this.chat.switchToChannelByIndex(this.windowNum-1)}},debug:{description:"prints the last 300-400 logs to the developer console and enables future logging of info and warning messages",category:"misc",run:function(){h(),this.displayMessage("notice","logging enabled. See developer console for previous logs. Have a bug to report? File an issue at "+Oe)}},say:{description:"sends text to the current channel",category:"uncommon",params:["text..."],requires:["connection","channel","connected"],run:function(){return this.conn.irc.doCommand("PRIVMSG",this.chan,this.text),this.displayMessage("privmsg",this.conn.irc.nick,this.text)}},list:{description:"lists all channels on the server.",category:"uncommon",params:["opt_channels"],requires:["connection"],run:function(){return this.conn.irc.doCommand("LIST",this.channels)}},me:{description:"sends text to the current channel, spoken in the 3rd person",category:"uncommon","extends":"say",validateArgs:function(){return this.text="ACTION "+this.text+""}},quit:{description:"disconnects from the current server",category:"common",params:["opt_reason..."],requires:["connection"],run:function(){this.chat.disconnectAndRemoveRoom(this.conn.name,null,this.reason)}},names:{description:"lists nicks in the current channel",category:"uncommon",requires:["connection","channel","connected"],run:function(){var e,t;return this.win.isPrivate()?e="You're in a private conversation with "+this.chan+".":(t=me(this.conn.irc.channels[this.chan].names).values().sort().toArray(),e="Users in "+this.chan+": "+JSON.stringify(t)),this.win.message("",e,"notice names")}},clear:{description:"clears messages in the current window or from all windows if all is passed",category:"uncommon",params:["opt_all"],validateArgs:function(){return this.all&&"all"!==this.all?void 0:!0},run:function(){var e=this;if("all"!==this.all)return this.win.clear();var t=function(){var t=e.chat.winList;return{v:t.map(function(e,n){return t.get(n).clear()})}}();return"object"===("undefined"==typeof t?"undefined":ae["typeof"](t))?t.v:void 0}},help:{description:"displays information about a command, lists all commands if no command is specified",category:"misc",params:["opt_command"],run:function(){var e;return this.command=this.chat.userCommands.getCommand(this.command),this.command?this.command.displayHelp(this.win):(e=this.chat.userCommands.getCommands(),this.win.messageRenderer.displayHelp(e))}},hotkeys:{description:"lists keyboard shortcuts",category:"misc",run:function(){return this.win.messageRenderer.displayHotkeys(this.chat.getKeyboardShortcuts().getMap())}},raw:{description:"sends a raw event to the IRC server, use the -c flag to make the command apply to the current channel",category:"uncommon",params:["command","opt_arguments..."],usage:"<command> [-c] [arguments...]",requires:["connection"],validateArgs:function(){return this.arguments=this.arguments?this.arguments.split(" "):[]},run:function(){var e,t=qe.parse.apply(qe,[this.chan,this.command].concat(ae.toConsumableArray(this.arguments)));return(e=this.conn.irc).send.apply(e,ae.toConsumableArray(t))}},quote:{"extends":"raw"},install:{description:"loads a script by opening a file browser dialog",category:"scripts",run:function(){var e=this;return Ge.createScriptFromFileSystem(function(t){return e.chat.addScript(t)})}},uninstall:{description:"uninstalls a script, currently installed scripts can be listed with /scripts",params:["scriptName"],usage:"<script name>",category:"scripts",run:function(){var e,t;return t=this.chat.scriptHandler.getScriptByName(this.scriptName),t?(this.chat.storage.clearScriptStorage(this.scriptName),this.chat.scriptHandler.removeScript(t),this.chat.storage.scriptRemoved(t),this.displayMessage("notice","Script "+this.scriptName+" was successfully uninstalled")):(e="No script by the name '"+this.scriptName+"' was found. "+this.listInstalledScripts(),this.displayMessage("error",e))}},scripts:{description:"displays a list of installed scripts",category:"scripts",run:function(){return this.displayMessage("notice",this.listInstalledScripts())}},topic:{description:"sets the topic of the current channel, displays the current topic if no topic is specified",category:"uncommon",params:["opt_topic..."],requires:["connection","channel"],run:function(){return this.conn.irc.doCommand("TOPIC",this.chan,this.topic)}},kick:{description:"removes a user from the current channel",category:"uncommon",params:["nick","opt_reason..."],requires:["connection","channel"],run:function(){return this.conn.irc.doCommand("KICK",this.chan,this.nick,this.reason)}},mode:{description:"sets or gets the modes of a channel or user(s), the current channel is used by default",category:"uncommon",params:["opt_target","opt_mode","opt_nicks..."],usage:"< [channel|nick] | [channel] <mode> [nick1] [nick2] ...>",requires:["connection"],validateArgs:function(){var e,t;return 0===this.args.length?!0:(this.nicks=null!=(e=null!=(t=this.nicks)?t.split(" "):void 0)?e:[],1!==this.args.length||this.isValidMode(this.target)?(this.isValidMode(this.target)&&this.target!==this.chan&&(this.nicks.push(this.mode),this.mode=this.target,this.target=this.chan),this.target&&this.isValidMode(this.mode)):!0)},run:function(){if(0===this.args.length)return this.chan&&this.conn.irc.doCommand("MODE",this.chan),this.conn.irc.doCommand("MODE",this.conn.irc.nick);var e;return(e=this.conn.irc).doCommand.apply(e,["MODE",this.target,this.mode].concat(ae.toConsumableArray(this.nicks)))}},op:{description:"gives operator status",params:["nick"],"extends":"mode",usage:"<nick>",requires:["connection","channel"],validateArgs:function(){return this.setModeArgs("+o")}},deop:{description:"removes operator status",params:["nick"],"extends":"mode",usage:"<nick>",requires:["connection","channel"],validateArgs:function(){return this.setModeArgs("-o")}},voice:{description:"gives voice",params:["nick"],"extends":"mode",usage:"<nick>",requires:["connection","channel"],validateArgs:function(){return this.setModeArgs("+v")}},devoice:{description:"removes voice",params:["nick"],"extends":"mode",usage:"<nick>",requires:["connection","channel"],validateArgs:function(){return this.setModeArgs("-v")}},away:{description:"sets your status to away, a response is automatically sent when people /msg or WHOIS you",category:"uncommon",params:["opt_response..."],requires:["connection"],validateArgs:function(){return k(this.response)||(this.response="I'm currently away from my computer"),!0},run:function(){return this.conn.irc.doCommand("AWAY",this.response)}},back:{description:"sets your status to no longer being away",category:"uncommon",requires:["connection"],run:function(){return this.conn.irc.doCommand("AWAY",this.response)}},msg:{description:"sends a private message",category:"common",params:["nick","message..."],requires:["connection"],run:function(){return this.conn.irc.doCommand("PRIVMSG",this.nick,this.message),this.displayDirectMessage()}},whois:{description:"displays information about a nick",category:"uncommon",params:["opt_nick"],requires:["connection"],run:function(){return this.conn.irc.doCommand("WHOIS",this.nick)}},swhois:{description:"displays detailed information about a nick (by querying user's connecting server)",category:"uncommon",params:["opt_nick"],requires:["connection"],run:function(){return this.conn.irc.doCommand("WHOIS",this.nick,this.nick)}},whowas:{description:"displays recent login information about a nick",category:"uncommon",params:["opt_nick"],requires:["connection"],run:function(){return this.conn.irc.doCommand("WHOWAS",this.nick)}},who:{description:"displays detailed user list to server window; add 'o' as second option to restrict to IRCOps",category:"uncommon",params:["channel_or_pattern","opt_o"],requires:["connection"],run:function(){return this.conn.irc.doCommand("WHO",this.channel_or_pattern,this.o)}},about:{description:"displays information about this IRC client",category:"misc",run:function(){return this.win.messageRenderer.displayAbout()}},"join-server":{description:"use the IRC connection of another device, allowing you to be logged in with the same nick on multiple devices. Connects to the device that called /make-server if no arguments are given",category:"one_identity",requires:["online"],params:["opt_addr","opt_port"],validateArgs:function(){var e,t;return t=parseInt(this.port),!this.port&&!this.addr||t||this.addr?(e=this.chat.storage.serverDevice,this.port=t||(null!=e?e.port:void 0),null==this.addr&&(this.addr=null!=e?e.addr:void 0),!0):!1},run:function(){return this.port&&this.addr?this.addr===this.chat.remoteConnection.getConnectionInfo().addr?this.displayMessage("error","this device is the server and cannot connect to itself. Call /join-server on other devices to have them connect to this device or call /make-server on another device to make it the server"):(this.chat.remoteConnectionHandler.isManuallyConnecting(),this.chat.remoteConnection.connectToServer({port:this.port,addr:this.addr})):this.displayMessage("error","No server exists. Use /make-server on the device you wish to become the server.")}},"make-server":{description:"makes this device a server to which other devices can connect. Connected devices use the IRC connection of this device",category:"one_identity",requires:["online"],run:function(){var e=this,t=this.chat.remoteConnection.getState();return this.chat.remoteConnectionHandler.shouldBeServerDevice()?this.displayMessage("error","this device is already acting as a server"):H()?"no_addr"===t?this.displayMessage("error","this device can not be used as a server at this time because it cannot find its own IP address"):"no_port"===t?this.displayMessage("error","this device can not be used as a server at this time because no valid port was found"):"finding_port"===t?this.chat.remoteConnection.waitForPort(function(){return e.run}):(this.chat.storage.becomeServerDevice(this.chat.remoteConnection.getConnectionInfo()),this.chat.remoteConnectionHandler.determineConnection()):this.displayMessage("error","this command cannot be used with your current version of Chrome because it does not support chrome.sockets.tcpServer")}},"network-info":{description:"displays network information including port, ip address and remote connection status",category:"one_identity",run:function(){var e,t=this;if(this.displayMessage("breakgroup"),this.chat.remoteConnection.isServer()){var n=this.chat.remoteConnection.devices.length;n>0?this.displayMessage("notice","acting as a server for "+n+" other "+l("device",n)):this.displayMessage("notice","Acting as a server device. No clients have connected.")}else if(this.chat.remoteConnection.isClient()){var r=this.chat.remoteConnection.serverDevice;this.displayMessage("notice","connected to server device "+r.addr+" on port "+r.port)}else this.displayMessage("notice","not connected to any other devices");return"found_port"===this.chat.remoteConnection.getConnectionInfo().getState()?(this.displayMessage("breakgroup"),e=this.chat.remoteConnection.getConnectionInfo(),this.displayMessageWithStyle("notice","Port: "+e.port,"no-pretty-format"),this.displayMessage("breakgroup"),this.displayMessage("notice","IP addresses:"),e.possibleAddrs.map(function(e){return t.displayMessageWithStyle("notice","    "+e,"no-pretty-format")})):void 0}},"stop-server":{description:"stops connecting through another device's IRC connection and starts using a new IRC connection (see /join-server)",category:"one_identity",requires:["online"],run:function(){this.chat.remoteConnectionHandler.useOwnConnection(),this.displayMessage("notice","this device is now using its own IRC connection")}},autostart:{description:"sets whether the application will run on startup, toggles if no arguments are given",category:"misc",usage:"[ON|OFF]",params:["opt_state"],validateArgs:function(){return this.state?(this.state=this.state.toLowerCase(),"on"!==this.state&&"off"!==this.state?!1:(this.enabled="on"===this.state,!0)):(this.enabled=void 0,!0)},run:function(){var e;return e=this.chat.storage.setAutostart(this.enabled),e?this.displayMessage("notice","CIRC will now automatically run on startup"):this.displayMessage("notice","CIRC will no longer automatically run on startup")}},query:{description:"opens a new window for a private conversation with someone",category:"uncommon",params:["nick"],requires:["connection"],run:function(){var e=this.chat.createPrivateMessageWindow(this.conn,this.nick);return this.chat.switchToWindow(e)}},kill:{description:"kicks a user from the server",category:"uncommon",params:["nick","opt_reason"],requires:["connection"],run:function(){return this.conn.irc.doCommand("KILL",this.nick,this.reason)}},version:{description:"get the user's IRC version",category:"uncommon",params:["nick"],requires:["connection"],run:function(){return this.handleCTCPRequest(this.nick,"VERSION")}},ignore:{description:"stop certain message(s) from being displayed in the current channel, for example '/ignore join part' stops join and part messages from being displayed, a list of ignored messages is displayed if no arguments are given",category:"misc",params:["opt_types..."],requires:["connection"],usage:"[<message type 1> <message type 2> ...]",run:function(){var e,t=this,n=this.win.getContext();return this.types?(e=me(this.types.split(" ")),e.each(function(e){return t.chat.messageHandler.ignoreMessageType(n,e)}),this.displayMessage("notice","Messages of type "+f(e)+" will no longer be displayed in this room.")):(e=me(this.chat.messageHandler.getIgnoredMessages()[n]).keys(),e.isEmpty()?this.displayMessage("notice","There are no messages being ignored in this room."):this.displayMessage("notice","Messages of type "+f(e)+" are being ignored in this room."))}},unignore:{description:"stop ignoring certain message(s)","extends":"ignore",usage:"<message type 1> <message type 2> ...",run:function(){var e=this;if(this.types){var t=me(this.types.split(" "));return t.each(function(t){return e.chat.messageHandler.stopIgnoringMessageType(e.win.getContext(),t)}),this.displayMessage("notice","Messages of type "+f(t)+" are no longer being ignored.")}return this.displayHelp()}},theme:{description:"upload and use a custom CSS file, opens a file browser",category:"misc",run:function(){return C(function(e){return window.webkitStorageInfo.requestQuota(PERSISTENT,51200,function(e){window.requestFileSystem(PERSISTENT,e,function(){},B)},B),window.webkitRequestFileSystem(PERSISTENT,51200,function(t){return t.root.getFile("custom_style.css",{create:!0},function(t){return t.createWriter(function(n){var r=new Blob([e],{type:"text/css"});return n.onwriteend=function(){return $("#main-style").attr("href",t.toURL())},n.write(r)})})})})}},untheme:{description:"Remove the custom CSS file",category:"misc",run:function(){return window.webkitRequestFileSystem(PERSISTENT,51200,function(e){e.root.getFile("custom_style.css",{create:!1},function(e){e.remove(function(){return console.info("custom_style.css removed"),$("#main-style").attr("href","style.css")})})})}},"next-server":{description:"switches to the next server window",category:"hidden",run:function(){var e,t,n,r,i;return r=this.chat.winList,(t=r.getServerForWindow(this.win))?(n=r.serverIndexOf(t),e=null!=(i=r.getServerWindow(n+1))?i:r.getServerWindow(0),this.chat.switchToWindow(e)):void 0}},"next-room":{description:"switches to the next window",category:"hidden",run:function(){var e,t,n,r;return n=this.chat.winList,e=n.indexOf(this.win),0>e?void 0:(t=null!=(r=n.get(e+1))?r:n.get(0),this.chat.switchToWindow(t))}},"previous-room":{description:"switches to the next window",category:"hidden",run:function(){var e,t,n,r;return n=this.chat.winList,e=n.indexOf(this.win),0>e?void 0:(t=null!=(r=n.get(e-1))?r:n.get(n.length-1),this.chat.switchToWindow(t))}},reply:{description:"begin replying to the user who last mentioned your nick",category:"hidden",run:function(){var e;return(e=this.chat.getLastUserToMention(this.win.getContext()))?this.chat.emit("set_input_if_empty",e+": "):void 0}},image:{description:"embed an image in a message",category:"hidden",params:["src"],run:function(){var e=this.win;return p(this.src,function(t){var n=$("<img>");return n.on("load",function(){return n.css("max-width",n[0].width+"px"),n.css("width","100%"),e.rawMessage("",n[0].outerHTML)}),n.attr("src",t)})}},"suspend-notifications":{description:"suspends notifications temporarily",category:"hidden",params:["suspend"],run:function(){this.chat.messageHandler.setSuspendNotifications("on"==this.suspend.toLowerCase())}}},Ye=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return n.chat=e,n._handlers={},n._init(),n}return ae.inherits(t,e),ae.createClass(t,[{key:"getCommands",value:function(){return this._handlers}},{key:"getCommand",value:function(e){return this._handlers[e]}},{key:"listenTo",value:function(e){var t=this;return e.on("command",function(e){return t.canHandle(e.name)?t.handle.apply(t,[e.name,e].concat(ae.toConsumableArray(e.args))):void 0})}},{key:"handle",value:function(e,n){for(var r,i=arguments.length,o=Array(i>2?i-2:0),s=2;i>s;s++)o[s-2]=arguments[s];if(!this._isValidUserCommand(e)){var a;return void(a=ae.get(Object.getPrototypeOf(t.prototype),"handle",this)).call.apply(a,[this,e,n].concat(o))}return(r=this._handlers[e]).tryToRun.apply(r,[n].concat(o))}},{key:"_isValidUserCommand",value:function(e){return e in this._handlers}},{key:"_init",value:function(){var e=this;me(ze).pairs().each(function(t){var n=ae.slicedToArray(t,2),r=n[0],i=n[1];return e._addCommand(r,i)})}},{key:"_addCommand",value:function(e,t){var n=new je(e,t),r=this._handlers[t["extends"]];return r&&n.describe(r.description),n.setChat(this.chat),this._handlers[e]=n}}]),t}(ye),Je=function(){function e(){ae.classCallCheck(this,e),this._servers=[],this.length=0}return ae.createClass(e,[{key:"get",value:function(e,t){if("number"==typeof e)return this._getByNumber(e);for(var n=0,r=this._servers.length;r>n;n++){var i=this._servers[n];if(e===i.name){if(null==t)return i.serverWindow;for(var o=0,s=i.windows.length;s>o;o++){var a=i.windows[o];if(a.target===t.toLowerCase())return a}}}return null}},{key:"_getByNumber",value:function(e){for(var t=this._servers,n=0,r=t.length;r>n;n++){var i=t[n];if(0===e)return i.serverWindow;if(e-=1,e<i.windows.length)return i.windows[e];e-=i.windows.length}}},{key:"getChannelWindow",value:function(e){for(var t=this._servers,n=0,r=t.length;r>n;n++){var i=t[n];if(e<i.windows.length)return i.windows[e];e-=i.windows.length}}},{key:"getServerWindow",value:function(e){var t=this._servers[e];return null!=t?t.serverWindow:void 0}},{key:"add",value:function(e){return null!=e.target?this._addChannelWindow(e):this._addServerWindow(e),this.length++}},{key:"_addChannelWindow",value:function(e){var t=e.conn,n=this._servers;c(null!=(null!=t?t.name:void 0));for(var r=0,i=n.length;i>r;r++){var o=n[r];if(e.conn.name===o.name)return void this._addWindowToServer(o,e)}throw"added channel window with no corresponding connection window: "+e}},{key:"_addWindowToServer",value:function(e,t){return e.windows.push(t),e.windows.sort(function(e,t){return e.target.localeCompare(t.target)})}},{key:"_addServerWindow",value:function(e){var t=e.conn;return c(null!=(null!=t?t.name:void 0)),this._servers.push({name:e.conn.name,serverWindow:e,windows:[]})}},{key:"remove",value:function(e){var t,n,r,i,o,s,a,c,u,h;for(c=this._servers,n=i=0,s=c.length;s>i;n=++i)if(r=c[n],r.name===(null!=(u=e.conn)?u.name:void 0)){if(e.isServerWindow())return this._servers.splice(n,1),this.length-=r.windows.length+1,r.windows.concat([r.serverWindow]);for(h=r.windows,n=o=0,a=h.length;a>o;n=++o)if(t=h[n],t.target===e.target)return r.windows.splice(n,1),this.length--,[t]}return[]}},{key:"getServerForWindow",value:function(e){var t,n,r,i,o;if(e.isServerWindow())return e;for(i=this._servers,n=0,r=i.length;r>n;n++)if(t=i[n],t.name===(null!=(o=e.conn)?o.name:void 0))return t.serverWindow}},{key:"indexOf",value:function(e){var t,n,r,i,o,s,a,c,u,h,l;if(null==(null!=(u=e.conn)?u.name:void 0))return-1;for(n=0,h=this._servers,o=0,a=h.length;a>o;o++){if(i=h[o],e.conn.name===i.name){if(null==e.target)return n;for(n++,l=i.windows,r=s=0,c=l.length;c>s;r=++s)if(t=l[r],t.equals(e))return n+r;return-1}n+=i.windows.length+1}return-1}},{key:"localIndexOf",value:function(e){var t,n,r,i,o,s,a,c,u,h;if(null==(null!=(c=e.conn)?c.name:void 0))return-1;for(u=this._servers,i=0,s=u.length;s>i;i++)if(r=u[i],e.conn.name===r.name)for(h=r.windows,n=o=0,a=h.length;a>o;n=++o)if(t=h[n],t.equals(e))return n;return-1}},{key:"serverIndexOf",value:function(e){var t,n,r,i,o,s;if(null==(null!=(o=e.conn)?o.name:void 0))return-1;for(s=this._servers,t=r=0,i=s.length;i>r;t=++r)if(n=s[t],e.conn.name===n.name)return t;return-1}}]),e}(),Xe=function(){function e(){var t=this;ae.classCallCheck(this,e),this.$notice=$("#notice"),this.$content=$("#notice .content"),this.$close=$("#notice button.close"),this.$option1=$("#notice button.option1"),this.$option2=$("#notice button.option2"),this.$close.click(function(){return t._hide()})}return ae.createClass(e,[{key:"prompt",value:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];var i=n[0],o=2<=n.length?n.slice(1):[];return this._hide(),this._callbacks=o,this._parseRepresentation(i),this.$option1.click(function(){var t;return e._hide(),"function"==typeof(t=e._callbacks)[0]?t[0]():void 0}),this.$option2.click(function(){var t;return e._hide(),"function"==typeof(t=e._callbacks)[1]?t[1]():void 0}),this._show()}},{key:"close",value:function(){return this._hide()}},{key:"_hide",value:function(){return this.$notice.addClass("hide"),this.$option1.off("click"),this.$option2.off("click")}},{key:"_show",value:function(){this.$notice.removeClass("hide")}},{key:"_parseRepresentation",value:function(e){var t;return this._setMessageText(e),t=e.match(/\[.+?\]/g),this._setOptionText(this.$option1,null!=t?t[0]:void 0),this._setOptionText(this.$option2,null!=t?t[1]:void 0)}},{key:"_setMessageText",value:function(e){return e=e.split("[")[0],this.$content.text($.trim(e))}},{key:"_setOptionText",value:function(e,t){var n;return t?(n=t.slice(1,+(t.length-2)+1||9e9),e.removeClass("hidden"),e.text(n)):e.hasClass("hidden")?void 0:e.addClass("hidden")}}]),e}(),Qe=function(e){function t(e,n){ae.classCallCheck(this,t);var r=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return r.$list=e,r.$template=n,r.nodes={},r.nodeNames=[],r._addFooterNode(),r._log=u(r),r}return ae.inherits(t,e),ae.createClass(t,[{key:"_addFooterNode",value:function(){this._footerNode=this._createNode("footer"),this.$list.append(this._footerNode.html),this._footerNode.html.addClass("footer")}},{key:"setFooterNodeText",value:function(e){this._footerNode.content.text(e)}},{key:"add",value:function(e){return this.insert(this.nodeNames.length,e)}},{key:"insert",value:function(e,t){var n=t.toLowerCase();if(!(n in this.nodes)){if(0>e||e>this.nodeNames.length)throw"invalid index: "+e+"/"+this.nodeNames.length;var r=this._createNode(t);return this._insertHTML(e,r),this.nodes[n]=r,this.nodeNames.splice(e,0,t)}}},{key:"_insertHTML",value:function(e,t){var n=this.get(e)||this._footerNode;this._log("adding",t,"at",e,"with next node",n),t.html.insertBefore(n.html)}},{key:"get",value:function(e){var t=this.nodeNames[e];return t?(t=t.toLowerCase(),this.nodes[t]):!1}},{key:"getPrevious",value:function(e){var t=this.nodeNames.indexOf(e);return this.nodeNames[t-1]}},{key:"getNext",value:function(e){var t=this.nodeNames.indexOf(e);return this.nodeNames[t+1]}},{key:"remove",value:function(e){var t=e.toLowerCase(),n=this.nodes[t];return this._log("removing",n),n?(n.html.remove(),delete this.nodes[t],y(this.nodeNames,t)):void 0}},{key:"clear",value:function(){this.nodes={},this.nodeNames=[],this.$list.find("li:not(.footer)").remove()}},{key:"addClass",value:function(e,t){var n;return null!=(n=this.nodes[e])?n.html.addClass(t):void 0}},{key:"removeClass",value:function(e,t){var n;return null!=(n=this.nodes[e])?n.html.removeClass(t):void 0}},{key:"hasClass",value:function(e,t){var n;return null!=(n=this.nodes[e])?n.html.hasClass(t):void 0}},{key:"rename",value:function(e,t){var n;return null!=(n=this.nodes[e])?n.content.text(t):void 0}},{key:"_createNode",value:function(e){var t=this,n={html:this._htmlify(e),name:e};return n.content=$(".content-item",n.html),n.html.mousedown(function(e){switch(e.which){case 1:$(e.target).hasClass("remove-button")?t._emitClickEvent(n,"remove_button_clicked"):t._handleClick(n);break;case 2:return t._handleMiddleClick(n)}}),n.html.dblclick(function(e){return 1==e.which?t._handleDoubleClick(n):void 0}),n}},{key:"_handleClick",value:function(e){this._emitClickEvent(e,"clicked")}},{key:"_handleMiddleClick",value:function(e){this._emitClickEvent(e,"midclicked")}},{key:"_handleDoubleClick",value:function(e){this._emitClickEvent(e,"dblclicked")}},{key:"_emitClickEvent",value:function(e,t){var n;n=e==this._footerNode?"footer_"+t:t,this.emit(n,e.name)}},{key:"_htmlify",value:function(e){var t=this.$template.clone();return $(".content-item",t).text(e),t}}]),t}(fe),Ze=function(e){function t(){ae.classCallCheck(this,t);var e=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e._handleClick=e._handleClick.bind(e),e._handleMiddleClick=e._handleMiddleClick.bind(e),e.$surface=$("#rooms-container .rooms"),e.roomsByServer={},e._addFooter(),e}return ae.inherits(t,e),ae.createClass(t,[{key:"_addFooter",value:function(){var e=this;this._footerHtml=this._createAndAppendServerHTML("+ add server");var t=$(".server",this._footerHtml);t.addClass("footer"),t.mousedown(function(t){1==t.which&&e._handleAddServerClick()})}},{key:"select",value:function(e,t){return this._removeLastSelected(),this._addClass(e,t,"selected"),this._addClass(e,null,"current-server"),this._removeClass(e,t,"activity"),this._removeClass(e,t,"mention")}},{key:"_removeLastSelected",value:function(){this.removeFirstInstanceOfClass("selected"),this.removeFirstInstanceOfClass("current-server")}},{key:"removeFirstInstanceOfClass",value:function(e){var t=$("."+e,this.$surface);t&&t.removeClass(e)}},{key:"activity",value:function(e,t){return this._addClass(e,t,"activity")}},{key:"mention",value:function(e,t){return this._addClass(e,t,"mention")}},{key:"remove",value:function(e,t){return null!=t?this.roomsByServer[e].channels.remove(t):(this.roomsByServer[e].html.remove(),delete this.roomsByServer[e])}},{key:"insertChannel",value:function(e,t,n){return this.roomsByServer[t].channels.insert(e,n),this.disconnect(t,n)}},{key:"addAlwaysEmptyServer",value:function(e){this.addServer(e),this._addClass(e,null,"always-empty")}},{key:"addServer",value:function(e){var t,n,r;return n=this._createAndAppendServerHTML(e),r=$(".server",n),t=this._createChannelList(n),this._handleMouseEvents(e,r,t),this.roomsByServer[e.toLowerCase()]={html:n,server:r,channels:t},this.disconnect(e)}},{key:"_createAndAppendServerHTML",value:function(e){var t;return t=$("#templates .server-channels").clone(),$(".server .content-item",t).text(e),this._footerHtml?t.insertBefore(this._footerHtml):this.$surface.append(t),t}},{key:"_createChannelList",value:function(e){var t,n;return n=$("#templates .channel"),t=new Qe($(".channels",e),n),t.setFooterNodeText("+ add channel"),t}},{key:"_handleMouseEvents",value:function(e,t,n){var r=this;t.mousedown(function(t){1==t.which&&($(t.target).hasClass("remove-button")?r._handleRemoveRoom(e):r._handleClick(e))}),n.on("clicked",function(t){return r._handleClick(e,t)}),n.on("midclicked",function(t){return r._handleMiddleClick(e,t)}),n.on("footer_clicked",function(){return r._handleAddChannelClick()}),n.on("remove_button_clicked",function(t){return r._handleRemoveRoom(e,t)})}},{key:"disconnect",value:function(e,t){return this._addClass(e,t,"disconnected")}},{key:"connect",value:function(e,t){return this._removeClass(e,t,"disconnected")}},{key:"_addClass",value:function(e,t,n){return null!=t?this.roomsByServer[e].channels.addClass(t.toLowerCase(),n):this.roomsByServer[e].server.addClass(n)}},{key:"_removeClass",value:function(e,t,n){return null!=t?this.roomsByServer[e].channels.removeClass(t.toLowerCase(),n):this.roomsByServer[e].server.removeClass(n)}},{key:"_handleClick",value:function(e,t){return this.emit("clicked",e,t)}},{key:"_handleMiddleClick",value:function(e,t){return this.emit("midclicked",e,t)}},{key:"_handleAddChannelClick",value:function(){this.emit("help_type_command","/join #")}},{key:"_handleAddServerClick",value:function(){this.emit("help_type_command","/server ")}},{key:"_handleRemoveRoom",value:function(e,t){this.emit("remove_button_clicked",e,t)}}]),t}(fe),et=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n._channel=e,n._size=0,n._notification=null,n._stubs=[],n}return ae.inherits(t,e),ae.createClass(t,[{key:"add",value:function(e){var t;return null!=(t=this._notification)&&t.cancel(),this._size++,this._createNotification(e),this._notification.show()}},{key:"_createNotification",value:function(e){var t,n;return this._addStubIfUnique(e.getStub()),1===this._size?(n=e.getTitle(),t=e.getBody()):(n=this._channel?this._size+" notifications in "+this._channel:this._size+" notifications",t=this._stubs.join(", ")),t=_(t,75),this._notification=new _e(n,t),this._addNotificationListeners()}},{key:"_addStubIfUnique",value:function(e){return this._stubs.indexOf(e)<0?this._stubs.push(e):void 0}},{key:"_addNotificationListeners",value:function(){var e=this;return this._notification.on("clicked",function(){return e.emit("clicked")}),this._notification.on("close",function(){return e._clear()})}},{key:"clear",value:function(){var e;return null!=(e=this._notification)&&e.cancel(),this._size=0,this._stubs=[]}}]),t}(fe),tt=function(){function e(t){ae.classCallCheck(this,e),this._postMessage=t,this._commands={}}return ae.createClass(e,[{key:"render",value:function(e){return this._commands=e,this._postMessage(),this._printCommands(),this._postMessage(t("Type '/help <command>' to see details about a specific command."),"notice help"),this._postMessage("Type '/hotkeys' to see the list of keyboard shortcuts.","notice help")}},{key:"_printCommands",value:function(){var t=this;return this._groupCommandsByCategory().map(function(n){return t._postMessage(t._getCommandGroupName(n.category)+" Commands:",e.COMMAND_STYLE),
t._postMessage(),t._printCommandGroup(n.commands.sort()),t._postMessage()})}},{key:"_getMaxCommandLength",value:function(){return Object.keys(this._commands).reduce(function(e,t){return t.length>e?t.length:e},0)}},{key:"_groupCommandsByCategory",value:function(){var e=me(this._commands).pairs().reduce(function(e,t){var n=ae.slicedToArray(t,2),r=n[0],i=n[1];if("hidden"===i.category)return e;var o=i.category||"misc";return null==e[o]&&(e[o]=[]),e[o].push(r),e},{});return this._orderGroups(e)}},{key:"_orderGroups",value:function(t){return e.CATEGORY_ORDER.map(function(e){return{category:e,commands:t[e]}})}},{key:"_getCommandGroupName",value:function(e){switch(e){case"common":return"Basic IRC";case"uncommon":return"Other IRC";case"one_identity":return"One Identity";case"scripts":return"Script";default:return"Misc"}}},{key:"_printCommandGroup",value:function(t){var n=t.map(function(e){return'<span class="help-command">'+e+"</span>"}).join("");this._postMessage(n,e.COMMAND_STYLE)}},{key:"renderHotkeys",value:function(e){var t,n,r,i,o;this._postMessage(),this._postMessage("Keyboard Shortcuts:","notice help"),this._postMessage(),t={},o=[];for(r in e){if(n=e[r],n.group){if(n.group in t)continue;t[n.group]=!0,i=n.group}else i=n.readableName;o.push(this._postMessage("  "+i+": "+n.description,"notice help"))}return o}}]),e}();tt.TOTAL_WIDTH=50,tt.CATEGORY_ORDER=["common","uncommon","one_identity","scripts","misc"],tt.COMMAND_STYLE="notice help group";var nt=function(){function e(t){ae.classCallCheck(this,e),this.win=t,this.systemMessage=this.systemMessage.bind(this),this._userSawMostRecentMessage=!1,this._activityMarkerLocation=void 0,this._helpMessageRenderer=new tt(this.systemMessage)}return ae.createClass(e,[{key:"onFocus",value:function(){return this._userSawMostRecentMessage=this.win.$messages.children().length>0}},{key:"displayWelcome",value:function(){return this.systemMessage("Welcome to CIRC!"),this.systemMessage(this._getWebsiteBlurb())}},{key:"displayHelp",value:function(e){return this._helpMessageRenderer.render(e)}},{key:"displayHotkeys",value:function(e){return this._helpMessageRenderer.renderHotkeys(e)}},{key:"displayAbout",value:function(){return this._addWhitespace(),this.systemMessage("CIRC is a packaged Chrome app developed by Google Inc. "+this._getWebsiteBlurb(),"notice about"),this.systemMessage("Version: "+Re,"notice about"),this.systemMessage("Contributors:","notice about group"),this.systemMessage("    * Icon by Michael Cook (themichaelcook@gmail.com)","notice about group"),this.systemMessage("    * UI mocks by Fravic Fernando (fravicf@gmail.com)","notice about group")}},{key:"_getWebsiteBlurb",value:function(){return"Documentation, issues and source code live at "+xe+"."}},{key:"message",value:function(e,t){e=e||"",t=t||"";for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o=r[0]&&-1!=r[0].split(" ").indexOf("help"),s=this._createSourceFromText(e),a=this._createContentFromText(t,o);return this.rawMessage(s,a,r.join(" ")),this._shouldUpdateActivityMarker()?this._updateActivityMarker():void 0}},{key:"_createContentFromText",value:function(e,t){if(!e)return"";var n=$("<span>");return n.html(ce(e,t)),n}},{key:"_createSourceFromText",value:function(e){var t;return e?(t=$("<span>"),t.text(e),t):""}},{key:"systemMessage",value:function(e,t){return null==e&&(e=""),null==t&&(t="system"),this.message("",e,t)}},{key:"rawMessage",value:function(e,t,n){var r=this._createMessageHTML(e,t,n);return this.win.emit("message",this.win.getContext(),n,r[0].outerHTML),this.win.$messages.append(r),this.win.$messagesContainer.restoreScrollPosition(),this._trimMessagesIfTooMany()}},{key:"_createTimestamp",value:function(){return new Date}},{key:"_createMessageHTML",value:function(e,t,n){var r=$("#templates .message").clone();return r.addClass(n),$(".timestamp",r).append(this._createTimestamp().toLocaleTimeString()),$(".source",r).append(e),$(".content",r).append(t),("function"==typeof e.text?e.text():void 0)||$(".source",r).addClass("empty"),"function"==typeof e.text&&$(".source",r).attr("colornumber",N(e.text().toLocaleLowerCase())%31),r}},{key:"_trimMessagesIfTooMany",value:function(){var t=this.win.$messagesContainer.children().children();if(t.length>e.MAX_MESSAGES)return t.map(function(e){return e.remove()})}},{key:"_addWhitespace",value:function(){return this.message()}},{key:"_shouldUpdateActivityMarker",value:function(){return!this.win.isFocused()&&this._userSawMostRecentMessage}},{key:"_updateActivityMarker",value:function(){return this._userSawMostRecentMessage=!1,this._activityMarkerLocation&&this._activityMarkerLocation.removeClass("activity-marker"),this._activityMarkerLocation=this.win.$messages.children().last(),this._activityMarkerLocation.addClass("activity-marker")}}]),e}();nt.MAX_MESSAGES=3500;var rt=function(){function e(t){ae.classCallCheck(this,e),this._onScroll=this._onScroll.bind(this),this._restoreScrollPosition=this._restoreScrollPosition.bind(this),this._node=t,t.restoreScrollPosition=this._restoreScrollPosition,this._scrollPosition=0,this._wasScrolledDown=!0,$(window).resize(this._restoreScrollPosition),$(t).scroll(this._onScroll)}return ae.createClass(e,[{key:"node",value:function(){return this._node}},{key:"_restoreScrollPosition",value:function(){return this._wasScrolledDown?this._scrollToBottom():this._node.scrollTop(this._scrollPosition)}},{key:"_scrollToBottom",value:function(){return this._node.scrollTop(this._getScrollHeight())}},{key:"_onScroll",value:function(){return this._wasScrolledDown=this._isScrolledDown(),this._scrollPosition=this._node.scrollTop()}},{key:"_isScrolledDown",value:function(){var t;return t=this._node.scrollTop()+this._node.height(),t>=this._getScrollHeight()-e.SCROLLED_DOWN_BUFFER}},{key:"_getScrollHeight",value:function(){return this._node[0].scrollHeight}}]),e}();rt.SCROLLED_DOWN_BUFFER=8;var it=function(e){function t(e){return ae.classCallCheck(this,t),ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,$("#templates .nick")))}return ae.inherits(t,e),ae.createClass(t,[{key:"add",value:function(e){return this.insert(this._getClosestIndex(e),e)}},{key:"_getClosestIndex",value:function(e){e=e.toLowerCase();for(var t=0,n=this.nodeNames.length;n>t;++t){var r=this.nodeNames[t];if(r.toLowerCase()>e)return t}return this.nodeNames.length}}]),t}(Qe),ot=function(e){function t(e,n){ae.classCallCheck(this,t);var r=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));r._onBlur=r._onBlur.bind(r),r._onFocus=r._onFocus.bind(r),r.name=e+(n?" "+n:""),r.messageRenderer=new nt(r),r._addUI(),r.notifications=new et(n),r._isVisible=!1,r._isFocused=!1,r._height=0,r._private=!1,$(window).focus(r._onFocus),$(window).blur(r._onBlur);var i;return $(".dragbar").mousedown(function(e){e.preventDefault(),i=!0;var t=$("#messages-and-input"),n=$("<div>",{id:"ghostbar",css:{height:t.outerHeight(),top:t.offset().top,left:t.offset().left-4}}).appendTo("body");$(document).mousemove(function(e){n.css("left",e.pageX)})}),$(document).mouseup(function(e){i&&($("#rooms-and-nicks").css("width",e.pageX),$("#ghostbar").remove(),$(document).unbind("mousemove"),i=!1)}),r}return ae.inherits(t,e),ae.createClass(t,[{key:"getContext",value:function(){return null==this._context&&(this._context=new Te(null!=this.conn?this.conn.name:void 0,this.target)),this._context}},{key:"_onFocus",value:function(){return this._isVisible?(this._isFocused=!0,this.notifications.clear(),this.messageRenderer.onFocus()):void 0}},{key:"_onBlur",value:function(){return this._isFocused=!1}},{key:"isFocused",value:function(){return this._isFocused&&this._isVisible}},{key:"_addUI",value:function(){return this._addMessageUI(),this._addNickUI(),this.$roomsAndNicks=$("#rooms-and-nicks")}},{key:"_addMessageUI",value:function(){return this.$messagesContainer=new rt($("#messages-container")).node(),this.$messages=$("#templates .messages").clone()}},{key:"_addNickUI",value:function(){return this.$nicksContainer=$("#nicks-container"),this.$nicks=$("#templates .nicks").clone(),this.nicks=new it(this.$nicks)}},{key:"setTarget",value:function(e){return this.target=e,this.isPrivate()?void 0:this.$roomsAndNicks.removeClass("no-nicks")}},{key:"isServerWindow",value:function(){return!this.target}},{key:"equals",value:function(e){return this.name===e.name}},{key:"makePrivate",value:function(){return this._private=!0}},{key:"isPrivate",value:function(){return this._private}},{key:"detach",value:function(){return this.$roomsAndNicks.addClass("no-nicks"),this.$messages.detach(),this.$nicks.detach(),this._isVisible=!1}},{key:"remove",value:function(){return this.detach(),this.$messages.remove(),this.$nicks.remove()}},{key:"attach",value:function(){return this._isVisible=!0,this._onFocus(),this.target&&!this.isPrivate()&&this.$roomsAndNicks.removeClass("no-nicks"),this.$messagesContainer.append(this.$messages),this.$nicksContainer.append(this.$nicks),this.$messagesContainer.restoreScrollPosition()}},{key:"message",value:function(){var e;return(e=this.messageRenderer).message.apply(e,arguments)}},{key:"rawMessage",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];return this.messageRenderer.rawMessage(e,t,r.join(" "))}},{key:"rawHTML",value:function(e){return this.$messages.html(this.$messages.html()+e),this.$messagesContainer.restoreScrollPosition()}},{key:"clear",value:function(){return this.$messages.html("")}}]),t}(fe),st=function(e){function t(e,n){ae.classCallCheck(this,t);var r=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return r._handleIRCEvent=r._handleIRCEvent.bind(r),r._messageDisplayer=e,r._steps=["start","server","channel","end"],r._findWalkthroughPoisition(n),r._beginWalkthrough(),r}return ae.inherits(t,e),ae.createClass(t,[{key:"_findWalkthroughPoisition",value:function(e){return e.channelsLoaded?this._currentStep=3:e.serversLoaded?this._currentStep=2:e.nickLoaded?this._currentStep=1:this._currentStep=0,this._startingStep=this._currentStep}},{key:"_beginWalkthrough",value:function(){var e;return e=this._steps[this._currentStep],"end"===e?void this.emit("tear_down"):"channel"===e?void this._currentStep--:this._displayStep(e)}},{key:"listenToIRCEvents",value:function(e){return e.on("server",this._handleIRCEvent)}},{key:"_handleIRCEvent",value:function(e){switch(this._context=e.context,e.name){case"nick":return this._displayWalkthrough("server");case"connect":return this._displayWalkthrough("channel");case"joined":return this._displayWalkthrough("end")}}},{key:"_displayWalkthrough",value:function(e){var t;return t=this._steps.indexOf(e),t>this._currentStep?(this._currentStep=t,this._displayStep(e)):void 0}},{key:"_displayStep",value:function(e){return this["_"+e+"Walkthrough"](this._context||this._messageDisplayer.getCurrentContext())}},{key:"_isFirstMessage",value:function(){return this._currentStep===this._startingStep}},{key:"_message",value:function(e,t){var n=this._messageDisplayer.getCurrentContext();return t=t||"system",this._messageDisplayer.displayMessage(t,n,e)}},{key:"_startWalkthrough",value:function(){return this._message("To get started, set your nickname with /nick <my_nick>.")}},{key:"_serverWalkthrough",value:function(){return this._isFirstMessage()?this._message("Join a server by typing /server <server> [port]."):this._message("Great! Now join a server by typing /server <server> [port]."),this._message("For example, you can connect to freenode by typing /server chat.freenode.net.")}},{key:"_channelWalkthrough",value:function(e){var n=this;return setTimeout(function(){return n._displayChannelWalkthough(e)},t.SERVER_OUTPUT_DELAY)}},{key:"_displayChannelWalkthough",value:function(e){return this._message("You've successfully connected to "+e.server+"."),this._message("Join a channel with /join <#channel>.")}},{key:"_endWalkthrough",value:function(e){return this._isFirstMessage()||this._message("Awesome, you've connected to "+e.channel+"."),this._message("If you're ever stuck, type /help to see a list of all commands."),this._message("You can switch windows with alt+[0-9] or click in the channel list on the left."),this.emit("tear_down")}}]),t}(fe);st.SERVER_OUTPUT_DELAY=1e3;var at=function(e){function t(e){ae.classCallCheck(this,t);var n=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n._restoreScripts=n._restoreScripts.bind(n),n._onChanged=n._onChanged.bind(n),n._chat=e,n._log=u(n),n._scripts=[],n._channels=[],n._servers=[],n._nick=void 0,n._autostart=void 0,n.password=void 0,n.serverDevice=void 0,chrome.storage.onChanged.addListener(n._onChanged),n.pause(),n}return ae.inherits(t,e),ae.createClass(t,[{key:"saveItemForScript",value:function(e,t){return this._store(this._getScriptStorageHandle(e),t)}},{key:"loadItemForScript",value:function(e,t){var n=this._getScriptStorageHandle(e);return chrome.storage.sync.get(n,function(e){return t(e[n])})}},{key:"clearScriptStorage",value:function(e){return chrome.storage.sync.remove(this._getScriptStorageHandle(e))}},{key:"_getScriptStorageHandle",value:function(e){return"script_"+e}},{key:"_onChanged",value:function(e){var t=this;return e.password&&this._onPasswordChange(e.password),e.server_device&&this._onServerDeviceChange(e.server_device),this._scripts.map(function(n){var r=e[t._getScriptStorageHandle(n.getName())];return r?t._chat.scriptHandler.storageChanged(n,r):void 0})}},{key:"_onPasswordChange",value:function(e){return this._log("password changed from",e.oldValue,"to",e.newValue),e.newValue!==this.password?e.newValue?(this.password=e.newValue,this._chat.setPassword(this.password)):(this._log("password was cleared. Setting password back to",this.password),this._store("password",this.password)):void 0}},{key:"_onServerDeviceChange",value:function(e){return this._log("device server changed from",a(e,["oldValue","addr"]),a(e,["oldValue","port"]),"to",a(e,["newValue","addr"]),a(e,["newValue","port"])),e.newValue?(this.serverDevice=e.newValue,this._chat.remoteConnectionHandler.determineConnection(this.serverDevice)):this.serverDevice?this._store("server_device",this.serverDevice):void 0}},{key:"pause",value:function(){return this._paused=!0}},{key:"resume",value:function(){return this._paused=!1}},{key:"setAutostart",value:function(e){var t;return t=null!=e?e:!this._autostart,this._autostart=t,this._store("autostart",t),this._autostart}},{key:"finishedWalkthrough",value:function(){return this._store("completed_walkthrough",!0,"local")}},{key:"finishedLoadingPrepackagedScripts",value:function(){return this._store("loaded_prepackaged_scripts",!0,"local")}},{key:"nickChanged",value:function(e){return this._nick!==e?(this._nick=e,this._store("nick",e)):void 0}},{key:"channelJoined",value:function(e,t,n,r){var i,o,s,a,c,u;for(n=n||"normal",u=this._channels,s=a=0,c=u.length;c>a;s=++a)if(i=u[s],i.server===e&&i.name===t){if(i.key!==r){this._channels.splice(s,1);break}return}return o={server:e,name:t,key:r},"normal"!==n&&(o.type=n),this._channels.push(o),this._store("channels",this._channels)}},{key:"serverJoined",value:function(e,t,n){return this._isDuplicateServer(e,t)?void 0:(this._servers.push({name:e,port:t,password:n}),this._store("servers",this._servers))}},{key:"_isDuplicateServer",value:function(e,t){var n=this;return this._servers.some(function(r,i){return r.name===e?r.port===t?!0:(n._servers.splice(i,1),!1):void 0})}},{key:"parted",value:function(e,t){return null!=t?this._channelParted(e,t):this._serverParted(e)}},{key:"_channelParted",value:function(e,t){var n=this._channels.findIndex(function(n){return n.server===e&&n.name.toLowerCase()===t.toLowerCase()});return this._channels.splice(n,1),this._store("channels",this._channels)}},{key:"_serverParted",value:function(e){var t=this._servers.findIndex(function(t){return t.name===e});return t>=0?(this._servers.splice(t,1),this._store("servers",this._servers)):void 0}},{key:"ignoredMessagesChanged",value:function(){return this._store("ignored_messages",this._getIgnoredMessages())}},{key:"_getIgnoredMessages",value:function(){return this._chat.messageHandler.getIgnoredMessages()}},{key:"scriptAdded",value:function(e){return this._isDuplicateScript(e)?void 0:(this._scripts.push(e),this._store("scripts",this._scripts,"local"))}},{key:"scriptRemoved",value:function(e){var t=this._scripts.findIndex(function(t){return t.id===e.id});t>=0&&(this._scripts.splice(t,1),this._store("scripts",this._scripts,"local"))}},{key:"_isDuplicateScript",value:function(e){return this._scripts.some(function(t){return t.id===e.id})}},{key:"_store",value:function(e,t,n){var r;return n=n||"sync",this.shouldStore(e)?(this._log("storing",e,"=>",t,"to",n),r={},r[e]=t,"sync"===n?chrome.storage.sync.set(r):chrome.storage.local.set(r)):void 0}},{key:"shouldStore",value:function(e){return!(this._paused&&t.STATE_ITEMS.indexOf(e)>=0)}},{key:"getState",value:function(){return{ircStates:this._createIRCStates(),servers:this._servers,channels:this._channels,nick:this._nick,ignoredMessages:this._getIgnoredMessages()}}},{key:"_createIRCStates",value:function(){return me(this._chat.connections).values().map(function(e){return{server:e.name,state:e.irc.state,channels:e.irc.channels,away:e.irc.away,nick:e.irc.nick}})}},{key:"init",value:function(){var e=this;return chrome.storage.local.get(t.INITIAL_ITEMS_LOCAL,function(n){return e._initializeLocalItems(n),chrome.storage.sync.get(t.INITIAL_ITEMS,function(t){return e._initializeSyncItems(t),e.emit("initialized")})})}},{key:"_initializeSyncItems",value:function(e){return this._state=e,this._restorePassword(),this._loadServerDevice(),this._autostart=e.autostart}},{key:"_initializeLocalItems",value:function(e){return this.completedWalkthrough=e.completed_walkthrough,this.loadedPrepackagedScripts=e.loaded_prepackaged_scripts,this._restoreScripts(e)}},{key:"_restoreScripts",value:function(e){var t=this;if(e.scripts)return this._log(e.scripts.length,"scripts loaded from storage:",e.scripts),Ge.loadScriptsFromStorage(e.scripts,function(e){return t._scripts.push(e),t._chat.scriptHandler.addScript(e)})}},{key:"restoreSavedState",value:function(e){var n=this;return chrome.storage.sync.get(t.STATE_ITEMS,function(t){return n.loadState(t),"function"==typeof e?e():void 0})}},{key:"loadState",value:function(e){return this._state=e,this._restoreNick(),this._restoreServers(),this._restoreChannels(),this._restoreIgnoredMessages(),this._restoreIRCStates(),this._markItemsAsLoaded(t.STATE_ITEMS,e)}},{key:"_restorePassword",value:function(){return this.password=this._state.password,this.password?this._log("password loaded from storage:",this.password):(this.password=x(),this._log("no password found, setting new password to",this.password),this._store("password",this.password)),this._chat.setPassword(this.password),this._chat.remoteConnectionHandler.determineConnection()}},{key:"_restoreServers",value:function(){var e=this,t=this._state.servers;return t?(this._servers=t,t.map(function(t){return e._chat.connect(t.name,t.port,t.password)})):void 0}},{key:"_restoreChannels",value:function(){var e=this,t=this._state.channels;return t?(this._channels=t,t.reduce(function(t,n){var r=e._chat.connections[n.server];return r?("private"===n.type?t.push(e._chat.createPrivateMessageWindow(r,n.name)):t.push(e._chat.join(r,n.name,n.key)),t):t},[])):void 0}},{key:"_restoreIgnoredMessages",value:function(){var e=this._state.ignored_messages;if(e)return this._log("restoring ignored messages from storage:",e),this._chat.messageHandler.setIgnoredMessages(e)}},{key:"_restoreNick",value:function(){var e=this._state.nick;if(e&&"string"==typeof e)return this._nick=e,this._chat.setNick(e)}},{key:"_restoreIRCStates",value:function(){var e,t=this,n=this._state.ircStates;return n?(e=n.map(function(e){var n=t._chat.connections[e.server];return n&&t._setIRCState(n,e),e.server}),this._disconnectServersWithNoState(e)):void 0}},{key:"_disconnectServersWithNoState",value:function(e){return me(this._chat.connections).pairs().filter(function(t){var n=ae.slicedToArray(t,1),r=n[0];return e.indexOf(r)<0}).each(function(e){var t=ae.slicedToArray(e,2),n=t[1];return n.irc.state="disconnected"})}},{key:"_getNicksInChannel",value:function(e){return me(e.names).values()}},{key:"_setIRCState",value:function(e,t){var n=this;return"connected"===t.state&&this._chat.onConnected(e),t.state&&(e.irc.state=t.state),t.away&&(e.irc.away=t.away),t.channels&&(e.irc.channels=t.channels),e.irc.nick=t.nick,t.channels?me(t.channels).pairs().each(function(t){var r=ae.slicedToArray(t,2),i=r[0],o=r[1];return n._chat.onJoined(e,i),n._chat.onNames({context:{server:e.name,channel:i}},n._getNicksInChannel(o))}):void 0}},{key:"_loadServerDevice",value:function(){return this.loadedServerDevice=!0,this.serverDevice=this._state.server_device,this.serverDevice||this._log("no remote server found",this._state),this.serverDevice&&this._log("loaded server device",this.serverDevice),this._chat.remoteConnectionHandler.determineConnection()}},{key:"_markItemsAsLoaded",value:function(e,t){var n=this;return e.map(function(e){return n[e+"Loaded"]=null!=t[e]})}},{key:"becomeServerDevice",value:function(e){return this.serverDevice={addr:e.addr,port:e.port},this._store("server_device",this.serverDevice)}}]),t}(fe);at.STATE_ITEMS=["nick","servers","channels","ignored_messages"],at.INITIAL_ITEMS=["password","server_device","autostart"],at.INITIAL_ITEMS_LOCAL=["completed_walkthrough","scripts","loaded_prepackaged_scripts"];var ct=function(){function e(){ae.classCallCheck(this,e)}return ae.createClass(e,[{key:"toKeyCode",value:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];var i=n.map(function(t){return e._charToKeyCode[t]});return n.length<2?i[0]:i}}]),e}();ct.prototype._charToKeyCode={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CONTROL:17,ALT:18,CAPSLOCK:20,ESCAPE:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:110,F10:121,F11:122,F12:123,"[":119,"]":121,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"\\":220,"'":222};var ut=new ct,ht=function(){function e(){ae.classCallCheck(this,e),this._hotkeyMap={},this._mapHotkeys()}return ae.createClass(e,[{key:"getMap",value:function(){return this._hotkeyMap}},{key:"getMappedCommand",value:function(t,n){var r,i,o;return this._isValidShortcut(t,n)?(o=e.getKeyCombination(t),this._isMapped(o)?(i=this._hotkeyMap[o].command,r=this._hotkeyMap[o].args,[i,r]):[]):[]}},{key:"_isValidShortcut",value:function(t,n){var r=t.which;return t.metaKey||t.ctrlKey||t.altKey?!0:e.NO_MODIFIER_HOTKEYS.indexOf(r)>=0?!0:!n&&e.NO_INPUT_HOTKEYS.indexOf(r)>=0}},{key:"_isMapped",value:function(e){return e in this._hotkeyMap}},{key:"_mapHotkeys",value:function(){for(var e=this,t=1;9>=t;t+=1)this._addHotkey("Ctrl-"+t,{command:"win",group:"Ctrl-#",description:"switch channels",args:[t]});var n=["Alt-DOWN","Ctrl-TAB","Alt-PAGEDOWN"],r=["Alt-UP","Ctrl-Shift-TAB","Alt-PAGEUP"];return n.forEach(function(t){return e._addHotkey(t,{command:"next-room"})}),r.forEach(function(t){return e._addHotkey(t,{command:"previous-room"})}),this._addHotkey("Ctrl-W",{command:"part",description:"close current channel/private chat"}),this._addHotkey("Alt-S",{command:"next-server"}),this._addHotkey("TAB",{command:"reply",description:"autocomplete or reply to last mention"})}},{key:"_addHotkey",value:function(e,t){var n=this._getHotkeyCode(e);return null==t.args&&(t.args=[]),this._hotkeyMap[n]=t,this._hotkeyMap[n].readableName=e,t.description?this._hotkeyMap[n].description=t.description:this._hotkeyMap[n].description=t.command.replace(/-/g," ")}},{key:"_getHotkeyCode",value:function(e){var t,n;return n=e.split("-"),t=n[n.length-1],n[n.length-1]=ut.toKeyCode(t),n.join("-")}}]),e}();ht.getKeyCombination=function(e){var t=[];return e.ctrlKey&&t.push("Ctrl"),e.metaKey&&t.push("Meta"),e.altKey&&t.push("Alt"),e.shiftKey&&t.push("Shift"),t.push(e.which),t.join("-")},ht.NO_MODIFIER_HOTKEYS=ut.toKeyCode("PAGEUP","PAGEDOWN","CAPSLOCK","INSERT","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"),ht.NO_INPUT_HOTKEYS=[ut.toKeyCode("TAB")];var lt=function(e){function t(e,n){ae.classCallCheck(this,t);var r=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return r._listenOnValidPort=r._listenOnValidPort.bind(r),r._onReceive=r._onReceive.bind(r),r._onReceiveError=r._onReceiveError.bind(r),r._receivedMessages="",r.id=e,r._isClient=!1,"string"==typeof e?r._initFromAddress(e,n):e?r._initFromSocketId(e):r.port=t.FINDING_PORT,r}return ae.inherits(t,e),ae.createClass(t,[{key:"equals",value:function(e){return this.id===(null!=e?e.id:void 0)}},{key:"usesConnection",value:function(e){return e.addr===this.addr&&e.port===this.port}},{key:"getState",value:function(){if(!this.addr)return"no_addr";switch(this.port){case t.FINDING_PORT:return"finding_port";case t.NO_PORT:return"no_port";default:return"found_port"}}},{key:"_initFromAddress",value:function(e,t){this.addr=e,this.port=t}},{key:"_initFromSocketId",value:function(e){return this._socketId=e,this._isClient=!0,this._listenForData()}},{key:"findPossibleAddrs",value:function(e){var t=this;return chrome.system.network.getNetworkInterfaces(function(n){return t.possibleAddrs=n.map(function(e){return e.address}),t.addr=t._getValidAddr(t.possibleAddrs),e()})}},{key:"_getValidAddr",value:function(e){return e&&0!==e.length?e.reduce(function(e,t){return t.length<e.length?t:e}):void 0}},{key:"hasGetNetworkInterfacesSupport",value:function(){return q()?!0:(this._log("w","chrome.system.network.getNetworkInterfaces is not supported!"),this.possibleAddrs=[],this.port=t.NO_PORT,!1)}},{key:"searchForAddress",value:function(e,t){var n=this;return null==t&&(t=500),this.hasGetNetworkInterfacesSupport()?(t>6e4&&(t=6e4),setTimeout(function(){return n.findPossibleAddrs(function(){return n.addr?e():n.searchForAddress(e,t*=1.2)})},t)):void 0}},{key:"listenForNewDevices",value:function(e){var t,n=this;return null!=(t=chrome.sockets.tcpServer)?t.create({},function(t){return n._socketId=t.socketId,S(t.socketId),H()?n._listenOnValidPort(e):void 0}):void 0}},{key:"_listenOnValidPort",value:function(e,n){var r=this;return n>=0||(n=t.BASE_PORT),chrome.sockets.tcpServer.listen(this._socketId,"0.0.0.0",n,function(t){return r._onListen(e,n,t)})}},{key:"_onListen",value:function(e,t,n){return 0>n?this._onFailedToListen(e,t,n):(this.port=t,this.emit("found_port",this),this._acceptNewConnection(e),void 0)}},{key:"_onFailedToListen",value:function(e,n,r){return n-t.BASE_PORT>t.MAX_CONNECTION_ATTEMPTS?(this._log("w","Couldn't listen to 0.0.0.0 on any attempted ports",chrome.runtime.lastError.message+" (error "+-r+")"),this.port=t.NO_PORT,this.emit("no_port")):this._listenOnValidPort(e,n+Math.floor(100*Math.random()))}},{key:"_acceptNewConnection",value:function(e){var t=this;this._log("listening for new connections on port",this.port),chrome.sockets.tcpServer.onAccept.addListener(function(n){t._socketId==n.socketId&&t._onAccept(n,e)})}},{key:"_onAccept",value:function(e,n){this._log("Connected to a client device",this._socketId),w(e.clientSocketId);var r=new t(e.clientSocketId);r.getAddr(function(){return n(r)})}},{key:"getAddr",value:function(e){var t,n=this;return null!=(t=chrome.sockets.tcp)?t.getInfo(this._socketId,function(t){return n.addr=t.peerAddress,e()}):void 0}},{key:"send",value:function(e,t){var n=this;t&&(t=t.map(function(e){return e instanceof Uint8Array?Array.from(e):e}));var r=JSON.stringify({type:e,args:t});return r=r.length+"$"+r,D(r,function(r){var i;return null!=(i=chrome.sockets.tcp)?i.send(n._socketId,r,function(i){return i.resultCode<0||i.bytesSent!==r.byteLength?(n._log("w","closing b/c failed to send:",e,t,chrome.runtime.lastError.message+" (error "+-i.resultCode+")"),n.close()):n._log("sent",e,t)}):void 0})}},{key:"connect",value:function(e){var t=this,n=chrome.sockets.tcp;return this.close(),null!=n?n.create(function(r){t._socketId=r.socketId,t._isClient=!0,t._socketId||e(!1),n.setPaused(t._socketId,!0,function(){return null!=n?n.connect(t._socketId,t.addr,t.port,function(n){return t._onConnect(n,e)}):void 0})}):void 0}},{key:"_onConnect",value:function(e,t){return 0>e?(this._log("w","Couldn't connect to server",this.addr,"on port",this.port,"-",chrome.runtime.lastError+" (error "+-e+")"),t(!1)):(this._listenForData(),t(!0))}},{key:"close",value:function(){return this._socketId?(this._isClient?(chrome.sockets.tcp.onReceive.removeListener(this._onReceive),chrome.sockets.tcp.onReceiveError.removeListener(this._onReceiveError),w(this._socketId,!0),chrome.sockets.tcp.disconnect(this._socketId),chrome.sockets.tcp.close(this._socketId)):(S(this._socketId,!0),chrome.sockets.tcp.disconnect(this._socketId),chrome.sockets.tcp.close(this._socketId)),this._socketId=void 0,this.emit("closed",this)):void 0}},{key:"_onReceive",value:function(e){var t=this;e.socketId==this._socketId&&W(e.data,function(e){var n;return t._receivedMessages+=e,n=t._parseReceivedMessages(),n.map(function(e){return t._log.apply(t,["received",e.type].concat(ae.toConsumableArray(e.args))),t.emit.apply(t,[e.type,t].concat(ae.toConsumableArray(e.args)))})})}},{key:"_onReceiveError",value:function(e){e.socketId==this._socketId&&(this._log("w","bad read - closing socket: ","(error "+-e.resultCode+")"),this.emit("closed",this),this.close())}},{key:"_listenForData",value:function(){chrome.sockets.tcp.onReceive.addListener(this._onReceive),chrome.sockets.tcp.onReceiveError.addListener(this._onReceiveError),chrome.sockets.tcp.setPaused(this._socketId,!1,function(){})}},{key:"_parseReceivedMessages",value:function(e){var t,n,r;if(e=e||[],!this._receivedMessages)return e;if(this._receivedMessages.length&&!V(this._receivedMessages[0])&&this._log.apply(this,["received message doesn't begin with digit: ",this._receivedMessages]),r=this._receivedMessages.indexOf("$"),!(r>=0))return e;if(t=parseInt(this._receivedMessages.slice(0,+(r-1)+1||9e9)),!(this._receivedMessages.length>r+t))return e;n=this._receivedMessages.slice(r+1,+(r+t)+1||9e9);try{var i=JSON.parse(n);e.push(i),JSON.stringify(i).length!=t&&this._log("e","json length mismatch")}catch(o){this._log("e","failed to parse json: "+n)}return this._receivedMessages.length>r+t+1&&!V(this._receivedMessages[r+t+1])&&this._log("e","message after split doesn't begin with digit: "+this._receivedMessages),this._receivedMessages=this._receivedMessages.slice(r+t+1),this._parseReceivedMessages(e)}},{key:"toString",value:function(){return this.addr?this.addr+" on port "+this.port:""+this.socketId}}]),t}(fe);lt.getOwnDevice=function(e){var t=new lt;return t.hasGetNetworkInterfacesSupport()?(H()||(t.port=lt.NO_PORT),t.findPossibleAddrs(function(){return e(t)})):void e(t)},lt.BASE_PORT=1329,lt.MAX_CONNECTION_ATTEMPTS=30,lt.FINDING_PORT=-1,lt.NO_PORT=-2;var dt=function(e){function t(){var e;ae.classCallCheck(this,t);for(var n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];return ae.possibleConstructorReturn(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(r)))}return ae.inherits(t,e),ae.createClass(t,[{key:"setTimeout",value:function(){}},{key:"_active",value:function(){}}]),t}(Le),pt=function(e){function t(){return ae.classCallCheck(this,t),ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this))}return ae.inherits(t,e),ae.createClass(t,[{key:"_onConnect",value:function(e){var n=this;try{this.secure(function(r){0>r?(n.emit("error","Socket #"+n.socketId+" failed to upgrade to a secure connection with code "+e),n.close()):(ae.get(Object.getPrototypeOf(t.prototype),"_onConnect",n).call(n,e),console.info("Successfully secured the connection"))})}catch(r){this.emit("error","Socket #"+this.socketId+" failed to upgrade to a secure connection with code "+e),console.error(r.stack)}}},{
key:"secure",value:function(e){return this.socketId?void chrome.sockets.tcp.secure(this.socketId,e):(this.emit("error","Socket #"+this.socketId+" is not created. Failed to upgrade."),void e(-1))}}]),t}(Ue),ft=0,vt=function(e){function t(){ae.classCallCheck(this,t);var e=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e._onDeviceClosed=e._onDeviceClosed.bind(e),e._onConnectionMessage=e._onConnectionMessage.bind(e),e._onSocketData=e._onSocketData.bind(e),e._onUserInput=e._onUserInput.bind(e),e._authenticateDevice=e._authenticateDevice.bind(e),e._addUnauthenticatedDevice=e._addUnauthenticatedDevice.bind(e),e._onHasOwnDevice=e._onHasOwnDevice.bind(e),e._getAuthToken=e._getAuthToken.bind(e),e.serverDevice=void 0,e._connectingTo=void 0,e._type=void 0,e.devices=[],e._ircSocketMap={},e._thisDevice={},e._state="device_state",e._getIRCState=function(){},e._getChatLog=function(){},e}return ae.inherits(t,e),ae.createClass(t,[{key:"init",value:function(){return lt.getOwnDevice(this._onHasOwnDevice)}},{key:"setPassword",value:function(e){return this._password=e}},{key:"_getAuthToken",value:function(e){return K(this._password+e)}},{key:"getConnectionInfo",value:function(){return this._thisDevice}},{key:"getState",value:function(){return"device_state"===this._state?this._thisDevice.port?this._thisDevice.getState():"finding_port":this._state}},{key:"setIRCStateFetcher",value:function(e){return this._getIRCState=e}},{key:"setChatLogFetcher",value:function(e){return this._getChatLog=e}},{key:"_onHasOwnDevice",value:function(e){var t=this;return this._thisDevice=e,"no_addr"===this._thisDevice.getState()?(this._log("w","Wasn't able to find address of own device"),this.emit("no_addr"),void this._thisDevice.searchForAddress(function(){return t._onHasOwnDevice(t._thisDevice)})):(this.emit("found_addr"),this._thisDevice.listenForNewDevices(this._addUnauthenticatedDevice))}},{key:"_addUnauthenticatedDevice",value:function(e){return this._log("adding unauthenticated device",e.id),e.password=x(),e.send("authentication_offer",[e.password]),e.on("authenticate",this._authenticateDevice)}},{key:"_authenticateDevice",value:function(e,t){return t===this._getAuthToken(e.password)?this._addClientDevice(e):(this._log("w","AUTH FAILED",t,"should be",this._getAuthToken(e.password)),e.close())}},{key:"_addClientDevice",value:function(e){return this._log("auth passed, adding client device",e.id,e.addr),this._listenToDevice(e),this._addDevice(e),this.emit("client_joined",e),e.send("connection_message",["irc_state",this._getIRCState()]),e.send("connection_message",["chat_log",this._getChatLog()])}},{key:"_addDevice",value:function(e){return this.devices.forEach(function(t){t.addr===e.addr&&t.close()}),this.devices.push(e)}},{key:"_listenToDevice",value:function(e){var t=this;return e.on("user_input",this._onUserInput),e.on("socket_data",this._onSocketData),e.on("connection_message",this._onConnectionMessage),e.on("closed",this._onDeviceClosed),e.on("no_port",function(){return t.emit("no_port")})}},{key:"_onUserInput",value:function(e,t){return this.isServer()&&this._broadcast(e,"user_input",t),this.emit(t.type,Event.wrap(t))}},{key:"_onSocketData",value:function(e,t,n,r){var i;return"data"===n&&(r=U(r)),null!=(i=this._ircSocketMap[t])?i.emit(n,r):void 0}},{key:"_onConnectionMessage",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r,i=t[0],o=t[1],s=3<=t.length?t.slice(2):[];if("irc_state"!==o||(r=this._onIRCState(i,s)))return this.emit.apply(this,[o].concat(t))}},{key:"_onIRCState",value:function(e,t){return"connecting"!==this.getState()?(this._log("w","got IRC state, but we're not connecting to a server -",e.toString(),t),e.close(),!1):(this._setServerDevice(e),this._becomeClient(),!0)}},{key:"_setServerDevice",value:function(e){var t;return null!=(t=this.serverDevice)&&t.close(),this.serverDevice=e}},{key:"_onDeviceClosed",value:function(e){return this._deviceIsClient(e)&&this.emit("client_parted",e),this._deviceIsServer(e)&&"connected"===this.getState()?(this._log("w","lost connection to server -",e.addr),this._state="device_state",this._type=void 0,this.emit("server_disconnected")):e.equals(this._connectingTo)&&"connected"!==this.getState()&&this.emit("invalid_server"),this.devices=this.devices.filter(function(t){return t.id!==e.id}),this.devices}},{key:"_deviceIsServer",value:function(e){return null!=e?e.equals(this.serverDevice):void 0}},{key:"_deviceIsClient",value:function(e){return e.equals(this.serverDevice||e.equals(this._thisDevice))?!1:this.devices.some(function(t){return e.equals(t)})}},{key:"createSocket",value:function(e,t){var n;return this.isClient()?(n=new dt,this._ircSocketMap[e]=n):(n=t&&t.substr&&"+"===t.substr(0,1)?new pt:new Ue,this.broadcastSocketData(n,e)),n}},{key:"broadcastUserInput",value:function(e){var t=this;return e.on("command",function(e){var n=e.name;return"network-info"!==n&&"join-server"!==n&&"make-server"!==n&&"about"!==n?t._broadcast("user_input",e):void 0})}},{key:"broadcastSocketData",value:function(e,t){var n=this;return e.onAny(function(e,r){return"data"===e&&(r=new Uint8Array(r)),n._broadcast("socket_data",t,e,r)})}},{key:"_broadcast",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o;return"string"==typeof e?(r=[t].concat(ae.toConsumableArray(r)),t=e,o=void 0):o=e,this.devices.filter(function(e){return!e.equals(o)}).map(function(e){return e.send(t,r)})}},{key:"disconnectDevices",value:function(){return this.devices.forEach(function(e){return e.close()}),this.becomeIdle()}},{key:"waitForPort",value:function(e){return"found_port"===this.getState()?e(!0):"no_port"===this.getState()||"no_addr"===this.getState()?e(!1):(null!=this._thisDevice&&this._thisDevice.once("found_port",function(){return e(!0)}),null!=this._thisDevice&&this._thisDevice.once("no_port",function(){return e(!1)}),this.once("no_addr",function(){return e(!1)}))}},{key:"becomeServer",value:function(){return this.isClient()&&this.disconnectDevices(),this._type="server",this._state="device_state"}},{key:"becomeIdle",value:function(){return this._type="idle",this._state="device_state"}},{key:"_becomeClient",value:function(){return this._log("this device is now a client of",this.serverDevice.toString()),this._type="client",this._state="connected",this._addDevice(this.serverDevice)}},{key:"disconnectFromServer",value:function(){var e;return null!=(e=this.serverDevice)?e.close():void 0}},{key:"connectToServer",value:function(e){var t,n,r=this;return this._connectingTo&&(n=this._connectingTo,this._connectingTo=void 0,n.close()),this._state="connecting",t=new lt(e.addr,e.port),this._connectingTo=t,this._listenToDevice(t),t.connect(function(e){return e?r._onConnectedToServer(t):r._onFailedToConnectToServer(t)})}},{key:"_onConnectedToServer",value:function(e){var t=this;return this._log("connected to server",e.toString()),e.on("authentication_offer",function(e,n){return e.password=n,t.emit("server_found",e)})}},{key:"_onFailedToConnectToServer",value:function(e){return this._state="device_state",this.emit("invalid_server",e)}},{key:"finalizeConnection",value:function(){return this._connectingTo?(this._state="connecting",this._connectingTo.send("authenticate",[this._getAuthToken(this._connectingTo.password)])):void 0}},{key:"isServer",value:function(){return"server"===this._type}},{key:"isClient",value:function(){return"client"===this._type}},{key:"isIdle",value:function(){return"idle"===this._type}},{key:"isInitializing",value:function(){return void 0===this._type}}]),t}(fe),mt=function(){function e(){ae.classCallCheck(this,e)}return ae.createClass(e,[{key:"start",value:function(e){return this._events[e]={startTime:this._getCurrentTime()}}},{key:"finish",value:function(e){var t=this.elapsed(e);return delete this._events[e],t}},{key:"elapsed",value:function(e){return this._events[e]?this._getCurrentTime()-this._events[e].startTime:0}},{key:"_getCurrentTime",value:function(){return(new Date).getTime()}}]),e}();mt.prototype._events={};var yt=function(){function e(t){ae.classCallCheck(this,e),this._useOwnConnectionWhileWaitingForServer=this._useOwnConnectionWhileWaitingForServer.bind(this),this._reconnect=this._reconnect.bind(this),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this),this._tearDown=this._tearDown.bind(this),this._log=u(this),this._timer=new mt,this._chat=t,this._addConnectionChangeListeners(),t.on("tear_down",this._tearDown),m()||this._chat.notice.prompt("No internet connection found. You will be unable to connect to IRC.")}return ae.createClass(e,[{key:"_tearDown",value:function(){return this._removeConnectionChangeListeners()}},{key:"_addConnectionChangeListeners",value:function(){return $(window).on("online",this._onOnline),$(window).on("offline",this._onOffline)}},{key:"_removeConnectionChangeListeners",value:function(){return $(window).off("online",this._onOnline),$(window).off("offline",this._onOffline)}},{key:"setStorageHandler",value:function(e){var t=this;return this._storage=e,this._remoteConnection.setIRCStateFetcher(function(){return t._storage.getState()}),this._remoteConnection.setChatLogFetcher(function(){return t._chat.messageHandler.getChatLog()})}},{key:"setRemoteConnection",value:function(e){return this._remoteConnection=e,this._listenToRemoteConnectionEvents()}},{key:"_onOnline",value:function(){return this._chat.notice.close(),this._timer.start("started_connection"),this.determineConnection()}},{key:"_onOffline",value:function(){return this._chat.notice.prompt("You lost connection to the internet. You will be unable to connect to IRC."),this._chat.remoteConnection.disconnectDevices()}},{key:"_listenToRemoteConnectionEvents",value:function(){var t=this;return this._chat.userCommands.listenTo(this._remoteConnection),this._remoteConnection.on("found_addr",function(){return t.determineConnection()}),this._remoteConnection.on("no_addr",function(){return t.useOwnConnection()}),this._remoteConnection.on("no_port",function(){return t.useOwnConnection()}),this._remoteConnection.on("server_found",function(){var n;return t._chat.notice.close(),n=t._timer.elapsed("started_connection")>e.NOTIFY_BEFORE_CONNECTING,n?t._notifyConnectionAvailable():t._remoteConnection.finalizeConnection()}),this._remoteConnection.on("invalid_server",function(e){return t._chat.remoteConnection.isInitializing()?t._onConnected=function(){return t._displayFailedToConnect(e)}:t._reconnectionAttempt||t._displayFailedToConnect(e),t._reconnectionAttempt=!1,t.useOwnConnection(),t._tryToReconnectToServerDevice()}),this._remoteConnection.on("irc_state",function(e){return t._timer.start("started_connection"),t._reconnectionAttempt=!1,t._storage.pause(),t._chat.closeAllConnections(),t._stopServerReconnectAttempts(),t._storage.loadState(e)}),this._remoteConnection.on("chat_log",function(e){var n;return t._chat.messageHandler.replayChatLog(e),(n=t._remoteConnection.serverDevice)?t._chat.displayMessage("notice",t._chat.getCurrentContext(),"Connected through server device "+n.toString()):void 0}),this._remoteConnection.on("server_disconnected",function(){return t._timer.start("started_connection"),t.manuallyDisconnected||(t._onConnected=function(){return t._displayLostConnectionMessage()}),t.determineConnection()}),this._remoteConnection.on("client_joined",function(e){return t._chat.displayMessage("notice",t._chat.getCurrentContext(),e.addr+" connected to this device"),t._chat.updateStatus()}),this._remoteConnection.on("client_parted",function(e){return t._chat.displayMessage("notice",t._chat.getCurrentContext(),e.addr+" disconnected from this device"),t._chat.updateStatus()})}},{key:"isManuallyConnecting",value:function(){return this._timer.start("started_connection")}},{key:"_notifyConnectionAvailable",value:function(){var e=this,t="Device discovered. Would you like to connect and use its IRC connection? [connect]";return this._chat.notice.prompt(t,function(){return e._reconnectionAttempt=!1,e._chat.remoteConnection.finalizeConnection()})}},{key:"_displayFailedToConnect",value:function(e){return e?this._chat.displayMessage("notice",this._chat.getCurrentContext(),"Unable to connect to server device "+e.addr+" on port "+e.port):void 0}},{key:"_displayLostConnectionMessage",value:function(){return this._chat.displayMessage("notice",this._chat.getCurrentContext(),"Lost connection to server device. Attempting to reconnect...")}},{key:"determineConnection",value:function(){return m()&&(this._log("determining connection...",this._remoteConnection.getConnectionInfo().addr,this._storage.loadedServerDevice,this._storage.password),this._remoteConnection.getConnectionInfo().addr&&this._storage.loadedServerDevice&&this._storage.password)?(this._log("can make a connection - device:",this._storage.serverDevice,"- is server?",this.shouldBeServerDevice()),this._storage.serverDevice&&!this.shouldBeServerDevice()?this._useServerDeviceConnection():this.useOwnConnection()):void 0}},{key:"_useServerDeviceConnection",value:function(){return clearTimeout(this._useOwnConnectionTimeout),this._alreadyConnectedToServerDevice()?void 0:(this._log("automatically connecting to",this._storage.serverDevice),this._remoteConnection.isInitializing()&&this._useOwnConnectionIfServerTakesTooLong(),this._remoteConnection.connectToServer(this._storage.serverDevice))}},{key:"_alreadyConnectedToServerDevice",value:function(){var e=this._remoteConnection.serverDevice,t=this._remoteConnection.getState(),n="connected"===t||"connecting"===t,r=null!=e?e.usesConnection(this._storage.serverDevice):void 0;return n&&r}},{key:"_useOwnConnectionIfServerTakesTooLong",value:function(){var t=this;return this._useOwnConnectionTimeout=setTimeout(function(){return t._useOwnConnectionWhileWaitingForServer()},e.SERVER_DEVICE_CONNECTION_WAIT)}},{key:"_tryToReconnectToServerDevice",value:function(){var t=this;return clearTimeout(this._serverDeviceReconnectTimeout),null==this._serverDeviceReconnectBackoff&&(this._serverDeviceReconnectBackoff=e.SERVER_DEVICE_RECONNECTION_WAIT),this._serverDeviceReconnectTimeout=setTimeout(function(){return t._reconnect()},this._serverDeviceReconnectBackoff)}},{key:"_reconnect",value:function(){var t=this._remoteConnection.getState();return this._reconnectionAttempt=!0,this._serverDeviceReconnectBackoff*=1.2,this._serverDeviceReconnectBackoff>e.SERVER_DEVICE_RECONNECTION_MAX_WAIT&&(this._serverDeviceReconnectBackoff=e.SERVER_DEVICE_RECONNECTION_MAX_WAIT),"connecting"!==t&&"connected"!==t?this.determineConnection():void 0}},{key:"_stopServerReconnectAttempts",value:function(){return clearTimeout(this._serverDeviceReconnectTimeout),this._serverDeviceReconnectBackoff=e.SERVER_DEVICE_RECONNECTION_WAIT}},{key:"_useOwnConnectionWhileWaitingForServer",value:function(){var e,t=this;return this._remoteConnection.isInitializing()?(this._remoteConnection.becomeIdle(),e=this._storage.serverDevice,this._onConnected=function(){return t._displayFailedToConnect(e)},this._resumeIRCConnection()):void 0}},{key:"useOwnConnection",value:function(){var e,t;return clearTimeout(this._useOwnConnectionTimeout),(t="connected"===this._remoteConnection.getState())?(this.manuallyDisconnected=!0,this._remoteConnection.disconnectFromServer(),void(this.manuallyDisconnected=!1)):this.shouldBeServerDevice()?(this._chat.notice.close(),this._stopServerReconnectAttempts(),void this._tryToBecomeServerDevice()):(e=this._notUsingOwnIRCConnection(),this._remoteConnection.isIdle()?void 0:(this._stopBeingServerDevice(),e?this._resumeIRCConnection():void 0))}},{key:"_tryToBecomeServerDevice",value:function(){var e,t=this;if(e=this._notUsingOwnIRCConnection(),"finding_port"===this._remoteConnection.getState())return this._remoteConnection.waitForPort(function(){return t.determineConnection()}),void this._log("should be server, but havent found port yet...");if("no_port"===this._remoteConnection.getState())this._remoteConnection.isServer()&&this._stopBeingServerDevice();else{if(this._remoteConnection.isServer()&&this._storage.serverDevice.port===this._remoteConnection.getConnectionInfo().port)return;this._becomeServerDevice()}return e?this._resumeIRCConnection():void 0}},{key:"_notUsingOwnIRCConnection",value:function(){return this._remoteConnection.isInitializing()||this._remoteConnection.isClient()}},{key:"_stopBeingServerDevice",value:function(){return this._remoteConnection.isServer()?(this._log("stopped being a server device"),this._remoteConnection.disconnectDevices()):this._remoteConnection.becomeIdle()}},{key:"shouldBeServerDevice",value:function(){var e,t;return e=null!=(t=this._storage.serverDevice)?t.addr:void 0,this._remoteConnection.getConnectionInfo().possibleAddrs.indexOf(e)>=0}},{key:"_becomeServerDevice",value:function(){return this._log("becoming server device"),this._remoteConnection.isInitializing()||this._chat.displayMessage("notice",this._chat.getCurrentContext(),"Now accepting connections from other devices"),this._remoteConnection.becomeServer(),this._storage.becomeServerDevice(this._remoteConnection.getConnectionInfo())}},{key:"_resumeIRCConnection",value:function(){var e=this;return this._timer.start("started_connection"),this._log("resuming IRC conn"),this._chat.closeAllConnections(),this._storage.restoreSavedState(function(){return e._onUsingOwnConnection()})}},{key:"_onUsingOwnConnection",value:function(){return this._selectFirstRoom(),this._chat.messageHandler.replayChatLog(),this._storage.resume(),"function"==typeof this._onConnected&&this._onConnected(),this._onConnected=void 0,this._storage.completedWalkthrough?void 0:this._chat.startWalkthrough()}},{key:"_selectFirstRoom",value:function(){return this._chat.winList.length>1?this._chat.switchToWindow(this._chat.winList.get(0)):void 0}}]),e}();yt.SERVER_DEVICE_CONNECTION_WAIT=650,yt.NOTIFY_BEFORE_CONNECTING=1500,yt.SERVER_DEVICE_RECONNECTION_WAIT=500,yt.SERVER_DEVICE_RECONNECTION_MAX_WAIT=5e3;var _t=function(e){function t(){ae.classCallCheck(this,t);var e=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));e.onMessageEvent=e.onMessageEvent.bind(e),e.onServerEvent=e.onServerEvent.bind(e),e.onIRCEvent=e.onIRCEvent.bind(e);var n=new ge(e);return e.connections={},e.messageHandler=new Me(e),e.userCommands=new Ye(e),e.userCommands.merge(n),e._initializeUI(),e._initializeRemoteConnection(),e._initializeStorage(),e._initializeScripts(),e._listenForUpdates(),e._keyboardShortcutMap=new ht,e.updateStatus(),window.webkitRequestFileSystem(PERSISTENT,51200,function(e){e.root.getFile("custom_style.css",{create:!1},function(e){return $("#main-style").attr("href",e.toURL())})}),e}return ae.inherits(t,e),ae.createClass(t,[{key:"init",value:function(){return j()?(this.storage.init(),this.remoteConnection.init()):this._displaySocketSupportError()}},{key:"getKeyboardShortcuts",value:function(){return this._keyboardShortcutMap}},{key:"_displaySocketSupportError",value:function(){var e="CIRC cannot run on this device. Support for chrome.sockets is required to connect to the IRC server. Please update your version of Chrome and try again.";return this.displayMessage("error",this.getCurrentContext(),e)}},{key:"tearDown",value:function(){return this.emit("tear_down")}},{key:"_initializeUI",value:function(){var e=this;this.winList=new Je,this.notice=new Xe,this.toggleChannelDisplay=$("#hide-channels"),this.toggleChannelDisplay.click(function(){$("#rooms-and-nicks")[0].classList.toggle("hidden")}),this.channelDisplay=new Ze,this.channelDisplay.on("clicked",function(t,n){var r=e.winList.get(t,n);return null!=r?e.switchToWindow(r):void 0}),this.channelDisplay.on("midclicked",function(t,n){e.disconnectAndRemoveRoom(t,n)}),this.channelDisplay.on("remove_button_clicked",function(t,n){e.disconnectAndRemoveRoom(t,n)}),this.channelDisplay.on("help_type_command",function(t){e.emit("set_input",t),e.emit("blink_input")}),this._addWelcomeWindow()}},{key:"_addWelcomeWindow",value:function(){return this.emptyWindow=new ot("none"),this.channelDisplay.addAlwaysEmptyServer(this.emptyWindow.name),this.switchToWindow(this.emptyWindow),this.emptyWindow.messageRenderer.displayWelcome()}},{key:"_initializeRemoteConnection",value:function(){return this.remoteConnection=new vt,this.remoteConnectionHandler=new yt(this),this.remoteConnectionHandler.setRemoteConnection(this.remoteConnection)}},{key:"_initializeStorage",value:function(){return this.storage=new at(this),this.remoteConnectionHandler.setStorageHandler(this.storage)}},{key:"_initializeScripts",value:function(){var e=this;return this.storage.on("initialized",function(){return e.storage.loadedPrepackagedScripts?void 0:(Ge.loadPrepackagedScripts(function(t){return e.addScript(t)}),e.storage.finishedLoadingPrepackagedScripts())})}},{key:"addScript",value:function(e){return this.scriptHandler.addScript(e),this.storage.scriptAdded(e)}},{key:"_listenForUpdates",value:function(){var e,t=this;return null!==chrome.runtime.reload&&null!=(e=chrome.runtime.onUpdateAvailable)?e.addListener(function(){return t._promptToUpdate()}):void 0}},{key:"_promptToUpdate",value:function(){var e="A new version of CIRC is available. Would you like to restart and update? [update]";return this.notice.prompt(e,function(){return chrome.runtime.reload()})}},{key:"startWalkthrough",value:function(){var e=this,t=new st(this,this.storage);return t.listenToIRCEvents(this._ircEvents),t.on("tear_down",function(){return e.storage.finishedWalkthrough()})}},{key:"setPassword",value:function(e){return this.remoteConnection.setPassword(e)}},{key:"closeAllConnections",value:function(){var e=this;return clearTimeout(this._useOwnConnectionTimeout),me(this.connections).values().each(function(t){return e.closeConnection(t)})}},{key:"closeConnection",value:function(e,t){return"reconnecting"===e.irc.state?e.irc.giveup():e.irc.quit(t),this.removeWindow(this.winList.get(e.name))}},{key:"listenToCommands",value:function(e){return this.remoteConnection.broadcastUserInput(e),this.userCommands.listenTo(e)}},{key:"listenToScriptEvents",value:function(e){var t=this;return this.scriptHandler=e,e.on("save",function(e,n){return t.storage.saveItemForScript(e,n)}),e.on("load",function(e,n){return t.storage.loadItemForScript(e,n)})}},{key:"listenToIRCEvents",value:function(e){return this._ircEvents=e,this._ircEvents.on("server",this.onIRCEvent),this._ircEvents.on("message",this.onIRCEvent)}},{key:"connect",value:function(e,t,n){var r;if(e in this.connections){if(r=this.connections[e].irc.state,"connected"===r.state||"connecting"===r.state)return}else this._createConnection(e,t),this._createWindowForServer(e,t,n);return this.connections[e].irc.connect(e,t,n)}},{key:"_createConnection",value:function(e,t){var n=new He(this.remoteConnection.createSocket(e,t));return this.preferredNick&&n.setPreferredNick(this.preferredNick),null!=this._ircEvents&&this._ircEvents.addEventsFrom(n),this.connections[e]={irc:n,name:e,windows:{}}}},{key:"_createWindowForServer",value:function(e,t,n){var r=this.connections[e],i=this._makeWin(r);return this._replaceEmptyWindowIfExists(i),i.message("","Connecting to "+r.name+"..."),this.channelDisplay.addServer(r.name),this.storage.serverJoined(r.name,t,n),this.switchToWindow(i)}},{key:"_replaceEmptyWindowIfExists",value:function(e){return this.currentWindow.equals(this.emptyWindow)?(this.channelDisplay.remove(this.emptyWindow.name),e.messageRenderer.displayWelcome()):void 0}},{key:"join",value:function(e,t,n){var r;return e.irc.isValidChannelPrefix(t)||(t="#"+t),r=this._createWindowForChannel(e,t),this.switchToWindow(r),this.storage.channelJoined(e.name,t,null,n),e.irc.join(t,n)}},{key:"setNick",value:function(e,t){var n;return t?n=e:(t=e,n=void 0),this._setNickLocally(t),this._tellServerNickChanged(t,n),this._emitNickChangedEvent(t)}},{key:"_setNickLocally",value:function(e){return this.preferredNick=e,this.storage.nickChanged(e),this.updateStatus()}},{key:"_tellServerNickChanged",value:function(e,t){var n=this.connections[t];return null!=n&&n.irc.doCommand("NICK",e),null!=n?n.irc.setPreferredNick(e):void 0}},{key:"_emitNickChangedEvent",value:function(e){var t;return t=new We("server","nick",e),t.setContext(this.getCurrentContext()),this.emit(t.type,t)}},{key:"onIRCEvent",value:function(e){var t=this.connections[e.context.server];return"server"===e.type?this.onServerEvent(t,e):this.onMessageEvent(t,e)}},{key:"onServerEvent",value:function(e,t){if(e)switch(t.name){case"connect":return this.onConnected(e);case"disconnect":return this.onDisconnected(e);case"joined":return this.onJoined.apply(this,[e,t.context.channel].concat(ae.toConsumableArray(t.args)));case"names":return this.onNames.apply(this,[t].concat(ae.toConsumableArray(t.args)));case"parted":return this.onParted(t);case"nick":return this.updateStatus()}}},{key:"onMessageEvent",value:function(e,n){var r,i=this.determineWindow(n);return i!==t.NO_WINDOW?(this.messageHandler.setWindow(i),this.messageHandler.setCustomMessageStyle(n.style),(r=this.messageHandler).handle.apply(r,[n.name].concat(ae.toConsumableArray(n.args)))):void 0}},{key:"determineWindow",value:function(e){var n,r=this.connections[e.context.server];if(!r)return this.emptyWindow;if(e.context.channel===t.CURRENT_WINDOW&&e.context.server!==a(this.currentWindow,["conn","name"])&&(e.context.channel=t.SERVER_WINDOW),n=e.context.channel,this._isDirectMessageToUser(r,n,e.name)){var i=a(e,["args",0]);return this.createPrivateMessageWindow(r,i)}return n&&n!==t.SERVER_WINDOW?n===t.CURRENT_WINDOW?this.currentWindow:r.windows[n.toLowerCase()]?r.windows[n.toLowerCase()]:t.NO_WINDOW:r.serverWindow}},{key:"_isDirectMessageToUser",value:function(e,t,n){return(null!=e?e.irc.isOwnNick(t):void 0)&&"privmsg"===n}},{key:"createPrivateMessageWindow",value:function(e,t){var n,r=t.toLowerCase();return e.windows[r]?e.windows[r]:(this.storage.channelJoined(e.name,t,"private"),n=e.windows[r]=this._createWindowForChannel(e,t),n.makePrivate(),n.message("","You're in a private conversation with "+t+".","notice"),this.channelDisplay.connect(e.name,t),n)}},{key:"recordLastUserToMention",value:function(e,t){return null==this._lastUsersToMention&&(this._lastUsersToMention={}),this._lastUsersToMention[e]=t}},{key:"getLastUserToMention",value:function(e){return a(this,["_lastUsersToMention",e])}},{key:"onConnected",value:function(e){var t=this;return this.displayMessage("connect",{server:e.name}),this.updateStatus(),this.channelDisplay.connect(e.name),me(e.windows).pairs().each(function(n){var r=ae.slicedToArray(n,2),i=r[0],o=r[1];return t.displayMessage("connect",{server:e.name,channel:o.target}),o.isPrivate()?t.channelDisplay.connect(e.name,i):void 0})}},{key:"onDisconnected",value:function(e){var t=this;return this.displayMessage("disconnect",{server:e.name}),this.channelDisplay.disconnect(e.name),me(e.windows).pairs().each(function(n){var r=ae.slicedToArray(n,2),i=r[0],o=r[1];return t.channelDisplay.disconnect(e.name,i),t.displayMessage("disconnect",{server:e.name,channel:o.target})})}},{key:"onJoined",value:function(e,t){var n=this._createWindowForChannel(e,t);return this.channelDisplay.connect(e.name,t),n.nicks.clear()}},{key:"_createWindowForChannel",value:function(e,t){var n=e.windows[t.toLowerCase()];return n||(n=this._makeWin(e,t),this.channelDisplay.insertChannel(this.winList.localIndexOf(n),e.name,t)),n}},{key:"onNames",value:function(e,n){var r=this.determineWindow(e);if(r!==t.NO_WINDOW)return n.map(function(e){return r.nicks.add(e)})}},{key:"onParted",value:function(e){var n=this.determineWindow(e);if(n!==t.NO_WINDOW)return this.channelDisplay.disconnect(n.conn.name,n.target)}},{key:"disconnectAndRemoveRoom",value:function(e,t,n){var r=this.winList.get(e,t);r&&(t?(r.isPrivate()||r.conn.irc.part(t,n),this.removeWindow(r)):this.closeConnection(r.conn,n))}},{key:"removeWindow",value:function(e){var t,n,r=this;return null==e&&(e=this.currentWindow),t=this.winList.indexOf(e),e.isServerWindow()&&null!=this._ircEvents&&this._ircEvents.removeEventsFrom(e.conn.irc),n=this.winList.remove(e),n.forEach(function(e){return r._removeWindowFromState(e)}),this._selectNextWindow(t)}},{key:"_removeWindowFromState",value:function(e){return this.channelDisplay.remove(e.conn.name,e.target),this.storage.parted(e.conn.name,e.target),e.notifications.clear(),null!=e.target?delete this.connections[e.conn.name].windows[e.target]:delete this.connections[e.conn.name],e.remove()}},{key:"_selectNextWindow",value:function(e){if(0===this.winList.length)return this.channelDisplay.addAlwaysEmptyServer(this.emptyWindow.name),this.switchToWindow(this.emptyWindow);if(-1===this.winList.indexOf(this.currentWindow)){var t=this.winList.get(e),n=null!=t?t:this.winList.get(e-1);return this.switchToWindow(n)}return this.switchToWindow(this.currentWindow)}},{key:"_makeWin",value:function(e,t){var n=this,r=a(e.irc,["channels",t,"channel"])||t,i=new ot(e.name,r);if(i.conn=e,t){var o=t.toLowerCase();e.windows[o]=i,i.setTarget(o),i.nicks.on("dblclicked",function(e){return n.switchToWindow(n.createPrivateMessageWindow(i.conn,e))})}else e.serverWindow=i;return this.winList.add(i),this.messageHandler.logMessagesFromWindow(i),i}},{key:"updateStatus",value:function(){var e,t,n=this.currentWindow.conn,r=this.preferredNick;if(n){var i=this.currentWindow.target,o=i?this.currentWindow.conn.irc.channels[i]:void 0;r=this.currentWindow.conn.irc.nick||this.preferredNick,e=this.currentWindow.conn.irc.away,o&&(t=o.topic)}return $("#nick").html((r?'<span class="name">'+he.escape(r)+"</span>":"")+(e?'<span class="away">away</span>':"")),$("#status").html(t?'<span title="'+he.escape(t)+'" class="topic">'+he.display(t)+"</span>":""),this._updateDocumentTitle()}},{key:"_updateDocumentTitle",value:function(){var e,t=this.remoteConnection,n=[];return n.push("CIRC "+Re),t&&(t.isClient()?n.push("- Connected through "+this.remoteConnection.serverDevice.addr):this.remoteConnection.isServer()&&(e=this.remoteConnection.devices.length,n.push("- Server for "+e+" other "+l("device",e)))),document.title=n.join(" ")}},{key:"switchToChannelByIndex",value:function(e){var t=this.winList.getChannelWindow(e);return null!=t?this.switchToWindow(t):void 0}},{key:"switchToWindow",value:function(e){if(null==e)throw new Error("switching to non-existant window");return this.currentWindow&&this.currentWindow.detach(),this.currentWindow=e,e.attach(),this._focusInput(),this._selectWindowInChannelDisplay(e),this.updateStatus()}},{key:"_focusInput",value:function(){var e=$("#input");e&&setTimeout(function(){return e.focus()},0)}},{key:"_selectWindowInChannelDisplay",value:function(e){return e.conn?this.channelDisplay.select(e.conn.name,e.target):this.channelDisplay.select(e.name)}},{key:"displayMessage",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;n>i;i++)r[i-2]=arguments[i];var o=new(Function.prototype.bind.apply(We,[null].concat(["message",e],r)));return o.setContext(t.server,t.channel),this.emit(o.type,o)}},{key:"getCurrentContext",value:function(){return new Te(a(this.currentWindow.conn,["name"]),t.CURRENT_WINDOW)}}]),t}(fe);_t.SERVER_WINDOW="@server_window",_t.CURRENT_WINDOW="@current_window",_t.NO_WINDOW="NO_WINDOW";var gt=function(){function e(){ae.classCallCheck(this,e),this._previousInputs=[""],this._previousInputIndex=0}return ae.createClass(e,[{key:"setCurrentText",value:function(e){return 0===this._previousInputIndex?this._previousInputs[0]=e:void 0}},{key:"showPreviousInput",value:function(){return this._previousInputIndex>=this._previousInputs.length-1?void 0:(this._previousInputIndex++,this._previousInputs[this._previousInputIndex])}},{key:"showNextInput",value:function(){return this._previousInputIndex<=0?void 0:(this._previousInputIndex--,this._previousInputs[this._previousInputIndex])}},{key:"reset",value:function(){return this._previousInputIndex=0}},{key:"addInput",value:function(e){return this._previousInputs.splice(1,0,e)}}]),e}(),kt=function(){function e(t){ae.classCallCheck(this,e),this._emptyCompletions=function(){return me([])},this._completions=this._emptyCompletions(),
this._getCompletions=t,this.reset()}return ae.createClass(e,[{key:"setCompletionGenerator",value:function(e){return this._getCompletions=e}},{key:"clearCompletions",value:function(){return this._completions=this._emptyCompletions()}},{key:"addCompletions",value:function(e){return this._completions=this._completions.concat(e)}},{key:"setCompletions",value:function(e){return this.clearCompletions(),this.addCompletions(e)}},{key:"getCompletion",value:function(e){return this.hasStarted||(this._generateCompletions(),this._currentStub=e,this._findCompletions(),this.hasStarted=!0),this._getNextCompletion()}},{key:"_generateCompletions",value:function(){return null!=this._getCompletions?this.setCompletions(this._getCompletions()):void 0}},{key:"_findCompletions",value:function(){var e=this,t=!/[A-Z]/.test(this._currentStub);return this._currentCompletions=this._completions.filter(function(n){var r=t?n.toString().toLowerCase():n.toString();return 0===r.indexOf(e._currentStub)})}},{key:"_getNextCompletion",value:function(){if(this._currentCompletions.isEmpty())return e.NONE;var t=this._currentCompletions.get(this._completionIndex);return this._completionIndex++,this._completionIndex>=this._currentCompletions.size()&&(this._completionIndex=0),t}},{key:"reset",value:function(){return this._currentCompletions=null,this._completionIndex=0,this.currentStub="",this.hasStarted=!1}}]),e}();kt.NONE=void 0;var Ct=function(){function e(t,n){ae.classCallCheck(this,e),this._text=t,this._type=n,this._type===e.CMD&&(this._text="/"+this._text)}return ae.createClass(e,[{key:"getText",value:function(){return this._text}},{key:"getType",value:function(){return this._type}},{key:"getSuffix",value:function(t){return this._type===e.NICK&&0===t?e.COMPLETION_SUFFIX+" ":" "}},{key:"toString",value:function(){return this.getText()}}]),e}();Ct.CMD=0,Ct.NICK=1,Ct.COMPLETION_SUFFIX=":";var wt=function(){function e(){ae.classCallCheck(this,e),this._getPossibleCompletions=this._getPossibleCompletions.bind(this),this._completionFinder=new kt}return ae.createClass(e,[{key:"setContext",value:function(e){return this._context=e,this._completionFinder.setCompletionGenerator(this._getPossibleCompletions)}},{key:"_getPossibleCompletions",value:function(){return this._getCommandCompletions().concat(this._getNickCompletions())}},{key:"_getCommandCompletions",value:function(){return me(this._context.userCommands.getCommands()).values().filter(function(e){return"hidden"!==e.category}).sort().map(function(e){return new Ct(e,Ct.CMD)})}},{key:"_getNickCompletions",value:function(){var e=this._context.currentWindow.conn.irc,t=this._context.currentWindow.target,n=a(e,["channels",t,"names"]);return null!=n?me(n).values().map(function(e){return new Ct(e,Ct.NICK)}):[]}},{key:"getTextWithCompletion",value:function(e,t){var n=void 0,r=void 0;return this._text=e,this._cursor=t,this._previousText!==this._text&&this._completionFinder.reset(),this._previousCursor=this._cursor,this._completionFinder.hasStarted||this._extractStub(),n=this._getCompletion(),r=this._preCompletion+n+this._postCompletion,this._updatedCursorPosition=this._preCompletion.length+n.length,this._previousText=r,r}},{key:"getUpdatedCursorPosition",value:function(){return this._updatedCursorPosition||0}},{key:"_getCompletion",value:function(){var e=this._completionFinder.getCompletion(this._stub);return e===kt.NONE?this._stub:e.getText()+e.getSuffix(this._preCompletion.length)}},{key:"_extractStub",value:function(){var e,t=this._findNearest(this._cursor-1,/\S/);return 0>t&&(t=0),e=this._findNearest(t,/\s/),this._preCompletion=this._text.slice(0,e+1),this._stub=this._text.slice(e+1,+t+1||9e9),this._postCompletion=this._text.slice(t+1)}},{key:"_findNearest",value:function(e,t){var n,r;for(n=r=e;0>=e?0>=r:r>=0;n=0>=e?++r:--r)if(t.test(this._text[n]))return n;return-1}}]),e}();wt.COMPLETION_SUFFIX=":";var St=function(e){function t(e,n){ae.classCallCheck(this,t);var r=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return r.input=e,r.window=n,r._sendUserCommand=r._sendUserCommand.bind(r),r._handleKeydown=r._handleKeydown.bind(r),r._handleGlobalKeydown=r._handleGlobalKeydown.bind(r),r.input.focus(),r._inputStack=new gt,r._autoComplete=new wt,r.input.keydown(r._handleKeydown),r.window.keydown(r._handleGlobalKeydown),r}return ae.inherits(t,e),ae.createClass(t,[{key:"setContext",value:function(e){var t=this;this._context=e,this._autoComplete.setContext(this._context),this._context.on("set_input_if_empty",function(e){t.input.val()||t.setInput(e)}),this._context.on("set_input",function(e){return t.setInput(e)}),this._context.on("blink_input",function(){t.input.css("-webkit-transition","0"),t.input.addClass("blink"),setTimeout(function(){t.input.css("-webkit-transition","300ms"),t.input.removeClass("blink")},0)})}},{key:"setInput",value:function(e){var t=this;this.input.val(e),setTimeout(function(){return t.input.focus()},0)}},{key:"setKeyboardShortcuts",value:function(e){return this._keyboardShortcutMap=e}},{key:"_handleGlobalKeydown",value:function(e){return this.text=this.input.val(),this._focusInputOnKeyPress(e),this._handleKeyboardShortcuts(e),e.isDefaultPrevented()?!1:(this._showPreviousCommandsOnArrowKeys(e),this._autoCompleteOnTab(e),!e.isDefaultPrevented())}},{key:"_focusInputOnKeyPress",value:function(e){return e.metaKey||e.ctrlKey?void 0:(e.currentTarget=this.input[0],this.input.focus())}},{key:"_handleKeyboardShortcuts",value:function(e){var t,n=this._keyboardShortcutMap.getMappedCommand(e,this.input.val()),r=ae.slicedToArray(n,2),i=r[0],o=r[1];return i?(e.preventDefault(),t=new(Function.prototype.bind.apply(We,[null].concat(["command",i],ae.toConsumableArray(o)))),this._emitEventToCurrentWindow(t)):void 0}},{key:"_showPreviousCommandsOnArrowKeys",value:function(e){if(e.which!==ut.toKeyCode("UP")&&e.which!==ut.toKeyCode("DOWN"))return this._inputStack.reset();var t=void 0;return e.preventDefault(),e.which===ut.toKeyCode("UP")?(this._inputStack.setCurrentText(this.text),t=this._inputStack.showPreviousInput()):t=this._inputStack.showNextInput(),null!=t?this.input.val(t):void 0}},{key:"_autoCompleteOnTab",value:function(e){if(e.which===ut.toKeyCode("TAB")&&(e.preventDefault(),this.text)){var t=this._autoComplete.getTextWithCompletion(this.text,this._getCursorPosition());return this.input.val(t),this._setCursorPosition(this._autoComplete.getUpdatedCursorPosition())}}},{key:"_setCursorPosition",value:function(e){return this.input[0].setSelectionRange(e,e)}},{key:"_getCursorPosition",value:function(){return this.input[0].selectionStart}},{key:"_handleKeydown",value:function(e){return this.text=this.input.val(),e.which===ut.toKeyCode("ENTER")&&this.text.length>0&&(this.input.val(""),this._sendUserCommand()),!0}},{key:"_sendUserCommand",value:function(){var e,t,n;return this._inputStack.addInput(this.text),n=this.text.split(/\s/),"/"===this.text[0]?(t=n[0].slice(1).toLowerCase(),n=n.slice(1)):t="say",e=new(Function.prototype.bind.apply(We,[null].concat(["command",t],ae.toConsumableArray(n)))),this._emitEventToCurrentWindow(e)}},{key:"_emitEventToCurrentWindow",value:function(e){return e.context=this._context.currentWindow.getContext(),this.emit(e.type,e)}}]),t}(fe),It=function(e){function t(){ae.classCallCheck(this,t);var e=ae.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e._handleMessage=e._handleMessage.bind(e),e._handleEvent=e._handleEvent.bind(e),e._scripts={},e._pendingEvents=Object.create(null),e._eventCount=0,e._emitters=[],e._propagationTimeoutTimerId=null,e._log=u(e),addEventListener("message",e._handleMessage),e}return ae.inherits(t,e),ae.createClass(t,[{key:"listenToScriptEvents",value:function(e){return e.on("script_loaded",this.addScript)}},{key:"addScript",value:function(e){return this._scripts[e.id]=e}},{key:"removeScript",value:function(e){var t=this;return this._getPendingEventsForScript(e).each(function(n){return t._stopHandlingEvent(e,n)}),delete this._scripts[e.id]}},{key:"_getPendingEventsForScript",value:function(e){return me(this._pendingEvents).values().filter(function(t){return!t.scripts.some(function(t){return t.id===e.id})}).map(function(e){var t=e.id;return t})}},{key:"on",value:function(e,n){return t.HOOKABLE_EVENTS.indexOf(e)>=0||t.SCRIPTING_EVENTS.indexOf(e)>=0?ae.get(Object.getPrototypeOf(t.prototype),"on",this).call(this,e,n):this._forwardEvent(e,n)}},{key:"_forwardEvent",value:function(e,t){return this._emitters.map(function(n){return n.on(e,t)})}},{key:"addEventsFrom",value:function(e){var n=this;return this._emitters.push(e),t.HOOKABLE_EVENTS.map(function(t){return e.on(t,n._handleEvent)})}},{key:"removeEventsFrom",value:function(e){var n=this;return this._emitters.splice(this._emitters.indexOf(e),1),t.HOOKABLE_EVENTS.map(function(t){return e.removeListener(t,n._handleEvent)})}},{key:"_handleEvent",value:function(e){return e.id=this._eventCount++,this._eventCanBeForwarded(e)&&this._offerEventToScripts(e),this._eventIsBeingHandled(e.id)?void 0:this._emitEvent(e)}},{key:"_eventCanBeForwarded",value:function(e){return!(e.hook in t.UNINTERCEPTABLE_EVENTS)}},{key:"_offerEventToScripts",value:function(e){var t=this;return me(this._scripts).values().filter(function(t){return t.shouldHandle(e)}).each(function(n){return t._sendEventToScript(e,n)})}},{key:"_sendEventToScript",value:function(e,n){n.postMessage(e),this._markEventAsPending(e,n),this._propagationTimeoutTimerId||(this._propagationTimeoutTimerId=setTimeout(this._checkPropagationTimeout.bind(this),t.PROPAGATION_TIMEOUT))}},{key:"_markEventAsPending",value:function(e,t){return this._pendingEvents[e.id]||(this._pendingEvents[e.id]={},this._pendingEvents[e.id].event=e,this._pendingEvents[e.id].scripts=[],this._pendingEvents[e.id].timestamp=Date.now()),this._pendingEvents[e.id].scripts.push(t)}},{key:"_checkPropagationTimeout",value:function(){var e=this;me(this._getUnresponsiveScripts()).values().each(function(t){e._log("e","Removing unresponsive script "+t.getName()),e.removeScript(t)}),this._propagationTimeoutTimerId=null,this._isPendingEventQueueEmpty()||(this._propagationTimeoutTimerId=setTimeout(this._checkPropagationTimeout.bind(this),this._getNextPendingEventTimeout()))}},{key:"_getUnresponsiveScripts",value:function(){var e=Date.now();return me(this._pendingEvents).values().filter(function(n){return n.timestamp+t.PROPAGATION_TIMEOUT<=e}).map(function(e){return e.scripts}).flatten().indexBy("id").toObject()}},{key:"_isPendingEventQueueEmpty",value:function(){for(var e in this._pendingEvents)return!1;return!0}},{key:"_getNextPendingEventTimeout",value:function(){var e=me(this._pendingEvents).values().reduce(function(e,t){return t.timestamp<e?t.timestamp:e},Number.MAX_VALUE),n=e+t.PROPAGATION_TIMEOUT-Date.now();return(n>t.PROPAGATION_TIMEOUT||0>=n)&&(n=t.PROPAGATION_TIMEOUT),n}},{key:"_eventIsBeingHandled",value:function(e){return e in this._pendingEvents?this._pendingEvents[e].scripts.length>0:!1}},{key:"_handleMessage",value:function(e){var t,n=e.data,r=Be.getScriptFromFrame(this._scripts,e.source);if(null!=r)switch(n.type){case"hook_command":case"hook_server":case"hook_message":return t=n.type.slice(5),r.beginHandlingType(t,n.name);case"command":case"sevrer":case"message":return this._emitEvent(We.wrap(n));case"propagate":return this._handleEventPropagation(r,n);case"meta":return this._handleMetaData(r,n);case"storage":return this._handleStorageRequest(r,n)}}},{key:"_handleEventPropagation",value:function(e,t){var n,r,i;if(n=null!=(i=t.args)?i[0]:void 0,this._eventIsBeingHandled(n)&&(r=this._pendingEvents[n].scripts,!(r.indexOf(e)<0)))switch(t.name){case"none":return delete this._pendingEvents[n];case"all":return this._stopHandlingEvent(e,n);default:return this._log("w","received unknown propagation type:",t.name)}}},{key:"_handleMetaData",value:function(e,t){var n,r;switch(t.name){case"name":if(n=t.args[0],!this._isValidName(n))return;return r=this._getUniqueName(n),e.setName(r)}}},{key:"_isValidName",value:function(e){return e&&/^[a-zA-Z0-9\/_-]+$/.test(e)}},{key:"_getUniqueName",value:function(e){var n,r;for(n=e=e.slice(0,+(t.MAX_NAME_LENGTH-1)+1||9e9),r=1;this.getScriptNames().indexOf(e)>=0;)r++,e=n+r;return e}},{key:"_handleStorageRequest",value:function(e,t){switch(t.name){case"save":return this.emit("save",e.getName(),t.args[0]);case"load":return this.emit("load",e.getName(),function(t){return e.postMessage(new We("system","loaded",t))})}}},{key:"storageChanged",value:function(e,t){return e.postMessage(new We("system","storage_changed",t))}},{key:"getScriptNames",value:function(){return me(this._scripts).values().map(function(e){return e.getName()})}},{key:"getScriptByName",value:function(e){return me(this._scripts).find(function(t){return t.getName()===e})}},{key:"_emitEvent",value:function(e){return this.emit(e.type,e)}},{key:"_stopHandlingEvent",value:function(e,t){var n=this._pendingEvents[t].scripts;if(y(n,e),!this._eventIsBeingHandled(t)){var r=this._pendingEvents[t].event;return delete this._pendingEvents[t],this._emitEvent(r)}}},{key:"tearDown",value:function(){return removeEventListener("message",this._handleEvent)}}]),t}(fe);It.MAX_NAME_LENGTH=20,It.PROPAGATION_TIMEOUT=5e3,It.UNINTERCEPTABLE_EVENTS={"command help":"command help","command about":"command about","command install":"command install","command uninstall":"command uninstall","command scripts":"command scripts"},It.HOOKABLE_EVENTS=["command","server","message"],It.SCRIPTING_EVENTS=["save","load"],function(){var e,t,n;n=new St($("#input"),$(window)),t=new It,e=new _t,n.setContext(e),n.setKeyboardShortcuts(e.getKeyboardShortcuts()),t.addEventsFrom(e),t.addEventsFrom(n),e.listenToCommands(t),e.listenToScriptEvents(t),e.listenToIRCEvents(t),e.init()}.call(this)}();
//# sourceMappingURL=main.js.map